<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 æ’­æ”¾å™¨ (åº•å±‚åŠ è½½æ‹¦æˆªç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f4f7f6; color: #333; }
        #app-container { max-width: 1000px; margin: 40px auto; padding: 20px; background: #fff; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 12px; }
        h1 { color: #d32f2f; text-align: center; } /* çº¢è‰²æ ‡é¢˜è¡¨ç¤ºå¼ºåŠ›æ¨¡å¼ */
        #control-panel { display: flex; gap: 15px; margin-bottom: 30px; align-items: center; }
        #m3u8-input { flex-grow: 1; padding: 12px 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #load-button { padding: 12px 25px; background: #d32f2f; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #load-button:hover { background: #b71c1c; }
        #video-container { width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        #video { width: 100%; height: 100%; }
        #status-message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; background: #ffebee; color: #c62828; }
        #debug-info { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); color: #0f0; padding: 5px; font-size: 12px; pointer-events: none; font-family: monospace; }
    </style>
</head>
<body>

<div id="app-container">
    <h1>M3U8 æ’­æ”¾å™¨ (åº•å±‚åŠ è½½æ‹¦æˆªç‰ˆ)</h1>
    <p style="text-align: center; color: #666;">é€šè¿‡è¦†ç›– pLoader åœ¨ç½‘ç»œå±‚ç›´æ¥æŠ¹é™¤å¹¿å‘Šä»£ç ã€‚</p>

    <div id="control-panel">
        <input type="url" id="m3u8-input" placeholder="åœ¨æ­¤è¾“å…¥ M3U8 åœ°å€" value="">
        <button id="load-button">ğŸš€ å¼ºåŠ›æ’­æ”¾</button>
    </div>
    
    <div id="status-message"></div>
    <div id="video-container">
        <video id="video" controls></video>
        <div id="debug-info">å‡†å¤‡å°±ç»ª</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    // å…¨å±€å˜é‡å­˜å‚¨ç›®æ ‡ç­¾åï¼Œä¾› Loader ä½¿ç”¨
    window.TARGET_SIGNATURE = '';
    window.ADS_REMOVED_COUNT = 0;

    // --- è‡ªå®šä¹‰åŠ è½½å™¨ç±» ---
    class CustomPlaylistLoader {
        constructor(config) {
            this.config = config;
        }

        load(context, config, callbacks) {
            const url = context.url;
            console.log(`[Loader] æ­£åœ¨è¯·æ±‚: ${url}`);

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    // åªæœ‰å½“æ˜¯ M3U8 æ’­æ”¾åˆ—è¡¨æ—¶æ‰è¿›è¡Œæ¸…ç†
                    if (window.TARGET_SIGNATURE && (text.includes('#EXTM3U'))) {
                        console.log(`[Loader] æ­£åœ¨æ¸…æ´— M3U8ï¼Œç›®æ ‡ç­¾å: ${window.TARGET_SIGNATURE}`);
                        const originalLines = text.split('\n');
                        const cleanedText = this.purify(text, window.TARGET_SIGNATURE);
                        
                        // ç»Ÿè®¡ç§»é™¤è¡Œæ•°
                        const newLines = cleanedText.split('\n');
                        const diff = originalLines.length - newLines.length;
                        if (diff > 0) {
                            window.ADS_REMOVED_COUNT += diff; // ç²—ç•¥è®¡æ•°
                            console.warn(`[Loader] ç§»é™¤äº†çº¦ ${diff} è¡Œå¹¿å‘Šä»£ç `);
                            updateDebugUI();
                        }

                        // è¿”å›ä¿®æ”¹åçš„æ•°æ®ç»™ HLS.js
                        callbacks.onSuccess({
                            url: url,
                            data: cleanedText
                        }, {
                            url: url,
                            data: cleanedText
                        }, context);
                    } else {
                        // å¦‚æœä¸æ˜¯ç›®æ ‡M3U8æˆ–æ²¡ç­¾åï¼Œç›´æ¥è¿”å›åŸæ•°æ®
                        callbacks.onSuccess({
                            url: url,
                            data: text
                        }, {
                            url: url,
                            data: text
                        }, context);
                    }
                })
                .catch(error => {
                    console.error("[Loader] åŠ è½½å¤±è´¥:", error);
                    callbacks.onError(error, context);
                });
        }

        // **æ ¸å¿ƒå‡€åŒ–é€»è¾‘**
        purify(manifestText, signature) {
            const lines = manifestText.split('\n');
            let output = [];
            let buffer = []; // ç¼“å­˜ EXTINF ç­‰ä¿¡æ¯

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // 1. å…¨å±€æ ‡ç­¾ï¼šä¿ç•™
                if (line.startsWith('#EXTM3U') || 
                    line.startsWith('#EXT-X-VERSION') ||
                    line.startsWith('#EXT-X-TARGETDURATION') ||
                    line.startsWith('#EXT-X-MEDIA-SEQUENCE') ||
                    line.startsWith('#EXT-X-PLAYLIST-TYPE') ||
                    line.startsWith('#EXT-X-ENDLIST') || 
                    line.startsWith('#EXT-X-DISCONTINUITY')) {
                    
                    // é‡åˆ° Discontinuity ä¹Ÿè¦æŠŠä¹‹å‰çš„ buffer æ¸…ç©ºï¼ˆç†è®ºä¸Šä¸è¯¥æœ‰æ®‹ç•™ï¼‰
                    buffer = [];
                    output.push(line);
                    continue;
                }

                // 2. Key è¡Œï¼šå•ç‹¬æ£€æŸ¥
                // å¹¿å‘Šçš„ Key è¡Œé€šå¸¸ä¸åŒ…å«ç­¾å URI="..."
                if (line.startsWith('#EXT-X-KEY')) {
                    if (line.includes(signature)) {
                        output.push(line); // æ˜¯æ­£ç‰‡Keyï¼Œä¿ç•™
                    } else {
                        console.log(`[Filter] ä¸¢å¼ƒå¹¿å‘ŠKey: ${line}`);
                        // ä¸¢å¼ƒ
                    }
                    continue;
                }

                // 3. ç‰‡æ®µå…ƒæ•°æ®ï¼šç¼“å­˜
                if (line.startsWith('#EXTINF') || line.startsWith('#EXT-X-PROGRAM-DATE-TIME')) {
                    buffer.push(line);
                    continue;
                }

                // 4. URL è¡Œ (é#å¼€å¤´)
                if (!line.startsWith('#')) {
                    // æ£€æŸ¥ URL æ˜¯å¦åŒ…å«ç­¾å
                    if (line.includes(signature)) {
                        // åŒ…å«ç­¾å -> å†™å…¥ç¼“å­˜çš„ INF å’Œ å½“å‰ URL
                        output = output.concat(buffer);
                        output.push(line);
                    } else {
                        // ä¸åŒ…å«ç­¾å -> ä¸¢å¼ƒç¼“å­˜ å’Œ å½“å‰ URL
                        // console.log(`[Filter] ä¸¢å¼ƒå¹¿å‘Šç‰‡æ®µ: ${line}`);
                    }
                    buffer = []; // æ¸…ç©ºç¼“å­˜
                } else {
                    // å…¶ä»–æœªçŸ¥æ ‡ç­¾ï¼Œä¿ç•™ä»¥é˜²ä¸‡ä¸€
                    output.push(line);
                }
            }
            return output.join('\n');
        }

        abort() { console.log('[Loader] Abort requested'); }
        destroy() { console.log('[Loader] Destroyed'); }
    }


    // --- ä¸»ç¨‹åºé€»è¾‘ ---
    const video = document.getElementById('video');
    const input = document.getElementById('m3u8-input');
    const debugDiv = document.getElementById('debug-info');
    const statusDiv = document.getElementById('status-message');

    function getUrlParam(name) {
        const r = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(location.search);
        return r ? decodeURIComponent(r[1]) : '';
    }

    function updateDebugUI() {
        debugDiv.innerText = `ç›®æ ‡ID: ${window.TARGET_SIGNATURE || 'æ— '} | æ‹¦æˆªè¡Œæ•°: ${window.ADS_REMOVED_COUNT}`;
    }

    // æå– URL ä¸­çš„ 8ä½ ID (å¦‚ GsUnW9HR)
    function extractSignature(url) {
        try {
            // æŸ¥æ‰¾ /XXXXXXXX/d+kb/ ç»“æ„
            const match = url.match(/\/([a-zA-Z0-9]{8,})\/\d+kb/);
            return match ? match[1] : '';
        } catch (e) { return ''; }
    }

    function loadM3U8(url) {
        if (!url) return;
        
        if (Hls.isSupported()) {
            if (window.hls) window.hls.destroy();

            // 1. æå–ç­¾å
            window.TARGET_SIGNATURE = extractSignature(url);
            window.ADS_REMOVED_COUNT = 0;
            updateDebugUI();
            
            if (!window.TARGET_SIGNATURE) {
                statusDiv.textContent = "è­¦å‘Šï¼šæ— æ³•ä» URL è¯†åˆ«å†…å®¹ IDï¼Œå¹¿å‘Šè¿‡æ»¤å¯èƒ½å¤±æ•ˆã€‚";
                statusDiv.style.display = 'block';
            } else {
                statusDiv.textContent = `å·²é”å®šå†…å®¹ ID: ${window.TARGET_SIGNATURE}ï¼Œæ­£åœ¨è¿‡æ»¤...`;
                statusDiv.style.display = 'block';
            }

            // 2. é…ç½® HLS ä½¿ç”¨è‡ªå®šä¹‰ Loader
            const config = {
                // è¦†ç›– Playlist Loader (å¤„ç† m3u8 æ–‡ä»¶)
                pLoader: CustomPlaylistLoader,
                // å¸¸ç”¨ä¼˜åŒ–
                startBufferLength: 10,
                maxBufferLength: 60,
                debug: false
            };

            const hls = new Hls(config);
            window.hls = hls;

            hls.loadSource(url);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                console.log("Manifest è§£ææˆåŠŸ");
                video.play().catch(e => console.log("è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆª"));
            });

            hls.on(Hls.Events.ERROR, (e, data) => {
                if (data.fatal) {
                    console.error("Fatal Error:", data);
                    // statusDiv.textContent = `åŠ è½½é”™è¯¯: ${data.details}`;
                    // å°è¯•è‡ªåŠ¨æ¢å¤
                    switch(data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            hls.recoverMediaError();
                            break;
                        default:
                            hls.destroy();
                            break;
                    }
                }
            });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            alert("iOS Safari åŸç”Ÿæ’­æ”¾å™¨ä¸æ”¯æŒæ‹¦æˆªå¹¿å‘Šï¼Œè¯·ä½¿ç”¨ PC æˆ– å®‰å“ Chromeã€‚");
        }
    }

    // --- åˆå§‹åŒ– ---
    const paramUrl = getUrlParam('url');
    if (paramUrl) {
        input.value = paramUrl;
        loadM3U8(paramUrl);
    } else {
        // æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦æœ‰å€¼ (ä¾‹å¦‚æµè§ˆå™¨è®°ä½çš„)
        if (input.value) loadM3U8(input.value);
    }

    document.getElementById('load-button').onclick = () => loadM3U8(input.value.trim());
    input.onkeydown = (e) => { if(e.key === 'Enter') loadM3U8(input.value.trim()); };

</script>
</body>
</html>
