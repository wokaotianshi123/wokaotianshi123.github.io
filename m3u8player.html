<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨ (Proç‰ˆ)</title>
    <!-- è§£å†³ Favicon 404 æŠ¥é”™ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“º</text></svg>">
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #app-container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #00ccff; /* DPlayer ä¸»é¢˜è‰² */
            text-align: center;
            margin: 10px 0 20px 0;
            font-size: 1.5rem;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        #control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        #m3u8-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #444;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        #m3u8-input:focus {
            outline: none;
            border-color: #00ccff;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            color: #fff;
            white-space: nowrap;
            height: 40px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* çº¿è·¯é€‰æ‹©å™¨æ ·å¼ */
        #line-select {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #fff;
            max-width: 160px;
            appearance: none; /* ç§»é™¤åŸç”Ÿç®­å¤´ */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px; /* ä¸ºç®­å¤´ç•™å‡ºç©ºé—´ */
        }
        #line-select:focus {
            border-color: #00ccff;
            outline: none;
        }

        #load-button { background-color: #00ccff; color: #000; }
        #load-button:hover { filter: brightness(1.1); }

        #cast-button { background-color: #3b82f6; gap: 6px; }
        #cast-button:hover { filter: brightness(1.1); }
        #cast-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }

        /* --- æ’­æ”¾å™¨å®¹å™¨ (å…³é”®èåˆéƒ¨åˆ†) --- */
        #video-wrapper {
            flex-grow: 1;
            width: 100%;
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            aspect-ratio: 16 / 9;
        }

        /* DPlayer å®¹å™¨ */
        #dplayer-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
        }
        
        /* å¼ºåˆ¶è§†é¢‘å…ƒç´ ç¡¬ä»¶åŠ é€Ÿ */
        #dplayer-container video {
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
            will-change: transform;
            backface-visibility: hidden;
        }

        /* è‡ªå®šä¹‰ç»Ÿè®¡é¢æ¿ (è¦†ç›–åœ¨DPlayerä¹‹ä¸Š) */
        #custom-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.85);
            color: #eee;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            z-index: 100;
            pointer-events: none; /* ç‚¹å‡»ç©¿é€ */
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            font-family: Consolas, monospace;
            min-width: 200px;
            display: none;
        }

        /* Iframe ç«é€Ÿå®¹å™¨ */
        .temp-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0; left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 5;
            background: #000;
        }
        
        .iframe-active {
            z-index: 20;
            opacity: 1;
            pointer-events: auto;
        }

        /* --- çŠ¶æ€æç¤º --- */
        #status-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #2a3f4d;
            color: #7dd3fc;
            font-size: 13px;
            display: none;
            white-space: pre-line;
            overflow-wrap: break-word;
        }

        /* å—…æ¢æˆåŠŸåŠ¨ç”» */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .sniff-success {
            animation: pulse-green 1.5s infinite;
            border: 1px solid #4ade80 !important;
        }

        /* --- æŠ•å±æ¨¡æ€æ¡†æ ·å¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-active { display: flex !important; opacity: 1 !important; }
        
        .cast-modal {
            background: #252525;
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid #444;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        .modal-active .cast-modal { transform: translateY(0); }

        .cast-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;
        }
        .cast-title { font-size: 18px; font-weight: bold; color: #fff; }
        .cast-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        
        .cast-group { margin-bottom: 15px; }
        .cast-group-title { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        .cast-option {
            display: flex; align-items: center; gap: 12px;
            padding: 12px;
            background: #333;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: #fff;
        }
        .cast-option:hover { background: #444; }
        .cast-icon { font-size: 20px; width: 24px; text-align: center; }
        .cast-info { display: flex; flex-direction: column; }
        .cast-name { font-size: 15px; font-weight: 500; }
        .cast-desc { font-size: 12px; color: #aaa; }
        
        .tag-recommend { background: #00ccff; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; font-weight: bold; }

        /* --- ç§»åŠ¨ç«¯ä¼˜åŒ– --- */
        @media (max-width: 600px) {
            #app-container { 
                padding: 10px; 
                margin: 0;
                border: none;
                box-shadow: none;
                width: 100%;
                max-width: 100%;
            }
            #control-panel { gap: 8px; }
            #m3u8-input { width: 100%; font-size: 16px; padding: 12px; }
            #line-select { width: 100%; max-width: none; order: 2; }
            #load-button { flex: 2; order: 3; }
            #cast-button { flex: 1; order: 3; }
            h1 { font-size: 1.2rem; margin: 5px 0 15px 0; }
            #video-wrapper {
                flex-grow: 0;
                width: 100%;
                aspect-ratio: 16 / 9;
                min-height: auto;
                border-radius: 4px;
                border-color: #222;
            }
        }
    </style>
    
    <!-- Google Cast åˆå§‹åŒ– -->
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                try {
                    cast.framework.CastContext.getInstance().setOptions({
                        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                    });
                    window.isGCastInitialized = true;
                    document.dispatchEvent(new Event('google-cast-ready'));
                } catch (e) { console.error('GCast Init Error:', e); }
            }
        };
    </script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>

<div id="app-container">
    <h1>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨ <span style="font-size:0.6em;color:#777;vertical-align:middle;">PRO</span></h1>
    
    <div id="control-panel">
        <input type="url" id="m3u8-input" placeholder="è¾“å…¥ M3U8 ç›´é“¾æˆ–è§†é¢‘ç½‘ç«™åœ°å€" value="YOUR_URL_HERE">
        <!-- æ–°å¢çº¿è·¯é€‰æ‹©å™¨ -->
        <select id="line-select" class="btn">
            <option value="-1">ğŸš€ è‡ªåŠ¨ç«é€Ÿ</option>
        </select>
        <button id="load-button" class="btn">âš¡ï¸ æ’­æ”¾</button>
        <button id="cast-button" class="btn">ğŸ“º æŠ•å±</button>
    </div>

    <div id="status-message"></div>

    <div id="video-wrapper">
        <!-- ç«é€Ÿè§£ææ¨¡å¼çš„ Loading æç¤º -->
        <div id="loading-tip" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#888; display:none; z-index:1; text-align:center; width: 100%;">
            <p id="loading-text">æ­£åœ¨è§£æ...</p>
            <p style="font-size:12px; color:#555;">åå°æ­£åœ¨å°è¯•å—…æ¢çœŸå® M3U8 åœ°å€</p>
        </div>
        
        <!-- DPlayer å®¹å™¨ -->
        <div id="dplayer-container"></div>
        <!-- è‡ªå®šä¹‰ç»Ÿè®¡é¢æ¿ -->
        <div id="custom-stats"></div>
        
        <!-- Iframe å®¹å™¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
</div>

<!-- æŠ•å±é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="cast-modal-overlay" class="modal-overlay">
    <div class="cast-modal">
        <div class="cast-header">
            <div class="cast-title">é€‰æ‹©æŠ•å±æˆ–æ’­æ”¾æ–¹å¼</div>
            <button class="cast-close" id="close-cast-modal">Ã—</button>
        </div>
        <div id="cast-options-container">
            <!-- é€‰é¡¹å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- åº“å¼•å…¥: hls.js + DPlayer -->
<script src="https://s4.zstatic.net/ajax/libs/hls.js/1.5.6/hls.min.js" crossorigin="anonymous"></script>
<script src="https://s4.zstatic.net/ajax/libs/dplayer/1.26.0/DPlayer.min.js" crossorigin="anonymous"></script>

<script>
    // --- é…ç½®åŒºåŸŸ ---
    const apiArray = [
	{
		name: "ikun",
		url: "https://jx.hls.one/?url="
	},
	{
		name: "77",
		url: "https://jx.77flv.cc/?url="
	},
	{
		name: "å†°è±†",
		url: "https://bd.jx.cn/?url="
	},
	{
		name: "XY",
		url: "https://jx.xymp4.cc/?url="
	},
	{
		name: "Ckplayer",
		url: "https://www.ckplayer.vip/jiexi/?url="
	},
	{
		name: "M3u8TV",
		url: "https://jx.m3u8.tv/jiexi/?url="
	},
	{
		name: "XMFLV",
		url: "https://jx.xmflv.com/?url="
	},
	{
		name: "YParse",
		url: "https://yparse.ik9.cc/index.php?url="
	},
	{
		name: "8090g",
		url: "https://www.8090g.cn/jiexi/?url="
	},
	{
		name: "jy",
		url: "https://jx.playerjy.com/?url="
	},
	{
		name: "nnxy",
		url: "https://jx.nnxv.cn/tv.php?url="
	},
	{
		name: "pg",
		url: "https://www.pangujiexi.com/pangu/?url="
	},
	{
		name: "2s0",
		url: "https://jx.2s0.cn/player/?url="
	},
	{
		name: "æ¨è",
		url: "https://zy.qiaoji8.com/gouzi.php?url=94b07e0b2c0e8244&url="
	}
];

    // é«˜æ€§èƒ½ HLS é…ç½®
    const hlsConfig = {
        enableWorker: true,
        lowLatencyMode: false,
        startBufferLength: 20,
        maxBufferLength: 120,
        maxMaxBufferLength: 600,
        maxBufferSize: 200 * 1024 * 1024,
        backBufferLength: 90,
        fragLoadingTimeOut: 20000,
        fragLoadingMaxRetry: 6,
        manifestLoadingTimeOut: 20000,
        levelLoadingTimeOut: 20000,
        maxLoadingDelay: 4, 
        minAutoBitrate: 0, 
        capLevelToPlayerSize: false, 
        autoStartLoad: true,
        maxBufferHole: 0.5,
    };

    // --- å…¨å±€å˜é‡ ---
    let dp = null; 
    let hlsInstance = null;
    let currentMode = 'idle';
    let isSniffed = false;
    let statsTimer = null; 
    let raceAborted = false; // ç”¨äºä¸­æ–­ç«é€Ÿ
    
    // FPS è®¡ç®—å˜é‡
    let frameCount = 0;
    let currentFPS = 0;
    let lastFrameTime = 0;

    // å½“å‰æ’­æ”¾çš„çœŸå®URLï¼ˆå¦‚æœæ˜¯Blobåˆ™æ­¤å˜é‡å­˜å‚¨Blobï¼Œå¦‚æœæ˜¯åŸå§‹åˆ™å­˜å‚¨åŸå§‹ï¼‰
    let currentNetworkUrl = "";

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('m3u8-input');
        const loadBtn = document.getElementById('load-button');
        const castBtn = document.getElementById('cast-button');
        const lineSelect = document.getElementById('line-select');
        const statusDiv = document.getElementById('status-message');
        const wrapper = document.getElementById('video-wrapper');
        const loadingTip = document.getElementById('loading-tip');
        const loadingText = document.getElementById('loading-text');
        
        // æ¨¡æ€æ¡†ç›¸å…³
        const modalOverlay = document.getElementById('cast-modal-overlay');
        const closeCastBtn = document.getElementById('close-cast-modal');

        const urlParam = getUrlParameter('url');
        input.value = urlParam || (input.value === 'YOUR_URL_HERE' ? '' : input.value);

        // --- åˆå§‹åŒ–çº¿è·¯é€‰æ‹©ä¸‹æ‹‰æ¡† ---
        apiArray.forEach((api, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = api.name;
            lineSelect.appendChild(option);
        });

        // çº¿è·¯åˆ‡æ¢äº‹ä»¶
        lineSelect.addEventListener('change', () => {
            if (input.value && input.value !== 'YOUR_URL_HERE') {
                startPlay();
            }
        });

        function startPlay() {
            const url = input.value.trim();
            if (!url) return showStatus('è¯·è¾“å…¥è§†é¢‘åœ°å€', 'error');

            currentNetworkUrl = url; 
            resetPlayer();
            
            // åˆ¤å®šé€»è¾‘ï¼šæ˜¯ M3U8 è¿˜æ˜¯ ç½‘é¡µ
            if (url.includes('.m3u8') || url.startsWith('blob:') || url.startsWith('http://127.0.0.1')) {
                loadM3U8Mode(url);
            } else {
                const selectedLine = parseInt(lineSelect.value);
                
                if (selectedLine === -1) {
                    // è‡ªåŠ¨ç«é€Ÿæ¨¡å¼
                    loadIframeRaceMode(url);
                } else {
                    // æ‰‹åŠ¨å•çº¿æ¨¡å¼
                    loadSingleLineMode(url, selectedLine);
                }
                
                // æ— è®ºæ‰‹åŠ¨è¿˜æ˜¯è‡ªåŠ¨ï¼Œéƒ½å¯åŠ¨å…¨å±€å—…æ¢ä½œä¸ºå…œåº•ä¼˜åŒ–
                startGlobalSniffing(url);
            }
        }
        
        loadBtn.addEventListener('click', startPlay);
        input.addEventListener('keydown', (e) => e.key === 'Enter' && startPlay());
        
        // ç»‘å®šæ¨¡æ€æ¡†å…³é—­
        closeCastBtn.onclick = () => {
            modalOverlay.classList.remove('modal-active');
        };
        modalOverlay.onclick = (e) => {
            if(e.target === modalOverlay) modalOverlay.classList.remove('modal-active');
        };

        // --- æ¨¡å¼ A: æœ¬åœ° M3U8 å¢å¼ºæ¨¡å¼ ---
        async function loadM3U8Mode(url, isAutoSniffed = false) {
            currentMode = 'm3u8';
            castBtn.disabled = false;
            isSniffed = true; // æ ‡è®°å·²å—…æ¢åˆ°
            raceAborted = true; // åœæ­¢å…¶ä»–ç«äº‰
            wrapper.classList.remove('sniff-success');
            
            if(isAutoSniffed) currentNetworkUrl = url;

            if (isAutoSniffed) {
                showStatus('âœ… æ·±åº¦å—…æ¢æˆåŠŸï¼å·²åˆ‡æ¢è‡³å¢å¼ºæ¨¡å¼ (å·²å»å¹¿å‘Š/æ”¯æŒæŠ•å±)', 'success');
                wrapper.classList.add('sniff-success');
                setTimeout(() => wrapper.classList.remove('sniff-success'), 2000);
            } else {
                showStatus('æ­£åœ¨æ™ºèƒ½åˆ†æåª’ä½“æµ...', 'info');
            }

            let finalUrl = url;
            try {
                const cleanResult = await fetchAndCleanM3u8(url);
                
                if (cleanResult.removedCount > 0) {
                    if (!isAutoSniffed) showStatus(`${cleanResult.log}\næ­£åœ¨ç”Ÿæˆçº¯å‡€æµ...`, 'success');
                    const blob = new Blob([cleanResult.content], { type: 'application/vnd.apple.mpegurl' });
                    finalUrl = URL.createObjectURL(blob);
                } else {
                    if (!isAutoSniffed) showStatus('æœªæ£€æµ‹åˆ°å¹¿å‘Šæˆ–æ— éœ€æ¸…æ´—ï¼Œå‡†å¤‡æ’­æ”¾...', 'info');
                }
            } catch (e) {
                console.warn('æ¸…æ´—è·³è¿‡:', e);
                if (!isAutoSniffed) {
                    const msg = e.name === 'AbortError' 
                        ? 'âš ï¸ å¹¿å‘Šåˆ†æè¶…æ—¶ï¼Œè·³è¿‡æ¸…æ´—ç›´æ¥æ’­æ”¾...' 
                        : 'âš ï¸ ç›®æ ‡èµ„æºç¦æ­¢è·¨åŸŸè®¿é—®ï¼Œæ— æ³•å»å¹¿å‘Šï¼Œå°†å°è¯•ç›´æ¥æ’­æ”¾...';
                    showStatus(msg, 'warning');
                }
            }

            initDPlayer(finalUrl);
        }

        // --- é€’å½’å¹¿å‘Šæ¸…æ´—ä¸ Master Playlist è§£æ ---
        async function fetchAndCleanM3u8(url, depth = 0) {
            // é˜²æ­¢æ­»å¾ªç¯
            if (depth > 3) throw new Error("Redirect loop detected in M3U8 playlist");

            const toAbsolute = (p, b) => { try { return new URL(p, b).href; } catch(e) { return p; } };
            
            if (depth > 0) {
                showStatus(`ğŸ”„ æ­£åœ¨è§£æåµŒå¥—åˆ—è¡¨ (å±‚çº§ ${depth})...`, 'info');
            }

            // è®¾ç½®è¶…æ—¶ fetch
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const originalContent = await response.text();

            // === 1. æ£€æŸ¥æ˜¯å¦ä¸º Master Playlist (åµŒå¥—åˆ—è¡¨) ===
            // åŒ…å« #EXT-X-STREAM-INF è¯´æ˜æ˜¯å¤šç ç‡åˆ—è¡¨ï¼Œä¸åŒ…å«å®é™…åˆ‡ç‰‡
            if (originalContent.includes('#EXT-X-STREAM-INF')) {
                const lines = originalContent.split(/\r?\n/);
                let bestUrl = null;
                let maxBandwidth = -1;

                // ç®€å•çš„è§£æé€»è¾‘ï¼šå¯»æ‰¾å¸¦å®½æœ€é«˜çš„æµ
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('#EXT-X-STREAM-INF')) {
                        const bwMatch = lines[i].match(/BANDWIDTH=(\d+)/);
                        const bandwidth = bwMatch ? parseInt(bwMatch[1]) : 0;
                        
                        // URL é€šå¸¸åœ¨ä¸‹ä¸€è¡Œ (å¿½ç•¥ç©ºè¡Œå’Œæ³¨é‡Š)
                        let j = i + 1;
                        while (j < lines.length) {
                            const nextLine = lines[j].trim();
                            if (nextLine && !nextLine.startsWith('#')) {
                                if (bandwidth > maxBandwidth) {
                                    maxBandwidth = bandwidth;
                                    bestUrl = nextLine;
                                } else if (!bestUrl) {
                                     bestUrl = nextLine; // å…œåº•ï¼šå–ç¬¬ä¸€ä¸ª
                                }
                                break;
                            }
                            j++;
                        }
                    }
                }

                if (bestUrl) {
                    const nextUrl = toAbsolute(bestUrl, url);
                    console.log(`[Master Playlist] Found best stream: ${nextUrl} (Bandwidth: ${maxBandwidth})`);
                    // é€’å½’è°ƒç”¨ï¼Œå¤„ç†å­åˆ—è¡¨
                    return fetchAndCleanM3u8(nextUrl, depth + 1);
                }
            }

            // === 2. å¸¸è§„ Media Playlist æ¸…æ´—é€»è¾‘ ===
            const lines = originalContent.split(/\r?\n/);
            const segments = [];
            const fingerprintCounts = {};
            
            lines.forEach((line, idx) => {
                const trimmed = line.trim();
                if(!trimmed || trimmed.startsWith('#')) return;
                
                // è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œç¡®ä¿åˆ†æå‡†ç¡®
                const absUrl = toAbsolute(trimmed, url);
                let u; try { u = new URL(absUrl); } catch(e) { return; }
                
                // æŒ‡çº¹ç‰¹å¾ï¼šåŸŸå + è·¯å¾„ç»“æ„ (å»æ‰æ–‡ä»¶å)
                const pathParts = u.pathname.split('/'); 
                pathParts.pop(); 
                const fp = `${u.hostname}|${pathParts.join('/')}`;
                
                if(!fingerprintCounts[fp]) fingerprintCounts[fp] = 0;
                fingerprintCounts[fp]++;
                segments.push({ idx, fp });
            });
            
            let dominantFp = '', maxC = 0;
            for(const [fp, c] of Object.entries(fingerprintCounts)) { 
                if(c > maxC) { maxC = c; dominantFp = fp; } 
            }
            
            // å®‰å…¨é˜ˆå€¼ï¼šå¦‚æœä¸»å†…å®¹å æ¯”ä¸åˆ° 40%ï¼Œå¯èƒ½è¯¯åˆ¤ï¼Œä¸æ•¢ä¹±åˆ 
            if(segments.length === 0 || (maxC / segments.length) < 0.4) {
                return { content: originalContent, removedCount: 0, log: 'æœªæ¸…æ´— (ç‰¹å¾ä¸æ˜æ˜¾)' };
            }

            const linesToRemove = new Set();
            segments.forEach(seg => {
                if(seg.fp !== dominantFp) {
                    // æ ‡è®°ä¸ºå¹¿å‘Š
                    linesToRemove.add(seg.idx);
                    // å‘ä¸Šå›æº¯åˆ é™¤ç›¸å…³çš„ TAG (EXTINF ç­‰)
                    let j = seg.idx - 1;
                    while(j >= 0) {
                        const l = lines[j].trim();
                        if(l.startsWith('#EXTINF') || l.startsWith('#EXT-X-BYTERANGE') || l.startsWith('#EXT-X-KEY') || l.startsWith('#EXT-X-DISCONTINUITY')) { 
                            linesToRemove.add(j); j--; 
                        } else if (!l.startsWith('#EXT') && l.startsWith('#')) {
                             // å…¶ä»–æœªçŸ¥æ³¨é‡Šï¼Œå¦‚æœä¸ç´§é‚» EXTINFï¼Œå¯èƒ½ä¸ç”¨åˆ ï¼Œè¿™é‡Œç®€å•å¤„ç†é‡åˆ°éTAGåœæ­¢
                             j--; // ç»§ç»­å‘ä¸Šæ£€æŸ¥
                        } else if (l === '') {
                             j--;
                        } else {
                            break; // é‡åˆ°å…¶ä»–å†…å®¹åœæ­¢
                        }
                    }
                }
            });

            // é‡æ„åˆ—è¡¨
            const newLines = [];
            lines.forEach((line, idx) => {
                if(linesToRemove.has(idx)) return;
                
                let content = line.trim();
                if(!content) return;
                
                if(content.startsWith('#')) {
                    // å¦‚æœ Key åŒ…å«ç›¸å¯¹è·¯å¾„ URIï¼Œéœ€è¦é‡å†™ä¸ºç»å¯¹è·¯å¾„
                    if(content.startsWith('#EXT-X-KEY') && content.includes('URI="')) {
                        content = content.replace(/URI="([^"]+)"/, (m, p1) => `URI="${toAbsolute(p1, url)}"`);
                    }
                    newLines.push(content);
                } else {
                    // æ‰€æœ‰åˆ†ç‰‡è·¯å¾„é‡å†™ä¸ºç»å¯¹è·¯å¾„ (åŸºäºå½“å‰å­åˆ—è¡¨ URL)
                    newLines.push(toAbsolute(content, url));
                }
            });
            
            const removedCount = segments.length - maxC;
            const logMsg = depth > 0 
                ? `å·²è§£æåµŒå¥—åˆ—è¡¨ (å±‚çº§ ${depth})ï¼Œç§»é™¤ ${removedCount} ä¸ªå¹¿å‘Š` 
                : `å·²ç§»é™¤ ${removedCount} ä¸ªå¹¿å‘Šåˆ†ç‰‡`;

            // å¦‚æœæ˜¯åœ¨å­åˆ—è¡¨é‡Œï¼Œå³ä½¿ removedCount ä¸º 0ï¼Œæˆ‘ä»¬ä¹Ÿè¿”å› newLines (ç»å¯¹è·¯å¾„åŒ–)ï¼Œ
            // å› ä¸º Blob éœ€è¦ç»å¯¹è·¯å¾„æ‰èƒ½æ’­æ”¾ï¼Œä¸”æˆ‘ä»¬ä¸æƒ³å›é€€åˆ° Master Playlist
            // ä¸ºäº†è®©è°ƒç”¨è€…çŸ¥é“éœ€è¦ç”¨ Blobï¼Œè¿™é‡Œ hack ä¸€ä¸‹ removedCount æˆ–è€…ç”±è°ƒç”¨è€…åˆ¤æ–­
            // ä½†ä¸ºäº†ä¿æŒæ¥å£ç®€å•ï¼Œå¦‚æœ depth > 0ï¼Œæˆ‘ä»¬å¼ºåˆ¶è§†ä¸º "æœ‰ä¿®æ”¹" (å› ä¸ºè·¯å¾„å˜ç»å¯¹äº†)
            const effectiveRemovedCount = depth > 0 ? (removedCount + 1) : removedCount;

            return { 
                content: newLines.join('\n'), 
                removedCount: effectiveRemovedCount, 
                log: logMsg 
            };
        }

        // --- åˆå§‹åŒ– DPlayer ---
        function initDPlayer(videoUrl) {
            if (dp) dp.destroy();
            stopStatsLoop();
            
            // ç¡®ä¿æ˜¾ç¤ºæ’­æ”¾å™¨å®¹å™¨ï¼Œéšè—Iframe
            document.getElementById('dplayer-container').style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());

            dp = new DPlayer({
                container: document.getElementById('dplayer-container'),
                autoplay: true,
                theme: '#00ccff',
                lang: 'zh-cn',
                screenshot: true,
                hotkey: true,
                airplay: false, 
                chromecast: false,
                volume: 0.7,
                video: {
                    url: videoUrl,
                    type: 'customHls', 
                    customType: {
                        customHls: function(video, player) {
                            if (Hls.isSupported()) {
                                if (hlsInstance) hlsInstance.destroy();
                                hlsInstance = new Hls(hlsConfig);
                                hlsInstance.loadSource(videoUrl);
                                hlsInstance.attachMedia(video);
                                
                                hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                    if(hlsInstance.levels.length > 0) {
                                        hlsInstance.currentLevel = hlsInstance.levels.length - 1;
                                        hlsInstance.capLevelToPlayerSize = false;
                                        showStatus('ğŸš€ ç”»è´¨å¢å¼ºï¼šå·²é”å®šæœ€é«˜ç ç‡/å¸§ç‡', 'success');
                                    }
                                    startStatsLoop(video, hlsInstance);
                                    video.play().catch(e => console.warn('Autoplay blocked', e));
                                });
                                hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                                    if (data.fatal) {
                                        switch(data.type) {
                                            case Hls.ErrorTypes.NETWORK_ERROR: hlsInstance.startLoad(); break;
                                            case Hls.ErrorTypes.MEDIA_ERROR: hlsInstance.recoverMediaError(); break;
                                            default: hlsInstance.destroy(); break;
                                        }
                                    }
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                video.src = videoUrl;
                                startStatsLoop(video, null);
                            }
                        }
                    }
                },
                contextmenu: [
                    {
                        text: 'ç»Ÿè®¡ä¿¡æ¯å¼€å…³',
                        click: (player) => {
                            const stats = document.getElementById('custom-stats');
                            stats.style.display = stats.style.display === 'none' ? 'block' : 'none';
                        }
                    }
                ]
            });

            setupCastButtonLogic(dp.video);
            setupMobileLongPress(dp);
            
            dp.on('canplay', () => { setTimeout(() => clearStatus(), 3000); });
        }
        
        // --- æ ¸å¿ƒï¼šæ–°ç‰ˆæŠ•å±é€»è¾‘ ---
        function setupCastButtonLogic(videoEl) {
            castBtn.onclick = () => {
                renderCastOptions(videoEl);
                modalOverlay.classList.add('modal-active');
            };
        }

        function renderCastOptions(videoEl) {
            const container = document.getElementById('cast-options-container');
            container.innerHTML = '';
            
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(ua);
            const isAndroid = /android/.test(ua);
            const isMac = /mac os/.test(ua) && !isIOS;
            const isWin = /windows/.test(ua);

            const createOption = (icon, title, desc, onClick, tag = '') => {
                const div = document.createElement('div');
                div.className = 'cast-option';
                div.innerHTML = `
                    <div class="cast-icon">${icon}</div>
                    <div class="cast-info">
                        <div class="cast-name">${title} ${tag ? `<span class="tag-recommend">${tag}</span>` : ''}</div>
                        <div class="cast-desc">${desc}</div>
                    </div>
                `;
                div.onclick = () => {
                    onClick();
                    if(!title.includes('AirPlay') && !title.includes('Chromecast')) {
                        // modalOverlay.classList.remove('modal-active');
                    }
                };
                return div;
            };

            const addGroup = (title) => {
                const div = document.createElement('div');
                div.className = 'cast-group-title';
                div.innerText = title;
                container.appendChild(div);
            };

            addGroup('æ— çº¿æŠ•å±');
            
            // AirPlay
            if(isIOS || (isMac && /safari/.test(ua) && !/chrome/.test(ua))) {
                 container.appendChild(createOption('ğŸ', 'AirPlay', 'æŠ•å°„åˆ° Apple TV æˆ–æ”¯æŒ AirPlay çš„ç”µè§†', () => {
                     if(videoEl.webkitShowPlaybackTargetPicker) {
                         videoEl.webkitShowPlaybackTargetPicker();
                     } else {
                         showStatus('è¯·åœ¨æ’­æ”¾å™¨æ§åˆ¶æ ç‚¹å‡» AirPlay å›¾æ ‡', 'info');
                     }
                 }));
            }

            // Google Cast
            if(window.chrome && !isIOS) {
                container.appendChild(createOption('ğŸ“¡', 'Google Cast', 'æŠ•å°„åˆ° Chromecast æˆ– Android TV', () => {
                    if(window.cast && window.cast.framework) {
                        const ctx = cast.framework.CastContext.getInstance();
                        const session = ctx.getCurrentSession();
                        const mediaInfo = new chrome.cast.media.MediaInfo(currentNetworkUrl, 'application/x-mpegurl');
                        const request = new chrome.cast.media.LoadRequest(mediaInfo);
                        if(!session) {
                            ctx.requestSession().then(() => {
                                ctx.getCurrentSession().loadMedia(request);
                            }).catch(e => console.error(e));
                        } else {
                            session.loadMedia(request);
                        }
                    } else {
                        showStatus('Chromecast æœåŠ¡æœªå°±ç»ª', 'warning');
                    }
                }));
            }

            addGroup('DLNA / ç¬¬ä¸‰æ–¹æŠ•å±');

            if (isAndroid || isIOS) {
                const wvcUrl = `wvc-x-callback://open?url=${encodeURIComponent(currentNetworkUrl)}&secure_uri=true`;
                container.appendChild(createOption('ğŸš€', 'Web Video Caster', 'æ¨èï¼æ”¯æŒ DLNA/æŠ•å±åˆ°å‡ ä¹æ‰€æœ‰ç”µè§†', () => {
                    window.location.href = wvcUrl;
                }, 'æ¨è'));

                container.appendChild(createOption('ğŸ“º', 'é€šç”¨æŠ•å±åŠ©æ‰‹', 'å°è¯•å”¤èµ·æ‰‹æœºå†…å®‰è£…çš„æŠ•å±è½¯ä»¶', () => {
                    window.location.href = `video-cast://${currentNetworkUrl}`;
                }));
            }

            addGroup('æœ¬åœ°åº”ç”¨æ’­æ”¾');
            
            container.appendChild(createOption('ğŸŸ ', 'VLC æ’­æ”¾å™¨', 'åœ¨ VLC ä¸­æ‰“å¼€ (è§£ç å¼º/æ”¯æŒä¸²æµ)', () => {
                window.location.href = `vlc://${currentNetworkUrl}`;
            }));

            if(isMac) {
                container.appendChild(createOption('ğŸï¸', 'IINA', 'Mac æœ€ä½³æ’­æ”¾å™¨', () => {
                    window.location.href = `iina://weblink?url=${currentNetworkUrl}`;
                }, 'Macé¦–é€‰'));
            }

            if(isWin) {
                container.appendChild(createOption('ğŸŸ¦', 'PotPlayer', 'Windows å…¨èƒ½æ’­æ”¾å™¨', () => {
                    window.location.href = `potplayer://${currentNetworkUrl}`;
                }, 'Winé¦–é€‰'));
            }
            
            addGroup('å…¶ä»–');
            container.appendChild(createOption('ğŸ”—', 'å¤åˆ¶è§†é¢‘é“¾æ¥', 'æ‰‹åŠ¨ç²˜è´´åˆ°å…¶ä»–æ’­æ”¾å™¨æˆ–ä¸‹è½½å·¥å…·', () => {
                navigator.clipboard.writeText(currentNetworkUrl).then(() => {
                    showStatus('âœ… é“¾æ¥å·²å¤åˆ¶', 'success');
                    modalOverlay.classList.remove('modal-active');
                });
            }));
        }

        function setupMobileLongPress(player) {
            const container = player.container;
            let timer = null;
            container.addEventListener('touchstart', (e) => {
                if(e.touches.length > 1) return;
                timer = setTimeout(() => {
                    const stats = document.getElementById('custom-stats');
                    stats.style.display = stats.style.display === 'none' ? 'block' : 'none';
                    if(navigator.vibrate) navigator.vibrate(50);
                    showStatus(stats.style.display === 'block' ? 'ğŸ“Š ç»Ÿè®¡é¢æ¿å·²å¼€å¯' : 'ğŸ“Š ç»Ÿè®¡é¢æ¿å·²å…³é—­', 'info');
                }, 600); 
            }, {passive: true});
            const clear = () => { if(timer) clearTimeout(timer); };
            container.addEventListener('touchend', clear);
            container.addEventListener('touchmove', clear);
        }

        function stopStatsLoop() {
             if(statsTimer) clearInterval(statsTimer);
             statsTimer = null;
             document.getElementById('custom-stats').style.display = 'none';
        }

        function startStatsLoop(video, hls) {
            if(statsTimer) clearInterval(statsTimer);
            frameCount = 0; currentFPS = 0; lastFrameTime = performance.now();
            const frameCallback = (now) => {
                frameCount++;
                if (now - lastFrameTime >= 1000) { currentFPS = frameCount; frameCount = 0; lastFrameTime = now; }
                if(video.requestVideoFrameCallback) video.requestVideoFrameCallback(frameCallback);
            };
            if ('requestVideoFrameCallback' in video) video.requestVideoFrameCallback(frameCallback);

            const statsEl = document.getElementById('custom-stats');
            const updateStatsUI = () => {
                if(statsEl.style.display === 'none') return;
                let resolution = `${video.videoWidth} x ${video.videoHeight}`;
                let bitrate = 'N/A';
                if (hls && hls.levels) {
                    const level = hls.levels[hls.currentLevel === -1 ? hls.nextAutoLevel : hls.currentLevel];
                    if (level) {
                        if (level.width) resolution = `${level.width} x ${level.height}`;
                        if (level.bitrate) bitrate = (level.bitrate / 1000).toFixed(0) + ' kbps';
                    }
                }
                const buffer = video.buffered.length ? (video.buffered.end(video.buffered.length-1) - video.currentTime).toFixed(1) : 0;
                let displayFPS = video.paused ? 0 : currentFPS;
                statsEl.innerHTML = `
                    <div style="color:#00ccff;border-bottom:1px solid #555;margin-bottom:5px;">ğŸ“Š å®æ—¶ç›‘æ§ (DPlayer)</div>
                    <div>FPS: <span style="color:${displayFPS >= 50 ? '#00ccff' : '#fff'}">${displayFPS}</span></div>
                    <div>RES: ${resolution}</div>
                    <div>BIT: ${bitrate}</div>
                    <div>BUF: ${buffer} s</div>
                `;
            };
            statsTimer = setInterval(updateStatsUI, 500);
            updateStatsUI();
        }

        // --- æ¨¡å¼ B-1: Iframe è‡ªåŠ¨ç«é€Ÿè§£æ ---
        function loadIframeRaceMode(url) {
            currentMode = 'iframe_race';
            castBtn.disabled = true; 
            isSniffed = false;
            raceAborted = false;
            showStatus('è‡ªåŠ¨æ¨¡å¼ï¼šå…¨çº¿è·¯ç«é€Ÿè§£æä¸­...', 'info');
            loadingText.innerText = "æ­£åœ¨ç«é€Ÿè§£æ...";
            loadingTip.style.display = 'block';

            let hasWinner = false; 
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());

            apiArray.forEach(api => {
                if(raceAborted) return;
                const iframe = document.createElement('iframe');
                iframe.className = 'temp-iframe';
                iframe.allowFullscreen = true; 
                iframe.src = api.url + url;
                iframe.setAttribute('data-name', api.name);
                iframe.onload = function() {
                    if (isSniffed || hasWinner || raceAborted) return;
                    
                    // æ ‡è®°æ‰¾åˆ°èµ¢å®¶ï¼Œä½†æš‚ä¸æ˜¾ç¤ºï¼Œå°è¯•æ·±åº¦å—…æ¢
                    hasWinner = true;
                    handleWinner(this, api, url);
                };
                wrapper.appendChild(iframe);
            });
        }
        
        // --- æ¨¡å¼ B-2: æ‰‹åŠ¨å•çº¿è§£æ ---
        function loadSingleLineMode(url, index) {
            const api = apiArray[index];
            if(!api) return loadIframeRaceMode(url);

            currentMode = 'iframe_manual';
            castBtn.disabled = true;
            isSniffed = false;
            raceAborted = true; // åœæ­¢å¯èƒ½çš„åå°ç«é€Ÿ
            
            showStatus(`æ‰‹åŠ¨æ¨¡å¼ï¼šæ­£åœ¨åŠ è½½ [${api.name}] ...`, 'info');
            loadingText.innerText = `æ­£åœ¨è¿æ¥ ${api.name}...`;
            loadingTip.style.display = 'block';
            
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            
            const iframe = document.createElement('iframe');
            iframe.className = 'temp-iframe';
            iframe.allowFullscreen = true;
            iframe.src = api.url + url;
            iframe.onload = function() {
                if(isSniffed) return;
                loadingTip.style.display = 'none';
                iframe.classList.add('iframe-active');
                showStatus(`å·²åŠ è½½çº¿è·¯ï¼š${api.name} (æŠ•å±ä¸å¯ç”¨)`, 'info');
            };
            wrapper.appendChild(iframe);
        }

        // å¤„ç†ç«é€Ÿèµ¢å®¶ï¼šå°è¯•æå–M3U8ï¼Œæå–ä¸åˆ°åˆ™å›é€€
        async function handleWinner(iframe, api, videoUrl) {
            if (isSniffed || raceAborted) return;
            
            showStatus(`çº¿è·¯ ${api.name} å“åº”æœ€å¿«ï¼Œæ­£åœ¨å°è¯•æ·±åº¦æå–ç›´é“¾...`, 'info');
            
            // è®¾å®šä¸€ä¸ªçŸ­æš‚çš„è¶…æ—¶ï¼Œé˜²æ­¢ç”¨æˆ·ç­‰å¾…è¿‡ä¹…
            let sniffSuccess = false;
            const sniffTimeout = setTimeout(() => {
                if (!isSniffed && !raceAborted) {
                    console.log('æ·±åº¦å—…æ¢è¶…æ—¶ï¼Œå›é€€åˆ° Iframe æ’­æ”¾');
                    displayIframe(iframe, api.name);
                }
            }, 2500); // 2.5ç§’å†…æ²¡æå–å‡ºæ¥å°±æ”¾å¼ƒ

            try {
                // å°è¯•é’ˆå¯¹è¿™ä¸ªèµ¢å®¶æ¥å£è¿›è¡Œæ·±åº¦è¯·æ±‚
                const targetUrl = api.url + videoUrl;
                const deepUrl = await tryDeepSniff(targetUrl);
                
                if (deepUrl && !isSniffed && !raceAborted) {
                    clearTimeout(sniffTimeout);
                    sniffSuccess = true;
                    loadM3U8Mode(deepUrl, true);
                }
            } catch (e) {
                console.warn('æ·±åº¦æå–å¤±è´¥:', e);
            }
        }
        
        // å°è¯•æ·±åº¦å—…æ¢ (é’ˆå¯¹ç‰¹å®šURL)
        async function tryDeepSniff(targetUrl) {
            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 2000); // è¯·æ±‚æœ¬èº«2ç§’è¶…æ—¶
                
                const response = await fetch(targetUrl, { method: 'GET', signal: controller.signal });
                if (!response.ok) return null;
                
                const text = await response.text();
                
                // 1. å°è¯• JSON è§£æ
                try {
                    const json = JSON.parse(text);
                    if (json.url && json.url.includes('.m3u8')) return json.url;
                } catch (e) {}
                
                // 2. å°è¯•æ­£åˆ™åŒ¹é…
                const regex = /["'](https?:\/\/[^"']+\.m3u8[^"']*)["']/;
                const match = text.match(regex);
                if (match) return match[1];
                
                return null;
            } catch (e) {
                return null;
            }
        }

        function displayIframe(iframe, apiName) {
            if (isSniffed || raceAborted) return; 
            
            loadingTip.style.display = 'none';
            showStatus(`è§£ææˆåŠŸï¼å½“å‰çº¿è·¯: ${apiName} (æš‚æœªæå–åˆ°ç›´é“¾ï¼Œä¸æ”¯æŒæŠ•å±)`, 'info');
            
            document.getElementById('dplayer-container').style.display = 'none';
            
            // åªæ˜¾ç¤ºèµ¢å®¶ iframe
            document.querySelectorAll('.temp-iframe').forEach(el => {
                if (el !== iframe) { el.src = 'about:blank'; el.remove(); }
            });
            iframe.classList.add('iframe-active');
            
            const manualBtn = document.createElement('span');
            manualBtn.innerHTML = " [æˆ‘æœ‰M3U8åœ°å€]";
            manualBtn.style.cursor = 'pointer'; manualBtn.style.color = '#00ccff';
            manualBtn.onclick = () => {
                const manualUrl = prompt("è¯·è¾“å…¥ M3U8 åœ°å€ï¼š");
                if(manualUrl && manualUrl.includes('.m3u8')) {
                    input.value = manualUrl;
                    startPlay();
                }
            };
            statusDiv.appendChild(manualBtn);
        }

        // --- å…¨å±€å—…æ¢ (å¤‡ç”¨) ---
        // å³ä½¿åœ¨æ‰‹åŠ¨æ¨¡å¼ï¼Œåå°ä¹Ÿå°è¯•å—…æ¢ï¼Œå› ä¸ºM3U8ä½“éªŒæ›´å¥½
        function startGlobalSniffing(videoPageUrl) {
            console.log('å¯åŠ¨å…¨å±€å—…æ¢ä»»åŠ¡...');
            const regex = /["'](https?:\/\/[^"']+\.m3u8[^"']*)["']/;
            
            const msgHandler = (e) => {
                let foundUrl = null;
                if (e.data && typeof e.data === 'string') {
                    const match = e.data.match(regex);
                    if (match) foundUrl = match[1];
                } else if (e.data && e.data.type === 'video_url' && e.data.url) {
                    foundUrl = e.data.url;
                }

                if(foundUrl && !isSniffed) {
                    window.removeEventListener('message', msgHandler);
                    loadM3U8Mode(foundUrl, true);
                }
            };
            window.addEventListener('message', msgHandler);
            
            // éå†æ‰€æœ‰æ¥å£å°è¯• Fetch (å³ä½¿æ‰‹åŠ¨é€‰äº†çº¿è·¯ï¼Œåå°ä¹Ÿå¸®ä»–æ‰¾æ›´å¥½çš„ç›´é“¾)
            apiArray.forEach(async (api) => {
                if(isSniffed) return;
                try {
                    const found = await tryDeepSniff(api.url + videoPageUrl);
                    if(found && !isSniffed) {
                        loadM3U8Mode(found, true);
                    }
                } catch(e) {}
            });
        }

        // --- å·¥å…·å‡½æ•° ---
        function resetPlayer() {
            if (dp) { dp.destroy(); dp = null; }
            if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            stopStatsLoop();
            document.getElementById('dplayer-container').style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            clearStatus();
            isSniffed = false;
        }

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('status-message');
            el.textContent = msg;
            el.style.display = 'block';
            el.style.color = type === 'error' ? '#fca5a5' : (type === 'success' ? '#86efac' : '#7dd3fc');
            el.style.backgroundColor = type === 'error' ? 'rgba(220,38,38,0.2)' : (type === 'success' ? 'rgba(22,163,74,0.2)' : '#2a3f4d');
        }

        function clearStatus() { document.getElementById('status-message').style.display = 'none'; }
        
        function getUrlParameter(name) {
            const results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        if(getUrlParameter('url')) { setTimeout(startPlay, 500); }
    });
</script>

</body>
</html>





