<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨ (Pro)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“º</text></svg>">
    <style>
        :root {
            --primary-color: #00ccff;
            --bg-color: #1a1a1a;
            --panel-bg: #252525;
            --text-color: #e0e0e0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #app-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin: 10px 0 20px 0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.3);
        }
        /* æ§åˆ¶é¢æ¿ */
        #control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        #m3u8-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #444;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
            transition: border-color 0.3s;
        }
        #m3u8-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: #fff;
            white-space: nowrap;
            user-select: none;
        }
        #load-button { background-color: var(--primary-color); color: #000; }
        #load-button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        #load-button:active { transform: translateY(0); }
        
        #cast-button { background-color: #3b82f6; display: inline-flex; align-items: center; gap: 6px; }
        #cast-button:hover { filter: brightness(1.1); }
        #cast-button:disabled { background-color: #444; color: #888; cursor: not-allowed; }

        /* æ’­æ”¾å™¨åŒºåŸŸ */
        #video-wrapper {
            flex-grow: 1;
            width: 100%;
            position: relative;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            aspect-ratio: 16 / 9;
        }
        #dplayer-container {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0; z-index: 10;
        }
        #dplayer-container video { will-change: transform; }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        #custom-stats {
            position: absolute; top: 20px; left: 20px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
            color: #eee;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.5;
            z-index: 100;
            pointer-events: none;
            border-left: 3px solid var(--primary-color);
            backdrop-filter: blur(4px);
            font-family: 'SF Mono', Consolas, monospace;
            display: none;
        }

        /* ç«é€Ÿ Iframe */
        .temp-iframe {
            width: 100%; height: 100%; border: none;
            position: absolute; top: 0; left: 0;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s; z-index: 5;
            background: #000;
        }
        .iframe-active { z-index: 20; opacity: 1; pointer-events: auto; }

        /* çŠ¶æ€æç¤º */
        #status-message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 6px;
            background-color: #2a3f4d;
            color: #7dd3fc;
            font-size: 13px;
            display: none;
            border-left: 4px solid #3b82f6;
            animation: fadeIn 0.3s ease;
            white-space: pre-line;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* æŠ•å±æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-active { display: flex !important; opacity: 1 !important; }
        
        .cast-modal {
            background: var(--panel-bg);
            width: 90%; max-width: 420px;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            border: 1px solid #444;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-active .cast-modal { transform: scale(1); }

        .cast-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333;
        }
        .cast-title { font-size: 18px; font-weight: bold; color: #fff; }
        .cast-close { background: none; border: none; color: #888; font-size: 28px; cursor: pointer; line-height: 1; }
        .cast-close:hover { color: #fff; }
        
        .cast-group-title { font-size: 12px; color: #666; margin: 15px 0 8px 5px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .cast-option {
            display: flex; align-items: center; gap: 15px;
            padding: 14px;
            background: #333;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none; color: #fff;
        }
        .cast-option:hover { background: #444; transform: translateX(5px); }
        .cast-icon { font-size: 22px; width: 30px; text-align: center; }
        .cast-info { display: flex; flex-direction: column; }
        .cast-name { font-size: 15px; font-weight: 500; display: flex; align-items: center; }
        .cast-desc { font-size: 12px; color: #999; margin-top: 2px; }
        .tag-recommend { background: var(--primary-color); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px; font-weight: bold; }

        @media (max-width: 600px) {
            #app-container { padding: 10px; margin: 0; max-width: 100%; height: 100vh; }
            h1 { font-size: 1.2rem; margin: 5px 0 15px 0; }
            #video-wrapper { border-radius: 0; border: none; }
            .btn { flex: 1; padding: 12px; }
            #m3u8-input { width: 100%; }
            #control-panel { gap: 8px; }
        }
    </style>
    <!-- Google Cast -->
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                try {
                    if (window.cast && window.cast.framework) {
                        cast.framework.CastContext.getInstance().setOptions({
                            receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                            autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                        });
                    }
                } catch (e) { console.warn('GCast Init Skipped:', e); }
            }
        };
    </script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>

<div id="app-container">
    <h1>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨ <span style="font-size:0.6em;color:#666;vertical-align:middle;margin-left:5px">Pro</span></h1>
    
    <div id="control-panel">
        <input type="url" id="m3u8-input" placeholder="è¾“å…¥ M3U8 ç›´é“¾æˆ–è§†é¢‘é¡µé¢åœ°å€" value="">
        <button id="load-button" class="btn">âš¡ï¸ æ™ºèƒ½æ’­æ”¾</button>
        <button id="cast-button" class="btn">ğŸ“º æŠ•å±/DLNA</button>
    </div>

    <div id="status-message"></div>

    <div id="video-wrapper">
        <div id="loading-tip" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#888; display:none; z-index:1; text-align:center; width: 100%;">
            <div style="margin-bottom:10px; font-size: 24px;">ğŸ”„</div>
            <p id="loading-text">æ­£åœ¨ç«é€Ÿè§£æ...</p>
        </div>
        
        <div id="dplayer-container"></div>
        <div id="custom-stats"></div>
    </div>
</div>

<div id="cast-modal-overlay" class="modal-overlay">
    <div class="cast-modal">
        <div class="cast-header">
            <div class="cast-title">æŠ•å±ä¸å¤–éƒ¨æ’­æ”¾</div>
            <button class="cast-close" id="close-cast-modal">Ã—</button>
        </div>
        <div id="cast-options-container"></div>
    </div>
</div>

<script src="https://s4.zstatic.net/ajax/libs/hls.js/1.5.6/hls.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/dplayer/1.26.0/DPlayer.min.js"></script>

<script>
    // --- çº¿è·¯é…ç½® ---
    const apiArray = [
        { name: "é€šç”¨çº¿è·¯1", url: "https://www.ckplayer.vip/jiexi/?url=" },
        { name: "é€šç”¨çº¿è·¯2", url: "https://jx.m3u8.tv/jiexi/?url=" },
        { name: "é€šç”¨çº¿è·¯3", url: "https://jx.xmflv.com/?url=" },
        { name: "é€šç”¨çº¿è·¯4", url: "https://www.8090g.cn/jiexi/?url=" },
        { name: "JSONçº¿è·¯", url: "https://jx.2s0.cn/player/?url=", type: 'json' }
    ];

    // --- å…¨å±€çŠ¶æ€ ---
    let dp = null;
    let hlsInstance = null;
    let currentNetworkUrl = "";
    let isSniffed = false;
    let statsTimer = null;
    let statusTimeout = null;

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('m3u8-input');
        const loadBtn = document.getElementById('load-button');
        const castBtn = document.getElementById('cast-button');
        const modalOverlay = document.getElementById('cast-modal-overlay');
        const closeCastBtn = document.getElementById('close-cast-modal');

        // URL å‚æ•°è¯»å–
        const urlParam = new URLSearchParams(window.location.search).get('url');
        if (urlParam) {
            input.value = decodeURIComponent(urlParam);
            setTimeout(startPlay, 500);
        }

        // äº‹ä»¶ç»‘å®š
        loadBtn.onclick = startPlay;
        // ä¿®å¤è¾“å…¥æ¡†æ— æ³•ç¼–è¾‘çš„é—®é¢˜ï¼šæ”¹ç”¨ addEventListener
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') startPlay();
        });
        
        closeCastBtn.onclick = () => modalOverlay.classList.remove('modal-active');
        modalOverlay.onclick = (e) => e.target === modalOverlay && modalOverlay.classList.remove('modal-active');
        
        castBtn.onclick = () => {
            renderCastOptions();
            modalOverlay.classList.add('modal-active');
        };

        async function startPlay() {
            const url = input.value.trim();
            if (!url) return showStatus('è¯·è¾“å…¥è§†é¢‘åœ°å€', 'error');

            resetPlayer();
            currentNetworkUrl = url;
            isSniffed = false;

            // å¦‚æœæ˜¯ç›´æ¥çš„ m3u8 é“¾æ¥æˆ–æœ¬åœ° Blob
            if (url.match(/\.m3u8($|\?)/i) || url.startsWith('blob:') || url.startsWith('http://127.0.0.1')) {
                await loadM3U8Mode(url);
            } else {
                // å¦åˆ™è¿›å…¥ç½‘é¡µå—…æ¢æ¨¡å¼
                loadIframeMode(url);
                startGlobalSniffing(url);
            }
        }
    });

    // --- æ ¸å¿ƒé€»è¾‘ï¼šæ™ºèƒ½åŠ è½½ä¸æ¸…æ´— ---
    async function loadM3U8Mode(url, isAutoSniffed = false) {
        document.getElementById('cast-button').disabled = false;
        isSniffed = true; // æ ‡è®°å·²æ‰¾åˆ°èµ„æº

        if (isAutoSniffed) {
            currentNetworkUrl = url;
            showStatus('âœ… å—…æ¢æˆåŠŸï¼æ­£åœ¨æ·±åº¦è§£æç»“æ„...', 'success');
        } else {
            showStatus('æ­£åœ¨æ™ºèƒ½åˆ†ææ’­æ”¾åˆ—è¡¨...', 'info');
        }

        try {
            // é€’å½’è§£æ + æ¸…æ´—
            const result = await analyzeAndCleanM3u8(url);
            
            if (result.blobUrl) {
                if (result.cleaned) {
                    showStatus(`âœ… å‡€åŒ–æˆåŠŸ\nå·²ç§»é™¤ ${result.removedAdCount} ä¸ªå¹¿å‘Šåˆ†ç‰‡ï¼Œä¿ç•™ ${result.keptCount} ä¸ªçº¯å‡€åˆ†ç‰‡`, 'success', 10000); // 10ç§’åéšè—
                } else {
                    showStatus('âœ… æ’­æ”¾åˆ—è¡¨çº¯å‡€ï¼Œå‡†å¤‡æ’­æ”¾', 'success', 5000);
                }
                initDPlayer(result.blobUrl);
            } else {
                // æ— æ³•æ¸…æ´—ï¼ˆå¯èƒ½è·¨åŸŸæˆ–æ ¼å¼ä¸æ”¯æŒï¼‰ï¼Œç›´æ¥æ’­æ”¾åŸé“¾æ¥
                console.warn('æ¸…æ´—é€»è¾‘è¿”å›ç©ºï¼Œé™çº§ä½¿ç”¨åŸé“¾æ¥');
                showStatus('âš ï¸ æ— æ³•è¿›è¡Œæ·±åº¦å‡€åŒ–ï¼ˆå¯èƒ½å› ç›®æ ‡ç¦æ­¢è·¨åŸŸï¼‰ï¼Œå°†ç›´æ¥æ’­æ”¾åŸå§‹æµ', 'warning', 10000);
                initDPlayer(url);
            }
        } catch (e) {
            console.error('æ’­æ”¾å‡†å¤‡å¼‚å¸¸:', e);
            showStatus('âŒ è§£æä¸­æ–­ï¼Œå°è¯•ç›´æ¥æ’­æ”¾...', 'error');
            initDPlayer(url);
        }
    }

    // --- é€’å½’è§£æä¸å»å¹¿å‘Šæ ¸å¿ƒå‡½æ•° ---
    // è§£å†³åµŒå¥— m3u8 æ— æ³•å»å¹¿å‘Šçš„é—®é¢˜
    async function analyzeAndCleanM3u8(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Fetch error: ${response.status}`);
            
            // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ response.url ä½œä¸ºåŸºå‡† URLï¼Œè§£å†³é‡å®šå‘å¯¼è‡´çš„è·¯å¾„é”™è¯¯é—®é¢˜
            const finalUrl = response.url;
            const content = await response.text();
            
            // 1. æ£€æŸ¥æ˜¯å¦ä¸ºåµŒå¥—åˆ—è¡¨ (Master Playlist)
            if (content.includes('#EXT-X-STREAM-INF')) {
                showStatus('æ£€æµ‹åˆ°å¤šçº§åˆ—è¡¨ï¼Œæ­£åœ¨é€’å½’è§£ææœ€ä½³ç”»è´¨...', 'info');
                const lines = content.split('\n');
                let bestUrl = null;
                let maxBandwidth = 0;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.startsWith('#EXT-X-STREAM-INF')) {
                        // æå–å¸¦å®½ä¿¡æ¯
                        const bandwidthMatch = line.match(/BANDWIDTH=(\d+)/);
                        const bandwidth = bandwidthMatch ? parseInt(bandwidthMatch[1]) : 0;
                        
                        // è·å– URLï¼Œå¿…é¡»è·³è¿‡ç©ºè¡Œ
                        let urlIdx = i + 1;
                        while(urlIdx < lines.length && (lines[urlIdx].trim() === '' || lines[urlIdx].trim().startsWith('#'))) {
                            urlIdx++;
                        }
                        
                        if (urlIdx < lines.length) {
                            const subUrl = lines[urlIdx].trim();
                            if (subUrl) {
                                if (bandwidth > maxBandwidth || !bestUrl) {
                                    maxBandwidth = bandwidth;
                                    bestUrl = subUrl;
                                }
                            }
                        }
                    }
                }

                if (bestUrl) {
                    // è§£æç›¸å¯¹è·¯å¾„ (ä½¿ç”¨ finalUrl)
                    const absoluteSubUrl = new URL(bestUrl, finalUrl).href;
                    console.log(`[é€’å½’] å‘ç°å­æµï¼Œå¸¦å®½: ${maxBandwidth}, URL: ${absoluteSubUrl}`);
                    // é€’å½’è°ƒç”¨
                    return await analyzeAndCleanM3u8(absoluteSubUrl);
                }
            }

            // 2. å¦‚æœæ˜¯åª’ä½“æ’­æ”¾åˆ—è¡¨ (åŒ…å«åˆ‡ç‰‡)ï¼Œæ‰§è¡Œå»å¹¿å‘Šé€»è¾‘ (ä½¿ç”¨ finalUrl)
            return cleanAdSegments(content, finalUrl);

        } catch (e) {
            console.warn('æ·±åº¦è§£æå—é™ (é€šå¸¸æ˜¯CORSè·¨åŸŸé—®é¢˜):', e);
            // å¦‚æœ fetch å¤±è´¥ï¼ˆé€šå¸¸æ˜¯ CORSï¼‰ï¼Œè¿”å› nullï¼Œå¤–éƒ¨ä¼šé™çº§ä½¿ç”¨åŸ URL
            return { blobUrl: null };
        }
    }

    // --- åŒå±‚æ™ºèƒ½å»å¹¿å‘Šç®—æ³• ---
    // å±‚çº§1: åŸŸåè¿‡æ»¤ (Hostname Filter) - æ€æ‰è·¨åŸŸå¹¿å‘Š
    // å±‚çº§2: ç›®å½•æƒé‡è¿‡æ»¤ (Directory Weight Filter) - æ€æ‰åŒåŸŸåä¸‹çš„å¹¿å‘Šç›®å½•ï¼Œä½†ä¿ç•™åˆ†æ®µå­˜å‚¨çš„æ­£ç‰‡
    function cleanAdSegments(content, baseUrl) {
        const lines = content.split(/\r?\n/);
        const segments = [];
        
        // è¾…åŠ©ï¼šç»å¯¹è·¯å¾„è½¬æ¢
        const toAbsolute = (path) => {
            try { return new URL(path, baseUrl).href; } catch (e) { return path; }
        };

        // 1. æ”¶é›†æ‰€æœ‰åˆ†ç‰‡ä¿¡æ¯
        lines.forEach((line, idx) => {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('#')) return;
            try {
                const absUrl = toAbsolute(trimmed);
                const u = new URL(absUrl);
                // æå–ç›®å½•æŒ‡çº¹ (ä¸å«æ–‡ä»¶å)
                const pathDir = u.pathname.substring(0, u.pathname.lastIndexOf('/') + 1);
                
                segments.push({
                    idx,
                    absUrl,
                    hostname: u.hostname,
                    directory: pathDir
                });
            } catch (e) {}
        });

        const totalSegments = segments.length;
        if (totalSegments === 0) return { blobUrl: null, cleaned: false };

        // 2. åˆ†æä¸»åŸŸå (Dominant Hostname)
        const hostCounts = {};
        segments.forEach(s => { hostCounts[s.hostname] = (hostCounts[s.hostname] || 0) + 1; });
        
        let mainHost = '';
        let maxHostCount = 0;
        for(const [h, c] of Object.entries(hostCounts)) {
            if(c > maxHostCount) { maxHostCount = c; mainHost = h; }
        }

        // 3. åˆ†æä¸»ç›®å½• (Dominant Directory) - ä»…åœ¨ä¸»åŸŸåä¸‹åˆ†æ
        const dirCounts = {};
        const mainHostSegments = segments.filter(s => s.hostname === mainHost);
        
        mainHostSegments.forEach(s => {
            dirCounts[s.directory] = (dirCounts[s.directory] || 0) + 1;
        });

        let maxDirCount = 0;
        // æ‰¾å‡ºåŒ…å«åˆ†ç‰‡æœ€å¤šçš„é‚£ä¸ªç›®å½•çš„æ•°é‡
        for(const c of Object.values(dirCounts)) {
            if(c > maxDirCount) maxDirCount = c;
        }

        console.log(`[æ™ºèƒ½åˆ†æ] æ€»åˆ†ç‰‡:${totalSegments}, ä¸»åŸŸå:${mainHost}(${maxHostCount}), ä¸»ç›®å½•æœ€å¤§è®¡æ•°:${maxDirCount}`);

        // 4. æ ‡è®°éœ€è¦ç§»é™¤çš„è¡Œ
        const linesToRemove = new Set();
        let removedCount = 0;

        segments.forEach(seg => {
            let shouldRemove = false;

            // è§„åˆ™ A: åŸŸåä¸åŒ¹é… (è·¨åŸŸå¹¿å‘Š)
            if (seg.hostname !== mainHost) {
                shouldRemove = true;
            } 
            // è§„åˆ™ B: åŒåŸŸåï¼Œä½†ç›®å½•çœ‹èµ·æ¥åƒå¹¿å‘Š
            else {
                const myDirCount = dirCounts[seg.directory] || 0;
                // åˆ¤å®šé˜ˆå€¼ï¼šå¦‚æœè¯¥ç›®å½•ä¸‹çš„åˆ†ç‰‡æ•°é‡ < ä¸»ç›®å½•åˆ†ç‰‡æ•°é‡çš„ 20%ï¼Œä¸”æ•°é‡ç¡®å®å¾ˆå°‘(æ¯”å¦‚å°äº10ä¸ª)ï¼Œè§†ä¸ºå¹¿å‘Š
                // è¿™æ ·å¯ä»¥ä¿ç•™é‚£ç§ åˆ†æˆä¸¤ä¸ªå¤§ç›®å½•å­˜æ”¾çš„æ­£ç‰‡ (ä¾‹å¦‚ /part1/ æœ‰300ç‰‡, /part2/ æœ‰200ç‰‡ï¼Œéƒ½ä¸ä¼šè¢«åˆ )
                // ä½†èƒ½åˆ é™¤ /ad/ åªæœ‰ 3ç‰‡ çš„æƒ…å†µ
                const ratio = myDirCount / maxDirCount;
                if (ratio < 0.2 && myDirCount < 15) {
                    shouldRemove = true;
                    console.log(`[ç§»é™¤] ç–‘ä¼¼åŒåŸŸå¹¿å‘Šç›®å½•: ${seg.directory} (count: ${myDirCount})`);
                }
            }

            if (shouldRemove) {
                removedCount++;
                linesToRemove.add(seg.idx);
                // å›æº¯åˆ é™¤æ ‡ç­¾
                let j = seg.idx - 1;
                while (j >= 0) {
                    const l = lines[j].trim();
                    if (l.startsWith('#EXTINF') || l.startsWith('#EXT-X-BYTERANGE') || l.startsWith('#EXT-X-DISCONTINUITY')) {
                        linesToRemove.add(j);
                        j--;
                    } else {
                        break;
                    }
                }
            }
        });

        // 5. é‡ç»„å†…å®¹
        const newLines = [];
        lines.forEach((line, idx) => {
            if (linesToRemove.has(idx)) return;
            
            let l = line.trim();
            if (!l) return;

            if (l.startsWith('#')) {
                // ä¿®å¤ Key URI
                if (l.startsWith('#EXT-X-KEY') && l.includes('URI="')) {
                    l = l.replace(/URI="([^"]+)"/, (match, p1) => `URI="${toAbsolute(p1)}"`);
                }
                newLines.push(l);
            } else {
                newLines.push(toAbsolute(l));
            }
        });

        if (removedCount === 0) return { blobUrl: null, cleaned: false };

        const blob = new Blob([newLines.join('\n')], { type: 'application/vnd.apple.mpegurl' });
        return { 
            blobUrl: URL.createObjectURL(blob), 
            cleaned: true, 
            removedAdCount: removedCount,
            keptCount: totalSegments - removedCount
        };
    }

    // --- æ’­æ”¾å™¨æ§åˆ¶ ---
    function initDPlayer(videoUrl) {
        if (dp) dp.destroy();
        stopStatsLoop();
        
        const container = document.getElementById('dplayer-container');
        container.style.display = 'block';
        document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
        document.getElementById('loading-tip').style.display = 'none';

        dp = new DPlayer({
            container: container,
            autoplay: true,
            theme: '#00ccff',
            lang: 'zh-cn',
            screenshot: true,
            video: {
                url: videoUrl,
                type: 'customHls',
                customType: {
                    customHls: function(video, player) {
                        if (Hls.isSupported()) {
                            if (hlsInstance) hlsInstance.destroy();
                            hlsInstance = new Hls({
                                debug: false,
                                enableWorker: true,
                                lowLatencyMode: true,
                            });
                            hlsInstance.loadSource(videoUrl);
                            hlsInstance.attachMedia(video);
                            hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                                video.play().catch(() => showStatus('è‡ªåŠ¨æ’­æ”¾å—é˜»ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾', 'info'));
                                startStatsLoop(video, hlsInstance);
                            });
                            hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                                if (data.fatal) {
                                    switch (data.type) {
                                        case Hls.ErrorTypes.NETWORK_ERROR: hlsInstance.startLoad(); break;
                                        case Hls.ErrorTypes.MEDIA_ERROR: hlsInstance.recoverMediaError(); break;
                                        default: hlsInstance.destroy(); break;
                                    }
                                }
                            });
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = videoUrl;
                            video.play();
                            startStatsLoop(video, null);
                        }
                    }
                }
            },
            contextmenu: [{
                text: 'æ€§èƒ½ç»Ÿè®¡é¢æ¿',
                click: () => toggleStats()
            }]
        });

        // ç§»åŠ¨ç«¯é•¿æŒ‰å‘¼å‡ºç»Ÿè®¡
        let pressTimer;
        container.addEventListener('touchstart', () => {
            pressTimer = setTimeout(toggleStats, 800);
        }, {passive: true});
        container.addEventListener('touchend', () => clearTimeout(pressTimer));
        container.addEventListener('touchmove', () => clearTimeout(pressTimer));
    }

    // --- ç½‘é¡µæ¨¡å¼ (Iframe ç«é€Ÿ) ---
    function loadIframeMode(url) {
        document.getElementById('cast-button').disabled = true;
        document.getElementById('loading-tip').style.display = 'block';
        document.getElementById('loading-text').innerText = 'æ­£åœ¨å¤šçº¿è·¯ç«é€Ÿè§£æ...';
        
        let hasWinner = false;
        
        apiArray.forEach(api => {
            const iframe = document.createElement('iframe');
            iframe.className = 'temp-iframe';
            iframe.src = api.url + url;
            iframe.onload = function() {
                if (isSniffed || hasWinner) return;
                hasWinner = true;
                
                // ç«é€Ÿèµ¢å®¶ï¼Œå°è¯•å—…æ¢å…¶ç›´é“¾
                setTimeout(() => {
                    if(!isSniffed) {
                         // æ²¡å—…æ¢åˆ°ç›´é“¾ï¼Œä½† iframe åŠ è½½å¥½äº†ï¼Œæ˜¾ç¤º iframe
                         document.getElementById('loading-tip').style.display = 'none';
                         document.getElementById('dplayer-container').style.display = 'none';
                         document.querySelectorAll('.temp-iframe').forEach(el => {
                             if(el !== iframe) { el.src = 'about:blank'; el.remove(); }
                         });
                         iframe.classList.add('iframe-active');
                         showStatus(`å·²åˆ‡æ¢è‡³çº¿è·¯: ${api.name}`, 'info');
                    }
                }, 2000);
            };
            document.getElementById('video-wrapper').appendChild(iframe);
        });
    }

    // å…¨å±€å—…æ¢é€»è¾‘ (é…åˆ iframe æ¨¡å¼)
    function startGlobalSniffing(pageUrl) {
        // 1. ç›‘å¬ Message
        const msgHandler = (e) => {
            let found = null;
            if (typeof e.data === 'string' && e.data.includes('.m3u8')) found = e.data.match(/https?:\/\/[^"']+\.m3u8/)[0];
            if (e.data?.type === 'video_url') found = e.data.url;
            
            if (found && !isSniffed) {
                window.removeEventListener('message', msgHandler);
                loadM3U8Mode(found, true);
            }
        };
        window.addEventListener('message', msgHandler);

        // 2. åå°è¯·æ±‚å°è¯• (æ¨¡æ‹Ÿå—…æ¢)
        apiArray.forEach(async api => {
            if(isSniffed) return;
            try {
                if(api.type === 'json') {
                    const res = await fetch(api.url + pageUrl).then(r => r.json());
                    if(res.url && !isSniffed) loadM3U8Mode(res.url, true);
                }
            } catch(e) {}
        });
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---
    function resetPlayer() {
        if (dp) { dp.destroy(); dp = null; }
        if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
        stopStatsLoop();
        document.getElementById('dplayer-container').style.display = 'block';
        document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
        document.getElementById('status-message').style.display = 'none';
    }

    // ä¿®æ”¹ï¼šå¢åŠ  duration å‚æ•°
    function showStatus(msg, type, duration = 0) {
        const el = document.getElementById('status-message');
        el.innerText = msg;
        el.style.display = 'block';
        el.style.borderColor = type === 'error' ? '#ef4444' : (type === 'success' ? '#22c55e' : '#3b82f6');
        el.style.color = type === 'error' ? '#fca5a5' : (type === 'success' ? '#86efac' : '#7dd3fc');
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (statusTimeout) {
            clearTimeout(statusTimeout);
            statusTimeout = null;
        }

        // å¦‚æœè®¾ç½®äº†è‡ªåŠ¨æ¶ˆå¤±æ—¶é—´
        if (duration > 0) {
            statusTimeout = setTimeout(() => {
                el.style.display = 'none';
            }, duration);
        }
    }

    function renderCastOptions() {
        const container = document.getElementById('cast-options-container');
        container.innerHTML = '';
        
        const createOpt = (icon, title, desc, fn, tag) => {
            const div = document.createElement('div');
            div.className = 'cast-option';
            div.innerHTML = `<div class="cast-icon">${icon}</div><div class="cast-info"><div class="cast-name">${title} ${tag?`<span class="tag-recommend">${tag}</span>`:''}</div><div class="cast-desc">${desc}</div></div>`;
            div.onclick = fn;
            return div;
        };

        const title = (t) => {
            const d = document.createElement('div'); d.className = 'cast-group-title'; d.innerText = t;
            return d;
        }

        container.appendChild(title('æ— çº¿æŠ•å±'));
        // Google Cast
        if (window.chrome) {
            container.appendChild(createOpt('ğŸ“¡', 'Google Cast', 'Chromecast / Android TV', () => {
                if (window.cast && window.cast.framework) {
                    const session = cast.framework.CastContext.getInstance().getCurrentSession();
                    const mediaInfo = new chrome.cast.media.MediaInfo(currentNetworkUrl, 'application/x-mpegurl');
                    const req = new chrome.cast.media.LoadRequest(mediaInfo);
                    if(!session) cast.framework.CastContext.getInstance().requestSession().then(() => cast.framework.CastContext.getInstance().getCurrentSession().loadMedia(req));
                    else session.loadMedia(req);
                } else showStatus('Cast æœåŠ¡æœªå°±ç»ª', 'error');
            }));
        }
        // AirPlay
        container.appendChild(createOpt('ğŸ', 'AirPlay', 'Apple TV / Mac (ä»…Safariå¯ç”¨)', () => {
             const v = document.querySelector('video');
             if(v && v.webkitShowPlaybackTargetPicker) v.webkitShowPlaybackTargetPicker();
             else showStatus('è¯·åœ¨æ’­æ”¾å™¨æ ç‚¹å‡» AirPlay å›¾æ ‡', 'info');
        }));

        container.appendChild(title('æœ¬åœ°åº”ç”¨ / DLNA'));
        const encoded = encodeURIComponent(currentNetworkUrl);
        container.appendChild(createOpt('ğŸš€', 'Web Video Caster', 'æ¨è: æŠ•å±åˆ°ä»»æ„ç”µè§† (DLNA)', () => window.location.href = `wvc-x-callback://open?url=${encoded}`));
        container.appendChild(createOpt('ğŸŸ ', 'VLC æ’­æ”¾å™¨', 'å¼ºå¤§è§£ç èƒ½åŠ›', () => window.location.href = `vlc://${currentNetworkUrl}`));
        container.appendChild(createOpt('ğŸŸ¦', 'PotPlayer', 'Windows é¦–é€‰', () => window.location.href = `potplayer://${currentNetworkUrl}`));
        container.appendChild(createOpt('ğŸ”—', 'å¤åˆ¶é“¾æ¥', 'å¤åˆ¶ç›´é“¾æ‰‹åŠ¨ä½¿ç”¨', () => {
            navigator.clipboard.writeText(currentNetworkUrl).then(() => showStatus('é“¾æ¥å·²å¤åˆ¶', 'success'));
        }));
    }

    // --- ç»Ÿè®¡é¢æ¿ ---
    function toggleStats() {
        const el = document.getElementById('custom-stats');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function stopStatsLoop() {
        if(statsTimer) {
            clearInterval(statsTimer);
            statsTimer = null;
        }
        document.getElementById('custom-stats').style.display = 'none';
    }

    // ä¿®å¤ï¼šFPS å’Œç ç‡è®¡ç®—é€»è¾‘
    function startStatsLoop(video, hls) {
        if(statsTimer) clearInterval(statsTimer);
        const el = document.getElementById('custom-stats');
        
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let currentFps = 0;

        // ä½¿ç”¨ requestVideoFrameCallback è·å–ç²¾ç¡® FPS
        const onFrame = (now, metadata) => {
            if (!video || video.paused || video.ended) return; // æ’­æ”¾åœæ­¢æ—¶ä¸è®¡æ•°
            
            frameCount++;
            // é‡æ–°æ³¨å†Œ
            if (video.requestVideoFrameCallback) {
                video.requestVideoFrameCallback(onFrame);
            }
        };

        if (video.requestVideoFrameCallback) {
            video.requestVideoFrameCallback(onFrame);
        }

        const loop = () => {
            // è®¡ç®— FPS
            const now = performance.now();
            const delta = now - lastFrameTime;
            if (delta >= 1000) {
                // å¦‚æœä½¿ç”¨ rVFC
                if (video.requestVideoFrameCallback) {
                    currentFps = Math.round((frameCount / delta) * 1000);
                } else {
                    currentFps = 0; // ç®€åŒ–å¤„ç†
                }
                frameCount = 0;
                lastFrameTime = now;
            }

            if(el.style.display !== 'none') {
                let info = `FPS: ${currentFps}<br>Res: ${video.videoWidth}x${video.videoHeight}`;
                
                // ä¿®å¤ï¼šä¼˜åŒ–ç ç‡è·å–é€»è¾‘ï¼Œå¢åŠ  bandwidthEstimate å…œåº•
                let bitrateStr = 'Auto';
                if(hls && hls.levels) {
                    // 1. å°è¯•è·å– loadLevel (æ­£åœ¨ä¸‹è½½çš„åˆ†ç‰‡ç­‰çº§)
                    let lvlIdx = hls.loadLevel;
                    // 2. å¦‚æœ loadLevel ä¸º -1 (ç¼“å†²å®Œæˆæˆ–åˆå§‹), å°è¯• nextLoadLevel
                    if (lvlIdx === -1) lvlIdx = hls.nextLoadLevel;
                    // 3. å¦‚æœåªæœ‰ä¸€ä¸ª levelï¼Œé‚£è‚¯å®šå°±æ˜¯å®ƒ
                    if (lvlIdx === -1 && hls.levels.length === 1) lvlIdx = 0;

                    if (lvlIdx > -1 && hls.levels[lvlIdx]) {
                        const bitrate = hls.levels[lvlIdx].bitrate;
                        if(bitrate) {
                            bitrateStr = (bitrate/1000).toFixed(0) + ' kbps';
                        }
                    }
                }
                
                // å¦‚æœä¸Šè¿°é€»è¾‘æ²¡è·å–åˆ°ï¼ˆä¾‹å¦‚ m3u8 ä¸­æ²¡æœ‰ bandwidth ä¿¡æ¯ï¼‰ï¼Œä½¿ç”¨ hls å†…éƒ¨ä¼°ç®—å€¼
                if ((bitrateStr === 'Auto' || bitrateStr === '0 kbps') && hls && hls.bandwidthEstimate) {
                    bitrateStr = (hls.bandwidthEstimate / 1000).toFixed(0) + ' kbps (Est.)';
                }

                info += `<br>Bitrate: ${bitrateStr}`;
                
                const buf = video.buffered.length ? (video.buffered.end(video.buffered.length-1) - video.currentTime).toFixed(1) : 0;
                info += `<br>Buffer: ${buf}s`;
                el.innerHTML = info;
            }
        };
        
        // ç•Œé¢åˆ·æ–°é¢‘ç‡
        statsTimer = setInterval(loop, 1000);
    }
</script>
</body>
</html>
