<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 æ’­æ”¾å™¨ (è‡ªå®šä¹‰åŠ è½½å™¨è¿‡æ»¤)</title>
    <style>
        /* åŸºç¡€æ ·å¼å’Œå¸ƒå±€ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        #app-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        #control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }

        #m3u8-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }

        #load-button {
            padding: 12px 25px;
            background-color: #2c3e50; 
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #load-button:hover { background-color: #34495e; }

        /* æ’­æ”¾å™¨åŒºåŸŸ */
        #video-container {
            width: 100%;
            aspect-ratio: 16 / 9; 
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #video {
            width: 100%;
            height: 100%;
        }
        
        /* çŠ¶æ€æç¤º */
        #status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #d9edf7;
            color: #31708f;
            font-weight: bold;
            display: none;
        }

        /* è°ƒè¯•ä¿¡æ¯ (å®æ—¶æ˜¾ç¤ºç¼“å­˜å’Œç ç‡) */
        #debug-info {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            z-index: 10;
        }
        /* åª’ä½“æŸ¥è¯¢ä¿æŒä¸å˜ */
        @media (max-width: 600px) {
            #control-panel { flex-direction: column; gap: 10px; }
            #m3u8-input, #load-button { width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<div id="app-container">
    
    <h1>M3U8 æ’­æ”¾å™¨ (è‡ªå®šä¹‰åŠ è½½å™¨è¿‡æ»¤)</h1>
    <p style="text-align: center; color: #777;">
        å·²é‡‡ç”¨**è‡ªå®šä¹‰åŠ è½½å™¨**çš„æœ€ç»ˆè¿‡æ»¤ç­–ç•¥ï¼Œåœ¨ M3U8 æ–‡ä»¶è§£æå‰åŒæ­¥åˆ é™¤å¹¿å‘Šå—ã€‚è¯·æ‰“å¼€ **æ§åˆ¶å° (F12)** è§‚å¯Ÿæ¸…ç†æ—¥å¿—ã€‚
    </p>

    <div id="control-panel">
        <input 
            type="url" 
            id="m3u8-input" 
            placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„ M3U8 æ’­æ”¾åœ°å€ï¼Œæˆ–é€šè¿‡ ?url= å‚æ•°åŠ è½½"
            value="YOUR_M3U8_URL_HERE"
        >
        <button id="load-button">
            âš¡ï¸ å¼€å§‹æ’­æ”¾
        </button>
    </div>
    
    <div id="status-message"></div>

    <div id="video-container">
        <video id="video" controls></video>
        <div id="debug-info"></div> </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const input = document.getElementById('m3u8-input');
        const button = document.getElementById('load-button');
        const statusDiv = document.getElementById('status-message');
        const debugDiv = document.getElementById('debug-info');
        
        let adFragmentsSkipped = 0; 

        input.value = input.value === 'YOUR_M3U8_URL_HERE' ? '' : input.value;

        // --- å·¥å…·å‡½æ•° ---
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = isError ? '#f2dede' : '#d9edf7';
            statusDiv.style.color = isError ? '#a94442' : '#31708f';
        }
        
        function clearStatus() {
            statusDiv.style.display = 'none';
        }

        // **æ ¸å¿ƒï¼šæå–å†…å®¹ç­¾å (Content Signature)**
        function getContentSignature(m3u8Url) {
            try {
                const path = new URL(m3u8Url).pathname;
                const signatureRegex = /([a-zA-Z0-9]{8,})\/\d+kb/; 
                const match = path.match(signatureRegex);
                const signature = match ? match[1] : ''; 
                console.log(`[Signature Check] æå– M3U8 æµID: ${signature}`);
                return signature;
            } catch (e) {
                console.error("[Signature Check] æå– M3U8 æµIDå¤±è´¥:", e);
                return '';
            }
        }

        function updateDebugInfo(hls) {
            if (!hls || !hls.currentLevel || !hls.levels[hls.currentLevel]) return;
            const buffer = video.buffered.length > 0 ? (video.buffered.end(0) - video.currentTime).toFixed(1) : '0.0';
            const currentLevel = hls.levels[hls.currentLevel];
            let info = `ç¼“å­˜: ${buffer}s | `;
            info += `ç ç‡: ${(currentLevel.bitrate / 1000).toFixed(0)} kbps | `;
            info += `å¹¿å‘Šè·³è¿‡: ${adFragmentsSkipped}`; 
            debugDiv.textContent = info;
        }

        // --- è‡ªå®šä¹‰ M3U8 åŠ è½½å™¨ (Custom Manifest Loader) ---
        class CustomManifestLoader {
            constructor(config) {
                this.config = config;
                this.hls = null;
                this.loader = null;
                this.contentSignature = '';
            }

            // hls.js è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥è®¾ç½®åŠ è½½å™¨
            setup(hls) {
                this.hls = hls;
            }
            
            // hls.js è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥å¼€å§‹åŠ è½½
            load(context, config, callbacks) {
                // ä»…å¤„ç† MASTER æˆ– LEVEL æ¸…å•
                if (context.type !== 'manifest' || !this.contentSignature) {
                    // å¦‚æœæ˜¯å…¶ä»–ç±»å‹çš„åŠ è½½ï¼Œæˆ–è€…ç­¾åæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤åŠ è½½é€»è¾‘
                    const DefaultLoader = this.hls.config.loader;
                    this.loader = new DefaultLoader(config);
                    this.loader.load(context, config, callbacks);
                    return;
                }

                this.callbacks = callbacks;
                this.context = context;

                // 1. ä½¿ç”¨ Fetch API è·å– M3U8 æ–‡ä»¶å†…å®¹
                fetch(context.url, { cache: 'no-cache' }) // ç¦ç”¨ç¼“å­˜
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.text();
                    })
                    .then(manifestText => {
                        // 2. åœ¨è§£æå‰åŒæ­¥è¿›è¡Œæ¸…ç†
                        const cleanedText = this.cleanManifest(manifestText, this.contentSignature);

                        // 3. æ„é€  hls.js æœŸæœ›çš„å“åº”å¯¹è±¡
                        const data = {
                            url: context.url,
                            data: cleanedText,
                            responseURL: context.url,
                            response: { url: context.url, code: 200, data: cleanedText },
                            type: context.type,
                            level: context.level
                        };

                        // 4. é€šçŸ¥ hls.js åŠ è½½æˆåŠŸ
                        this.callbacks.onSuccess(data, context, cleanedText);

                    })
                    .catch(error => {
                        console.error('[Custom Loader] M3U8 åŠ è½½æˆ–æ¸…ç†å¤±è´¥:', error);
                        // é€šçŸ¥ hls.js å¤±è´¥
                        const errorData = {
                            code: 0,
                            text: error.message,
                            context: context
                        };
                        this.callbacks.onError(errorData, context);
                    });
            }

            // M3U8 æ¸…ç†é€»è¾‘ (ä¸ä¸Šä¸€ä¸ªç‰ˆæœ¬ç›¸åŒï¼Œä½†ç°åœ¨åœ¨åŠ è½½å™¨å†…éƒ¨æ‰§è¡Œ)
            cleanManifest(manifestText, contentSignature) {
                let lines = manifestText.split('\n');
                let cleanedLines = [];
                let fragmentsRemoved = 0;
                let currentFragmentLines = []; 
                
                // éå†æ‰€æœ‰è¡Œï¼Œå°† M3U8 åˆ†å‰²æˆç‰‡æ®µå—
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const trimmedLine = line.trim();

                    // é€»è¾‘ï¼šé‡åˆ° EXTINF æˆ– EXT-X-KEY å¼€å§‹æ–°ç‰‡æ®µå—ã€‚
                    // å½“é‡åˆ°ä¸‹ä¸€ä¸ª EXTINF æ—¶ï¼Œå¤„ç†ä¸Šä¸€ä¸ªå—ã€‚
                    if (trimmedLine.startsWith('#EXTINF:') && currentFragmentLines.length > 0) {
                        
                        // --- å¤„ç†ä¸Šä¸€ä¸ªç‰‡æ®µå— ---
                        let hasSignature = currentFragmentLines.some(l => l.includes(contentSignature));
                        
                        if (hasSignature) {
                            cleanedLines.push(...currentFragmentLines);
                        } else {
                            fragmentsRemoved++;
                            // æ‰“å°è¢«åˆ é™¤å—çš„é¦–è¡Œå†…å®¹ï¼ˆæ’é™¤ç©ºè¡Œå’Œæ³¨é‡Šï¼‰
                            const firstContentLine = currentFragmentLines.find(l => l.trim().length > 0 && !l.trim().startsWith('#'));
                            console.warn(`[MANIFEST CLEANER] ğŸ›‘ ç§»é™¤å¹¿å‘Šå— (${fragmentsRemoved})ï¼Œé¦–ç‰‡æ®µ: ${firstContentLine ? firstContentLine.substring(0, 50) + '...' : 'N/A'}`);
                        }

                        // æ¸…ç©ºå¹¶å¼€å§‹æ”¶é›†æ–°çš„ç‰‡æ®µå—
                        currentFragmentLines = [];
                    } 
                    
                    // ç¡®ä¿æ–‡ä»¶å¤´ï¼ˆ#EXTM3U, VERSION, TARGETDURATION, MEDIA-SEQUENCEï¼‰ç­‰ä¿ç•™åœ¨å¤´éƒ¨
                    if (trimmedLine.startsWith('#EXTM3U') || trimmedLine.startsWith('#EXT-X-VERSION') || 
                        trimmedLine.startsWith('#EXT-X-TARGETDURATION') || trimmedLine.startsWith('#EXT-X-MEDIA-SEQUENCE')) 
                    {
                        cleanedLines.push(line);
                        currentFragmentLines = [];
                        continue;
                    }
                    
                    // å¦åˆ™ï¼Œå°†å½“å‰è¡Œæ·»åŠ åˆ°å½“å‰ç‰‡æ®µå—
                    currentFragmentLines.push(line); 
                }

                // å¤„ç†æ–‡ä»¶æœ«å°¾çš„æœ€åä¸€ä¸ªç‰‡æ®µå—
                if (currentFragmentLines.length > 0) {
                    let hasSignature = currentFragmentLines.some(l => l.includes(contentSignature));
                    if (hasSignature) {
                        cleanedLines.push(...currentFragmentLines);
                    } else {
                        fragmentsRemoved++;
                        console.warn(`[MANIFEST CLEANER] ğŸ›‘ ç§»é™¤æœ«å°¾å¹¿å‘Šå—ã€‚`);
                    }
                }
                
                // ç§»é™¤è¿ç»­é‡å¤çš„ #EXT-X-DISCONTINUITY
                const finalLines = [];
                let lastLineWasDiscontinuity = false;
                for (const line of cleanedLines) {
                    const trimmed = line.trim();
                    if (trimmed === '#EXT-X-DISCONTINUITY') {
                        if (!lastLineWasDiscontinuity) {
                            finalLines.push(line);
                        }
                        lastLineWasDiscontinuity = true;
                    } else {
                        finalLines.push(line);
                        lastLineWasDiscontinuity = false;
                    }
                }

                adFragmentsSkipped += fragmentsRemoved; // æ›´æ–°å…¨å±€è·³è¿‡è®¡æ•°
                return finalLines.join('\n');
            }

            // å¿…é¡»å®ç°çš„ abort() å’Œ destroy() æ–¹æ³•
            abort() { if (this.loader) this.loader.abort(); }
            destroy() { if (this.loader) this.loader.destroy(); this.loader = null; }
        }

        // --- HLS æ’­æ”¾å™¨æ ¸å¿ƒé€»è¾‘ ---
        function loadM3U8(url) {
            if (!url) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„ M3U8 åœ°å€ï¼', true);
                return;
            }
            
            clearStatus();
            adFragmentsSkipped = 0;
            
            // æ¸…ç†æ—§å®ä¾‹
            if (window.hlsInstance) {
                window.hlsInstance.destroy();
            }
            if (window.debugTimer) {
                clearInterval(window.debugTimer);
            }

            if (Hls.isSupported()) {
                
                const contentSignature = getContentSignature(url);
                
                const customLoaderInstance = new CustomManifestLoader({});
                customLoaderInstance.contentSignature = contentSignature; // ä¼ é€’ç­¾åç»™åŠ è½½å™¨

                // 1. é…ç½® hls.js ä½¿ç”¨è‡ªå®šä¹‰åŠ è½½å™¨
                const hlsConfig = {
                    startBufferLength: 8,       
                    maxBufferLength: 60,        
                    maxBufferSize: 100 * 1024 * 1024, 
                    autoLevelEnabled: true,     
                    fragLoadingTimeOut: 15000,  
                    manifestLoader: CustomManifestLoader, // ä½¿ç”¨ CustomManifestLoader
                };

                const hls = new Hls(hlsConfig);
                window.hlsInstance = hls;
                
                showStatus('æ­£åœ¨åŠ è½½æµï¼Œé€šè¿‡è‡ªå®šä¹‰åŠ è½½å™¨è¿›è¡Œ M3U8 æ¸…ç†...');


                hls.loadSource(url);
                hls.attachMedia(video);

                // 2. äº‹ä»¶ç›‘å¬
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    const levelCount = hls.levels.length; 
                    const clarityMessage = levelCount > 1 ? 
                        `å·²å¼ºåˆ¶é€‰æ‹©æœ€ä½æ¸…æ™°åº¦ (Level 0/${levelCount - 1}) æ’­æ”¾` : 
                        'è§†é¢‘ä¸ºå•ç ç‡æµ';
                    
                    showStatus(`åŠ è½½æˆåŠŸï¼${clarityMessage}ã€‚M3U8 æ¸…å•å·²æ¸…ç†å¹¶ç§»é™¤äº† ${adFragmentsSkipped} ä¸ªå¹¿å‘Šç‰‡æ®µå—ã€‚`);
                    
                    video.play().catch(error => {
                        showStatus("æ³¨æ„ï¼šæµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®ã€‚", false);
                    });
                    
                    window.debugTimer = setInterval(() => updateDebugInfo(hls), 1000);
                });
                
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                       console.error(`[HLS Error] è‡´å‘½é”™è¯¯: ${data.type}/${data.details}`, data);
                       // è‡´å‘½é”™è¯¯å¤„ç†...
                    } else {
                        console.warn(`[HLS Error] éè‡´å‘½é”™è¯¯: ${data.type}/${data.details}`);
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // åŸç”Ÿæ”¯æŒ (Safari/iOS)
                video.src = url;
                showStatus('æµè§ˆå™¨åŸç”Ÿæ”¯æŒ HLSï¼Œç›´æ¥åŠ è½½...');
                video.addEventListener('loadedmetadata', function() {
                    video.play();
                });
            } else {
                showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HLS æ’­æ”¾ï¼', true);
            }
        }
        
        // --- åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š ---
        
        const urlParam = getUrlParameter('url');
        let initialUrl = input.value.trim();

        if (urlParam) {
            initialUrl = urlParam;
            input.value = initialUrl;
        } else {
            initialUrl = initialUrl === 'YOUR_M3U8_URL_HERE' ? '' : initialUrl;
        }

        // ç»‘å®šæŒ‰é’®å’Œå›è½¦äº‹ä»¶
        button.addEventListener('click', () => {
            loadM3U8(input.value.trim());
        });

        input.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                loadM3U8(input.value.trim());
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½
        if (initialUrl) {
            loadM3U8(initialUrl);
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (window.debugTimer) {
                clearInterval(window.debugTimer);
            }
            if (window.hlsInstance) {
                window.hlsInstance.destroy();
            }
        });
    });
</script>

</body>
</html>
