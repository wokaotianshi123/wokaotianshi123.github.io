<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 专用去广告播放器</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f0f2f5; color: #333; }
        #container { max-width: 900px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a73e8; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        button { padding: 10px 25px; background: #1a73e8; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #1557b0; }
        #video-wrapper { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; border-radius: 8px; overflow: hidden; }
        video { width: 100%; height: 100%; }
        #log { margin-top: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #eee; font-family: monospace; font-size: 12px; height: 100px; overflow-y: auto; color: #555; }
        .log-success { color: green; }
        .log-warn { color: orange; }
        .log-error { color: red; }
        .tag { display: inline-block; padding: 2px 6px; background: #e8f0fe; color: #1a73e8; border-radius: 4px; font-size: 12px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="container">
    <h2>M3U8 专用去广告播放器</h2>
    <div style="text-align: center;"><span class="tag">针对 thm3u8.com 结构优化</span></div>
    
    <div class="input-group">
        <input type="text" id="urlInput" placeholder="在此粘贴 M3U8 地址" value="">
        <button onclick="startPlay()">播放并净化</button>
    </div>

    <div id="video-wrapper">
        <video id="video" controls></video>
    </div>

    <div id="log">准备就绪...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    const video = document.getElementById('video');
    const logDiv = document.getElementById('log');
    let hls = null;

    // 日志辅助函数
    function log(msg, type = '') {
        const p = document.createElement('div');
        p.textContent = `> ${msg}`;
        if (type) p.className = `log-${type}`;
        logDiv.prepend(p);
    }

    // 1. 从 URL 中提取核心 ID (例如 GsUnW9HR)
    function extractStreamID(url) {
        try {
            const path = new URL(url).pathname;
            // 匹配结构: /日期/ID/码率/
            const match = path.match(/\/([a-zA-Z0-9]{8,})\//);
            return match ? match[1] : null;
        } catch (e) {
            return null;
        }
    }

    // 2. 自定义加载器：拦截网络请求，修改 M3U8 内容
    class PLoader extends Hls.DefaultConfig.loader {
        constructor(config) {
            super(config);
            const load = this.load.bind(this);
            
            this.load = function(context, config, callbacks) {
                // 仅拦截 M3U8 播放列表请求
                if (context.type === 'manifest' || context.type === 'level') {
                    const streamID = window.TARGET_STREAM_ID;
                    
                    if (!streamID) {
                        load(context, config, callbacks);
                        return;
                    }

                    log(`正在请求并净化: ${context.url}`);
                    
                    // 使用 fetch 手动下载
                    fetch(context.url)
                        .then(res => {
                            if (!res.ok) throw new Error(res.statusText);
                            return res.text();
                        })
                        .then(text => {
                            // **核心净化逻辑**
                            const lines = text.split('\n');
                            let output = [];
                            let removedCount = 0;
                            let buffer = []; // 暂存 EXTINF 等标签

                            for (let i = 0; i < lines.length; i++) {
                                let line = lines[i].trim();
                                if (!line) continue;

                                // A. 如果是 Key 定义行
                                if (line.startsWith('#EXT-X-KEY')) {
                                    // 只有当 Key URI 包含 ID 时才保留
                                    if (line.includes(streamID)) {
                                        output.push(line);
                                    } else {
                                        removedCount++; // 删除了广告 Key
                                    }
                                    continue;
                                }

                                // B. 如果是元数据行 (#EXTINF 等)，先缓存，看下一行 URL 决定留不留
                                if (line.startsWith('#') && !line.startsWith('#EXTM3U') && !line.startsWith('#EXT-X-')) {
                                    buffer.push(line);
                                    continue;
                                }

                                // C. 如果是全局配置行 (#EXT-X-...)，直接保留
                                if (line.startsWith('#')) {
                                    // 遇到 DISCONTINUITY 也要小心，如果是在广告前后的可能导致黑屏，但通常保留无害
                                    output.push(line);
                                    continue; 
                                }

                                // D. 这是一行 URL (分片地址)
                                if (line.includes(streamID)) {
                                    // 这是一个包含正确 ID 的正片
                                    output = output.concat(buffer); // 把之前的 #EXTINF 放进去
                                    output.push(line); // 把 URL 放进去
                                } else {
                                    // 这是一个不包含 ID 的广告片
                                    removedCount++;
                                }
                                // 处理完 URL，清空 buffer
                                buffer = [];
                            }

                            log(`净化完成: 移除了 ${removedCount} 行广告代码`, 'success');

                            const cleanText = output.join('\n');

                            // 返回给 HLS.js
                            callbacks.onSuccess({
                                url: context.url,
                                data: cleanText
                            }, {
                                url: context.url,
                                data: cleanText
                            }, context);
                        })
                        .catch(err => {
                            log(`加载失败: ${err.message}`, 'error');
                            callbacks.onError(err, context);
                        });

                } else {
                    // 对于 TS 片段和 Key 文件的请求，使用默认加载器
                    load(context, config, callbacks);
                }
            };
        }
    }

    function startPlay() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) return alert('请输入地址');

        if (hls) hls.destroy();
        logDiv.innerHTML = ''; // 清空日志

        // 1. 提取 ID
        const id = extractStreamID(url);
        if (id) {
            window.TARGET_STREAM_ID = id;
            log(`识别到内容 ID: ${id}`, 'success');
        } else {
            window.TARGET_STREAM_ID = null;
            log('警告: 未能识别 ID，将无法过滤广告', 'warn');
        }

        if (Hls.isSupported()) {
            hls = new Hls({
                // 使用自定义加载器覆盖默认逻辑
                pLoader: PLoader,
                // 其他优化
                enableWorker: true,
                manifestLoadingTimeOut: 20000,
            });

            hls.loadSource(url);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                log('解析成功，开始播放', 'success');
                video.play().catch(e => log('自动播放受限，请手动点击播放'));
            });

            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    log(`致命错误: ${data.details}`, 'error');
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            hls.recoverMediaError();
                            break;
                        default:
                            hls.destroy();
                            break;
                    }
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            log('iOS 模式: 无法在原生播放器中拦截广告', 'warn');
        }
    }

    // URL 参数自动加载
    const params = new URLSearchParams(window.location.search);
    const urlParam = params.get('url');
    if (urlParam) {
        document.getElementById('urlInput').value = urlParam;
        setTimeout(startPlay, 500);
    }
</script>

</body>
</html>
