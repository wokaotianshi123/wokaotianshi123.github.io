<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨ (Proç‰ˆ)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“º</text></svg>">
    <style>
        /* --- åŸºç¡€æ ·å¼ (PCç«¯ä¿æŒé»˜è®¤) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #app-container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* PCç«¯å¸ƒå±€ç»“æ„ */
        #control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
            background: transparent;
            z-index: 200;
        }

        .cp-group-top {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
        }

        .cp-group-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            color: #00ccff;
            margin: 0;
            font-size: 1.5rem;
            white-space: nowrap;
        }
        .pro-tag { font-size: 0.6em; color: #777; vertical-align: middle; }

        #m3u8-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #444;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        #m3u8-input:focus { outline: none; border-color: #00ccff; }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            color: #fff;
            white-space: nowrap;
            height: 40px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #line-select {
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: #fff;
            max-width: 160px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }
        #line-select:focus { border-color: #00ccff; outline: none; }

        #load-button { background-color: #00ccff; color: #000; }
        #cast-button { background-color: #3b82f6; gap: 6px; }
        #cast-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #proxy-btn { background-color: #10b981; color: #fff; min-width: 60px; }
        #proxy-btn.disabled { background-color: #4b5563; color: #9ca3af; }

        #video-wrapper {
            flex-grow: 1;
            width: 100%;
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            touch-action: manipulation; 
        }

        #dplayer-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
        #dplayer-container video { will-change: transform; backface-visibility: hidden; }

        #custom-stats {
            position: absolute; top: 20px; left: 20px; padding: 15px;
            background: rgba(0, 0, 0, 0.85); color: #eee; border-radius: 8px;
            font-size: 13px; z-index: 100; pointer-events: none; display: none;
            backdrop-filter: blur(5px); font-family: Consolas, monospace; min-width: 200px;
        }

        .temp-iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 5; background: #000; }
        .iframe-active { z-index: 20; opacity: 1; pointer-events: auto; }

        #status-message {
            margin-bottom: 10px; padding: 8px 12px; border-radius: 4px;
            background-color: #2a3f4d; color: #7dd3fc; font-size: 13px; display: none;
            white-space: pre-wrap; line-height: 1.6; text-align: center;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .sniff-success { animation: pulse-green 1.5s infinite; border: 1px solid #4ade80 !important; }

        /* --- æŠ•å±æ¨¡æ€æ¡† --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-active { display: flex !important; opacity: 1 !important; }
        .cast-modal { background: #252525; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); transform: translateY(20px); transition: transform 0.3s; }
        .modal-active .cast-modal { transform: translateY(0); }
        .cast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .cast-title { font-size: 18px; font-weight: bold; color: #fff; }
        .cast-close { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; }
        .cast-option { display: flex; align-items: center; gap: 12px; padding: 12px; background: #333; border-radius: 8px; margin-bottom: 8px; cursor: pointer; color: #fff; }
        .cast-group-title { font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .tag-recommend { background: #00ccff; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; font-weight: bold; }

        /* --- ç§»åŠ¨ç«¯æ·±åº¦ä¼˜åŒ– (Mobile Optimization) --- */
        @media (max-width: 768px) {
            body { background-color: #000; }

            #app-container {
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100vh;
                max-width: none;
            }

            /* æ§åˆ¶é¢æ¿ï¼šæ‚¬æµ®é¡¶æ  */
            #control-panel {
                position: absolute;
                top: 0; left: 0; width: 100%;
                background: rgba(0, 0, 0, 0.85); /* Darker background */
                backdrop-filter: blur(8px);
                padding: 6px 10px; /* Compact padding */
                box-sizing: border-box;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: 4px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.6);
                
                /* é»˜è®¤éšè—ï¼Œé€šè¿‡ JS æ§åˆ¶ active ç±»æ˜¾ç¤º */
                transform: translateY(-120%);
                opacity: 0;
                pointer-events: none;
                transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s;
            }

            #control-panel.active {
                transform: translateY(0);
                opacity: 1;
                pointer-events: auto;
            }

            /* ç§»åŠ¨ç«¯ Top Group: æ ‡é¢˜ + è¾“å…¥æ¡† (æå°æ¨¡å¼) */
            .cp-group-top {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 6px;
                height: 24px;
            }

            h1 {
                font-size: 10px;
                color: #888;
                margin: 0;
                line-height: 24px;
                white-space: nowrap;
            }
            .pro-tag { display: none; }

            #m3u8-input {
                height: 22px;
                font-size: 10px;
                padding: 0 8px;
                background-color: rgba(255,255,255,0.08);
                border: 1px solid rgba(255,255,255,0.1);
                color: #ccc;
                flex: 1;
                border-radius: 4px;
            }

            /* ç§»åŠ¨ç«¯ Bottom Group: æŒ‰é’®ç»„ (æ‚¬æµ®é£æ ¼) */
            .cp-group-bottom {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .btn {
                height: 28px;
                font-size: 11px;
                padding: 0 4px;
                flex: 1;
                border-radius: 4px;
            }

            /* è°ƒæ•´æŒ‰é’®æ¯”ä¾‹ */
            #line-select { flex: 1.5; min-width: 70px; background-position: right 4px center; padding-right: 18px; font-size: 10px; }
            #load-button { flex: 1; }
            #cast-button { flex: 1; }
            #proxy-btn { flex: 0.8; font-size: 10px; padding: 0 2px; }

            /* æ’­æ”¾å™¨å…¨å±å¡«å…… */
            #video-wrapper {
                width: 100%;
                height: 100%;
                border: none;
                border-radius: 0;
                flex-grow: 1;
            }
            
            #status-message {
                position: absolute;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                z-index: 50;
                max-width: 80%;
                text-align: center;
                background-color: rgba(42, 63, 77, 0.9);
                pointer-events: none;
                white-space: pre-wrap;
            }

            #loading-tip {
                z-index: 60;
                background: rgba(0,0,0,0.6);
                padding: 20px;
                border-radius: 10px;
            }
        }
    </style>
    
    <!-- Google Cast åˆå§‹åŒ– -->
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                try {
                    cast.framework.CastContext.getInstance().setOptions({
                        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                    });
                    window.isGCastInitialized = true;
                    document.dispatchEvent(new Event('google-cast-ready'));
                } catch (e) { console.error('GCast Init Error:', e); }
            }
        };
    </script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>

<div id="app-container">
    <div id="control-panel">
        <div class="cp-group-top">
            <h1>M3U8 <span class="pro-tag">PRO</span></h1>
            <input type="url" id="m3u8-input" placeholder="è¾“å…¥é“¾æ¥" value="YOUR_URL_HERE">
        </div>
        <div class="cp-group-bottom">
            <select id="line-select" class="btn">
                <option value="-1">ğŸš€ è‡ªåŠ¨ç«é€Ÿ</option>
            </select>
            <button id="load-button" class="btn">âš¡ï¸ æ’­æ”¾</button>
            <button id="cast-button" class="btn">ğŸ“º æŠ•å±</button>
            <button id="proxy-btn" class="btn">å¥—ä»£å…³</button>
        </div>
    </div>

    <div id="status-message"></div>

    <div id="video-wrapper">
        <div id="loading-tip" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#888; display:none; z-index:1; text-align:center; width: 100%;">
            <p id="loading-text">æ­£åœ¨è§£æ...</p>
            <p style="font-size:12px; color:#555;">åå°æ­£åœ¨å°è¯•å—…æ¢çœŸå® M3U8 åœ°å€</p>
        </div>
        
        <div id="dplayer-container"></div>
        <div id="custom-stats"></div>
    </div>
</div>

<!-- æŠ•å±é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="cast-modal-overlay" class="modal-overlay">
    <div class="cast-modal">
        <div class="cast-header">
            <div class="cast-title">é€‰æ‹©æŠ•å±æˆ–æ’­æ”¾æ–¹å¼</div>
            <button class="cast-close" id="close-cast-modal">Ã—</button>
        </div>
        <div id="cast-options-container"></div>
    </div>
</div>

<script src="https://s4.zstatic.net/ajax/libs/hls.js/1.5.6/hls.min.js" crossorigin="anonymous"></script>
<script src="https://s4.zstatic.net/ajax/libs/dplayer/1.26.0/DPlayer.min.js" crossorigin="anonymous"></script>

<script>
    const apiArray = [
        { name: "ikun", url: "https://jx.hls.one/?url=" },
        { name: "77", url: "https://jx.77flv.cc/?url=" },
        { name: "å†°è±†", url: "https://bd.jx.cn/?url=" },
        { name: "XY", url: "https://jx.xymp4.cc/?url=" },
        { name: "Ckplayer", url: "https://www.ckplayer.vip/jiexi/?url=" },
        { name: "M3u8TV", url: "https://jx.m3u8.tv/jiexi/?url=" },
        { name: "XMFLV", url: "https://jx.xmflv.com/?url=" },
        { name: "YParse", url: "https://yparse.ik9.cc/index.php?url=" },
        { name: "8090g", url: "https://www.8090g.cn/jiexi/?url=" },
        { name: "jy", url: "https://jx.playerjy.com/?url=" },
        { name: "nnxy", url: "https://jx.nnxv.cn/tv.php?url=" },
        { name: "pg", url: "https://www.pangujiexi.com/pangu/?url=" },
        { name: "2s0", url: "https://jx.2s0.cn/player/?url=" }
    ];

    const hlsConfig = {
        enableWorker: true,
        lowLatencyMode: false,
        startBufferLength: 20,
        maxBufferLength: 120,
        maxMaxBufferLength: 600,
        maxBufferSize: 200 * 1024 * 1024,
        backBufferLength: 90,
        fragLoadingTimeOut: 20000,
        fragLoadingMaxRetry: 6,
        manifestLoadingTimeOut: 20000,
        levelLoadingTimeOut: 20000,
        maxLoadingDelay: 4, 
        minAutoBitrate: 0, 
        capLevelToPlayerSize: false, 
        autoStartLoad: true,
        maxBufferHole: 0.5,
    };

    let dp = null; 
    let hlsInstance = null;
    let currentMode = 'idle';
    let isSniffed = false;
    let statsTimer = null; 
    let raceAborted = false;
    let statusMsgTimer = null;
    
    const PROXY_PREFIX = "https://cfkua.wokaotianshi.eu.org/";
    let isProxyOn = false;
    let currentNetworkUrl = "";

    // æ‰‹åŠ¿æ§åˆ¶å˜é‡
    let tapCount = 0;
    let tapTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('m3u8-input');
        const loadBtn = document.getElementById('load-button');
        const castBtn = document.getElementById('cast-button');
        const proxyBtn = document.getElementById('proxy-btn');
        const lineSelect = document.getElementById('line-select');
        const controlPanel = document.getElementById('control-panel');
        const videoWrapper = document.getElementById('video-wrapper');
        const loadingTip = document.getElementById('loading-tip');
        const loadingText = document.getElementById('loading-text');
        const modalOverlay = document.getElementById('cast-modal-overlay');
        const closeCastBtn = document.getElementById('close-cast-modal');

        const urlParam = getUrlParameter('url');
        
        let initVal = urlParam || (input.value === 'YOUR_URL_HERE' ? '' : input.value);
        if (!isProxyOn && initVal.startsWith(PROXY_PREFIX)) {
            initVal = initVal.replace(PROXY_PREFIX, '');
        }
        input.value = initVal;

        apiArray.forEach((api, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = api.name;
            lineSelect.appendChild(option);
        });
        
        function updateProxyBtn() {
            if (isProxyOn) {
                proxyBtn.classList.remove('disabled');
                proxyBtn.textContent = 'å¥—ä»£å¼€';
            } else {
                proxyBtn.classList.add('disabled');
                proxyBtn.textContent = 'å¥—ä»£å…³';
            }
        }
        
        proxyBtn.addEventListener('click', () => {
            isProxyOn = !isProxyOn;
            updateProxyBtn();
            const val = input.value.trim();
            if (val && val !== 'YOUR_URL_HERE') {
                if (isProxyOn) {
                    if (!val.startsWith(PROXY_PREFIX)) input.value = PROXY_PREFIX + val;
                } else {
                    if (val.startsWith(PROXY_PREFIX)) input.value = val.replace(PROXY_PREFIX, '');
                }
            }
        });
        updateProxyBtn();

        lineSelect.addEventListener('change', () => {
            if (input.value && input.value !== 'YOUR_URL_HERE') startPlay();
        });

        function initMobileGestures() {
            if (window.innerWidth > 768) return;

            // ç§»åŠ¨ç«¯æ¬¢è¿æç¤º (å»é™¤äº†å•å‡»è¯´æ˜ï¼Œå› ä¸ºç°åœ¨æ˜¯é»˜è®¤è¡Œä¸º)
            showStatus("åŒå‡»èœå•ï¼Œä¸‰å‡»å…¨å±", 'info', 10000);

            let isScrolling = false;
            let startX = 0;
            let startY = 0;

            videoWrapper.addEventListener('touchstart', (e) => {
                isScrolling = false;
                if(e.touches.length > 0) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }
            }, {passive: true});

            videoWrapper.addEventListener('touchmove', (e) => {
                if(e.touches.length > 0) {
                    if (Math.abs(e.touches[0].clientX - startX) > 10 || Math.abs(e.touches[0].clientY - startY) > 10) {
                        isScrolling = true;
                    }
                }
            }, {passive: true});

            videoWrapper.addEventListener('touchend', (e) => {
                if (isScrolling) return; 
                // é˜²æ­¢è¯¯è§¦æ§åˆ¶æ ç»„ä»¶
                if (e.target.closest('#control-panel') || e.target.closest('.dplayer-controller') || e.target.closest('.dplayer-mobile-play')) return;

                tapCount++;

                if (tapTimer) clearTimeout(tapTimer);

                tapTimer = setTimeout(() => {
                    if (tapCount === 1) {
                        // æ¢å¤é»˜è®¤è¡Œä¸ºï¼šä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œè®© click äº‹ä»¶ç©¿é€ç»™ DPlayer å¤„ç† (é€šå¸¸æ˜¯æ˜¾ç¤ºæ§åˆ¶æ æˆ–æ’­æ”¾æš‚åœ)
                    } else if (tapCount === 2) {
                        controlPanel.classList.toggle('active');
                    } else if (tapCount === 3) {
                        if (dp) dp.fullScreen.toggle();
                    }
                    tapCount = 0;
                }, 300);
            });
        }

        // ç§»é™¤äº† showMobileToast å‡½æ•°ï¼Œå› ä¸ºä¸éœ€è¦è‡ªå®šä¹‰çš„æ’­æ”¾æç¤ºäº†

        initMobileGestures();

        function startPlay() {
            let url = input.value.trim();
            if (isProxyOn) {
                if (url && !url.startsWith(PROXY_PREFIX)) {
                    url = PROXY_PREFIX + url;
                    input.value = url;
                }
            }
            if (!url) return showStatus('è¯·è¾“å…¥è§†é¢‘åœ°å€', 'error');

            currentNetworkUrl = url; 
            resetPlayer();
            
            if(window.innerWidth <= 768) controlPanel.classList.remove('active');

            if (url.includes('.m3u8') || url.startsWith('blob:') || url.startsWith('http://127.0.0.1')) {
                loadM3U8Mode(url);
            } else {
                const selectedLine = parseInt(lineSelect.value);
                if (selectedLine === -1) {
                    loadIframeRaceMode(url);
                } else {
                    loadSingleLineMode(url, selectedLine);
                }
                startGlobalSniffing(url);
            }
        }
        
        loadBtn.addEventListener('click', startPlay);
        input.addEventListener('keydown', (e) => e.key === 'Enter' && startPlay());
        
        closeCastBtn.onclick = () => { modalOverlay.classList.remove('modal-active'); };
        modalOverlay.onclick = (e) => { if(e.target === modalOverlay) modalOverlay.classList.remove('modal-active'); };

        async function loadM3U8Mode(url, isAutoSniffed = false) {
            currentMode = 'm3u8';
            castBtn.disabled = false;
            isSniffed = true;
            raceAborted = true;
            videoWrapper.classList.remove('sniff-success');
            
            if(isAutoSniffed) currentNetworkUrl = url;

            if (isAutoSniffed) {
                showStatus('âœ… æ·±åº¦å—…æ¢æˆåŠŸï¼å·²åˆ‡æ¢è‡³å¢å¼ºæ¨¡å¼', 'success');
                videoWrapper.classList.add('sniff-success');
                setTimeout(() => videoWrapper.classList.remove('sniff-success'), 2000);
            } else {
                showStatus('æ­£åœ¨æ™ºèƒ½åˆ†æåª’ä½“æµ...', 'info');
            }

            let finalUrl = url;
            try {
                const cleanResult = await fetchAndCleanM3u8(url);
                if (cleanResult.removedCount > 0) {
                    if (!isAutoSniffed) showStatus(`${cleanResult.log}\næ­£åœ¨ç”Ÿæˆçº¯å‡€æµ...`, 'success');
                    const blob = new Blob([cleanResult.content], { type: 'application/vnd.apple.mpegurl' });
                    finalUrl = URL.createObjectURL(blob);
                } else {
                    if (!isAutoSniffed) showStatus('æœªæ£€æµ‹åˆ°å¹¿å‘Šæˆ–æ— éœ€æ¸…æ´—ï¼Œå‡†å¤‡æ’­æ”¾...', 'info');
                }
            } catch (e) {
                console.warn('æ¸…æ´—è·³è¿‡:', e);
            }

            initDPlayer(finalUrl);
        }

        async function fetchAndCleanM3u8(url, depth = 0) {
            if (depth > 3) throw new Error("Redirect loop detected in M3U8 playlist");
            const toAbsolute = (p, b) => { try { return new URL(p, b).href; } catch(e) { return p; } };
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const originalContent = await response.text();

            if (originalContent.includes('#EXT-X-STREAM-INF')) {
                const lines = originalContent.split(/\r?\n/);
                let bestUrl = null;
                let maxBandwidth = -1;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('#EXT-X-STREAM-INF')) {
                        const bwMatch = lines[i].match(/BANDWIDTH=(\d+)/);
                        const bandwidth = bwMatch ? parseInt(bwMatch[1]) : 0;
                        let j = i + 1;
                        while (j < lines.length) {
                            const nextLine = lines[j].trim();
                            if (nextLine && !nextLine.startsWith('#')) {
                                if (bandwidth > maxBandwidth) { maxBandwidth = bandwidth; bestUrl = nextLine; } 
                                else if (!bestUrl) { bestUrl = nextLine; }
                                break;
                            }
                            j++;
                        }
                    }
                }
                if (bestUrl) return fetchAndCleanM3u8(toAbsolute(bestUrl, url), depth + 1);
            }

            const lines = originalContent.split(/\r?\n/);
            const segments = [];
            const fingerprintCounts = {};
            
            lines.forEach((line, idx) => {
                const trimmed = line.trim();
                if(!trimmed || trimmed.startsWith('#')) return;
                const absUrl = toAbsolute(trimmed, url);
                let u; try { u = new URL(absUrl); } catch(e) { return; }
                const pathParts = u.pathname.split('/'); pathParts.pop(); 
                const fp = `${u.hostname}|${pathParts.join('/')}`;
                if(!fingerprintCounts[fp]) fingerprintCounts[fp] = 0;
                fingerprintCounts[fp]++;
                segments.push({ idx, fp });
            });
            
            let dominantFp = '', maxC = 0;
            for(const [fp, c] of Object.entries(fingerprintCounts)) { if(c > maxC) { maxC = c; dominantFp = fp; } }
            
            if(segments.length === 0 || (maxC / segments.length) < 0.4) {
                return { content: originalContent, removedCount: 0, log: 'æœªæ¸…æ´— (ç‰¹å¾ä¸æ˜æ˜¾)' };
            }

            const linesToRemove = new Set();
            segments.forEach(seg => {
                if(seg.fp !== dominantFp) {
                    linesToRemove.add(seg.idx);
                    let j = seg.idx - 1;
                    while(j >= 0) {
                        const l = lines[j].trim();
                        if(l.startsWith('#EXTINF') || l.startsWith('#EXT-X-BYTERANGE') || l.startsWith('#EXT-X-KEY') || l.startsWith('#EXT-X-DISCONTINUITY')) { linesToRemove.add(j); j--; } 
                        else if (!l.startsWith('#EXT') && l.startsWith('#')) { j--; } 
                        else if (l === '') { j--; } else { break; }
                    }
                }
            });

            const newLines = [];
            lines.forEach((line, idx) => {
                if(linesToRemove.has(idx)) return;
                let content = line.trim();
                if(!content) return;
                if(content.startsWith('#')) {
                    if(content.startsWith('#EXT-X-KEY') && content.includes('URI="')) {
                        content = content.replace(/URI="([^"]+)"/, (m, p1) => `URI="${toAbsolute(p1, url)}"`);
                    }
                    newLines.push(content);
                } else {
                    newLines.push(toAbsolute(content, url));
                }
            });
            
            const removedCount = segments.length - maxC;
            const effectiveRemovedCount = depth > 0 ? (removedCount + 1) : removedCount;
            return { content: newLines.join('\n'), removedCount: effectiveRemovedCount, log: `å·²ç§»é™¤ ${removedCount} ä¸ªå¹¿å‘Šåˆ†ç‰‡` };
        }

        function initDPlayer(videoUrl) {
            if (dp) dp.destroy();
            stopStatsLoop();
            document.getElementById('dplayer-container').style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());

            dp = new DPlayer({
                container: document.getElementById('dplayer-container'),
                autoplay: true,
                theme: '#00ccff',
                lang: 'zh-cn',
                screenshot: true,
                hotkey: true,
                airplay: false, 
                chromecast: false,
                volume: 0.7,
                video: {
                    url: videoUrl,
                    type: 'customHls', 
                    customType: {
                        customHls: function(video, player) {
                            if (Hls.isSupported()) {
                                if (hlsInstance) hlsInstance.destroy();
                                hlsInstance = new Hls(hlsConfig);
                                hlsInstance.loadSource(videoUrl);
                                hlsInstance.attachMedia(video);
                                hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                    if(hlsInstance.levels.length > 0) {
                                        hlsInstance.currentLevel = hlsInstance.levels.length - 1;
                                        hlsInstance.capLevelToPlayerSize = false;
                                        showStatus('ğŸš€ ç”»è´¨å¢å¼ºï¼šå·²é”å®šæœ€é«˜ç ç‡<br>ğŸ’¡ è‹¥æ’­æ”¾å¡é¡¿è¯·ç‚¹å‡»å¥—ä»£æŒ‰é’®ï¼Œå†ç‚¹å‡»æ’­æ”¾', 'success', 10000);
                                    }
                                    startStatsLoop(video, hlsInstance);
                                    video.play().catch(e => console.warn('Autoplay blocked', e));
                                });
                                hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                                    if (data.fatal) {
                                        switch(data.type) {
                                            case Hls.ErrorTypes.NETWORK_ERROR: hlsInstance.startLoad(); break;
                                            case Hls.ErrorTypes.MEDIA_ERROR: hlsInstance.recoverMediaError(); break;
                                            default: hlsInstance.destroy(); break;
                                        }
                                    }
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                video.src = videoUrl;
                                startStatsLoop(video, null);
                                showStatus('ğŸš€ åŸç”Ÿæ’­æ”¾æ¨¡å¼<br>ğŸ’¡ è‹¥æ’­æ”¾å¡é¡¿è¯·ç‚¹å‡»å¥—ä»£æŒ‰é’®ï¼Œå†ç‚¹å‡»æ’­æ”¾', 'success', 10000);
                            }
                        }
                    }
                }
            });

            setupCastButtonLogic(dp.video);
            
            if(window.innerWidth <= 768) {
                setTimeout(() => {
                   const dCtrl = document.querySelector('.dplayer-controller');
                   if(dCtrl) dCtrl.style.opacity = '0';
                }, 500);
            }
            
            dp.on('canplay', () => { setTimeout(() => clearStatus(), 3000); });
        }
        
        function setupCastButtonLogic(videoEl) {
            castBtn.onclick = () => {
                renderCastOptions(videoEl);
                modalOverlay.classList.add('modal-active');
            };
        }

        function renderCastOptions(videoEl) {
            const container = document.getElementById('cast-options-container');
            container.innerHTML = '';
            
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /iphone|ipad|ipod/.test(ua);
            const isAndroid = /android/.test(ua);
            const isMac = /mac os/.test(ua) && !isIOS;
            const isWin = /windows/.test(ua);

            const createOption = (icon, title, desc, onClick, tag = '') => {
                const div = document.createElement('div');
                div.className = 'cast-option';
                div.innerHTML = `<div class="cast-icon" style="font-size:20px;">${icon}</div><div class="cast-info" style="display:flex;flex-direction:column;"><div class="cast-name" style="font-size:15px;font-weight:500;">${title} ${tag ? `<span class="tag-recommend">${tag}</span>` : ''}</div><div class="cast-desc" style="font-size:12px;color:#aaa;">${desc}</div></div>`;
                div.onclick = () => { onClick(); };
                return div;
            };

            const addGroup = (title) => {
                const div = document.createElement('div'); div.className = 'cast-group-title'; div.innerText = title; container.appendChild(div);
            };

            addGroup('æ— çº¿æŠ•å±');
            if(isIOS || (isMac && /safari/.test(ua) && !/chrome/.test(ua))) {
                 container.appendChild(createOption('ğŸ', 'AirPlay', 'æŠ•å°„åˆ° Apple TV', () => {
                     if(videoEl.webkitShowPlaybackTargetPicker) videoEl.webkitShowPlaybackTargetPicker();
                     else showStatus('è¯·åœ¨æ’­æ”¾å™¨æ§åˆ¶æ ç‚¹å‡» AirPlay å›¾æ ‡', 'info');
                 }));
            }
            if(window.chrome && !isIOS) {
                container.appendChild(createOption('ğŸ“¡', 'Google Cast', 'æŠ•å°„åˆ° Chromecast', () => {
                    if(window.cast && window.cast.framework) {
                        const ctx = cast.framework.CastContext.getInstance();
                        const session = ctx.getCurrentSession();
                        const mediaInfo = new chrome.cast.media.MediaInfo(currentNetworkUrl, 'application/x-mpegurl');
                        const request = new chrome.cast.media.LoadRequest(mediaInfo);
                        if(!session) { ctx.requestSession().then(() => { ctx.getCurrentSession().loadMedia(request); }).catch(e => console.error(e)); } 
                        else { session.loadMedia(request); }
                    } else { showStatus('Chromecast æœåŠ¡æœªå°±ç»ª', 'warning'); }
                }));
            }

            addGroup('DLNA / ç¬¬ä¸‰æ–¹æŠ•å±');
            if (isAndroid || isIOS) {
                container.appendChild(createOption('ğŸš€', 'Web Video Caster', 'æ¨èï¼æ”¯æŒ DLNA', () => { window.location.href = `wvc-x-callback://open?url=${encodeURIComponent(currentNetworkUrl)}&secure_uri=true`; }, 'æ¨è'));
                container.appendChild(createOption('ğŸ“º', 'é€šç”¨æŠ•å±åŠ©æ‰‹', 'å°è¯•å”¤èµ· App', () => { window.location.href = `video-cast://${currentNetworkUrl}`; }));
            }

            addGroup('æœ¬åœ°åº”ç”¨æ’­æ”¾');
            container.appendChild(createOption('ğŸŸ ', 'VLC æ’­æ”¾å™¨', 'å¼ºåŠ›è§£ç ', () => { window.location.href = `vlc://${currentNetworkUrl}`; }));
            if(isMac) container.appendChild(createOption('ğŸï¸', 'IINA', 'Mac æœ€ä½³', () => { window.location.href = `iina://weblink?url=${currentNetworkUrl}`; }, 'Macé¦–é€‰'));
            if(isWin) container.appendChild(createOption('ğŸŸ¦', 'PotPlayer', 'Windows å…¨èƒ½', () => { window.location.href = `potplayer://${currentNetworkUrl}`; }, 'Winé¦–é€‰'));
            
            addGroup('å…¶ä»–');
            container.appendChild(createOption('ğŸ”—', 'å¤åˆ¶è§†é¢‘é“¾æ¥', 'æ‰‹åŠ¨ä½¿ç”¨', () => {
                navigator.clipboard.writeText(currentNetworkUrl).then(() => { showStatus('âœ… é“¾æ¥å·²å¤åˆ¶', 'success'); modalOverlay.classList.remove('modal-active'); });
            }));
        }

        function stopStatsLoop() {
             if(statsTimer) clearInterval(statsTimer);
             statsTimer = null;
             document.getElementById('custom-stats').style.display = 'none';
        }

        function startStatsLoop(video, hls) {
            if(statsTimer) clearInterval(statsTimer);
            let frameCount = 0; let currentFPS = 0; let lastFrameTime = performance.now();
            const frameCallback = (now) => {
                frameCount++;
                if (now - lastFrameTime >= 1000) { currentFPS = frameCount; frameCount = 0; lastFrameTime = now; }
                if(video.requestVideoFrameCallback) video.requestVideoFrameCallback(frameCallback);
            };
            if ('requestVideoFrameCallback' in video) video.requestVideoFrameCallback(frameCallback);

            const statsEl = document.getElementById('custom-stats');
            const updateStatsUI = () => {
                if(statsEl.style.display === 'none') return;
                let resolution = `${video.videoWidth} x ${video.videoHeight}`;
                let bitrate = 'N/A';
                if (hls && hls.bandwidthEstimate > 0) bitrate = (hls.bandwidthEstimate / 1000).toFixed(0) + ' kbps (Est)';
                const buffer = video.buffered.length ? (video.buffered.end(video.buffered.length-1) - video.currentTime).toFixed(1) : 0;
                let displayFPS = video.paused ? 0 : currentFPS;
                statsEl.innerHTML = `<div style="color:#00ccff;border-bottom:1px solid #555;margin-bottom:5px;">ğŸ“Š å®æ—¶ç›‘æ§</div><div>FPS: <span style="color:${displayFPS >= 50 ? '#00ccff' : '#fff'}">${displayFPS}</span></div><div>RES: ${resolution}</div><div>BIT: ${bitrate}</div><div>BUF: ${buffer} s</div>`;
            };
            statsTimer = setInterval(updateStatsUI, 500);
            updateStatsUI();
        }

        function loadIframeRaceMode(url) {
            currentMode = 'iframe_race';
            castBtn.disabled = true; 
            isSniffed = false;
            raceAborted = false;
            showStatus('è‡ªåŠ¨æ¨¡å¼ï¼šå…¨çº¿è·¯ç«é€Ÿè§£æä¸­...', 'info');
            loadingText.innerText = "æ­£åœ¨ç«é€Ÿè§£æ...";
            loadingTip.style.display = 'block';
            let hasWinner = false; 
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            apiArray.forEach(api => {
                if(raceAborted) return;
                const iframe = document.createElement('iframe');
                iframe.className = 'temp-iframe';
                iframe.allowFullscreen = true; 
                iframe.src = api.url + url;
                iframe.setAttribute('data-name', api.name);
                iframe.onload = function() {
                    if (isSniffed || hasWinner || raceAborted) return;
                    hasWinner = true;
                    handleWinner(this, api, url);
                };
                videoWrapper.appendChild(iframe);
            });
        }
        
        function loadSingleLineMode(url, index) {
            const api = apiArray[index];
            if(!api) return loadIframeRaceMode(url);
            currentMode = 'iframe_manual';
            castBtn.disabled = true;
            isSniffed = false;
            raceAborted = true; 
            showStatus(`æ‰‹åŠ¨æ¨¡å¼ï¼šæ­£åœ¨åŠ è½½ [${api.name}] ...`, 'info');
            loadingText.innerText = `æ­£åœ¨è¿æ¥ ${api.name}...`;
            loadingTip.style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            const iframe = document.createElement('iframe');
            iframe.className = 'temp-iframe';
            iframe.allowFullscreen = true;
            iframe.src = api.url + url;
            iframe.onload = function() {
                if(isSniffed) return;
                loadingTip.style.display = 'none';
                iframe.classList.add('iframe-active');
                showStatus(`å·²åŠ è½½çº¿è·¯ï¼š${api.name}`, 'info');
            };
            videoWrapper.appendChild(iframe);
        }

        async function handleWinner(iframe, api, videoUrl) {
            if (isSniffed || raceAborted) return;
            showStatus(`çº¿è·¯ ${api.name} å“åº”æœ€å¿«ï¼Œæ­£åœ¨å°è¯•æ·±åº¦æå–ç›´é“¾...`, 'info');
            let sniffSuccess = false;
            const sniffTimeout = setTimeout(() => {
                if (!isSniffed && !raceAborted) {
                    displayIframe(iframe, api.name);
                }
            }, 2500); 

            try {
                const targetUrl = api.url + videoUrl;
                const deepUrl = await tryDeepSniff(targetUrl);
                if (deepUrl && !isSniffed && !raceAborted) {
                    clearTimeout(sniffTimeout);
                    sniffSuccess = true;
                    loadM3U8Mode(deepUrl, true);
                }
            } catch (e) { console.warn('æ·±åº¦æå–å¤±è´¥:', e); }
        }
        
        async function tryDeepSniff(targetUrl) {
            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 2000); 
                const response = await fetch(targetUrl, { method: 'GET', signal: controller.signal });
                if (!response.ok) return null;
                const text = await response.text();
                try {
                    const json = JSON.parse(text);
                    if (json.url && json.url.includes('.m3u8')) return json.url;
                } catch (e) {}
                const regex = /["'](https?:\/\/[^"']+\.m3u8[^"']*)["']/;
                const match = text.match(regex);
                if (match) return match[1];
                return null;
            } catch (e) { return null; }
        }

        function displayIframe(iframe, apiName) {
            if (isSniffed || raceAborted) return; 
            loadingTip.style.display = 'none';
            showStatus(`è§£ææˆåŠŸï¼å½“å‰çº¿è·¯: ${apiName}`, 'info');
            document.getElementById('dplayer-container').style.display = 'none';
            document.querySelectorAll('.temp-iframe').forEach(el => {
                if (el !== iframe) { el.src = 'about:blank'; el.remove(); }
            });
            iframe.classList.add('iframe-active');
        }

        function startGlobalSniffing(videoPageUrl) {
            const regex = /["'](https?:\/\/[^"']+\.m3u8[^"']*)["']/;
            const msgHandler = (e) => {
                let foundUrl = null;
                if (e.data && typeof e.data === 'string') {
                    const match = e.data.match(regex);
                    if (match) foundUrl = match[1];
                } else if (e.data && e.data.type === 'video_url' && e.data.url) {
                    foundUrl = e.data.url;
                }
                if(foundUrl && !isSniffed) {
                    window.removeEventListener('message', msgHandler);
                    loadM3U8Mode(foundUrl, true);
                }
            };
            window.addEventListener('message', msgHandler);
            apiArray.forEach(async (api) => {
                if(isSniffed) return;
                try {
                    const found = await tryDeepSniff(api.url + videoPageUrl);
                    if(found && !isSniffed) loadM3U8Mode(found, true);
                } catch(e) {}
            });
        }

        function resetPlayer() {
            if (dp) { dp.destroy(); dp = null; }
            if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            stopStatsLoop();
            document.getElementById('dplayer-container').style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            clearStatus();
            isSniffed = false;
        }

        function showStatus(msg, type = 'info', duration = null) {
            const el = document.getElementById('status-message');
            el.innerHTML = msg;
            el.style.display = 'block';
            el.style.color = type === 'error' ? '#fca5a5' : (type === 'success' ? '#86efac' : '#7dd3fc');
            el.style.backgroundColor = type === 'error' ? 'rgba(220,38,38,0.2)' : (type === 'success' ? 'rgba(22,163,74,0.2)' : '#2a3f4d');
            
            if (statusMsgTimer) clearTimeout(statusMsgTimer);
            
            let autoHideTime = duration;
            if (autoHideTime === null) {
                if (window.innerWidth <= 768) autoHideTime = 3000;
                else autoHideTime = 0; 
            }
            
            if (autoHideTime > 0) {
                statusMsgTimer = setTimeout(() => {
                    el.style.display = 'none';
                }, autoHideTime);
            }
        }

        function clearStatus() { document.getElementById('status-message').style.display = 'none'; }
        
        function getUrlParameter(name) {
            const results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        if(getUrlParameter('url')) { setTimeout(startPlay, 500); }
    });
</script>

</body>
</html>
