
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨</title>
    <!-- è§£å†³ Favicon 404 æŠ¥é”™ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“º</text></svg>">
    <!-- æ·»åŠ  crossorigin="anonymous" ä»¥å‡å°‘ Safari è¿½è¸ªé˜²æŠ¤è­¦å‘Š -->
    <link href="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #app-container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #4ade80;
            text-align: center;
            margin: 10px 0 20px 0;
            font-size: 1.5rem;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        #control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        #m3u8-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #444;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }
        #m3u8-input:focus {
            outline: none;
            border-color: #4ade80;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            color: #fff;
            white-space: nowrap;
        }

        #load-button { background-color: #4ade80; color: #000; }
        #load-button:hover { filter: brightness(1.1); }

        #cast-button { background-color: #3b82f6; display: inline-flex; align-items: center; gap: 6px; }
        #cast-button:hover { filter: brightness(1.1); }
        #cast-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }

        /* --- æ’­æ”¾å™¨å®¹å™¨ (å…³é”®èåˆéƒ¨åˆ†) --- */
        #video-wrapper {
            /* æ¡Œé¢ç«¯é»˜è®¤æ ·å¼ï¼šåˆ©ç”¨ flex å¡«å……å‰©ä½™ç©ºé—´ï¼Œä½†ä¿æŒåˆç†æ¯”ä¾‹ */
            flex-grow: 1;
            width: 100%;
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            /* é»˜è®¤ 16:9 æ¯”ä¾‹ï¼Œé˜²æ­¢åˆå§‹é«˜åº¦å¡Œé™· */
            aspect-ratio: 16 / 9;
        }

        /* Artplayer å®¹å™¨ */
        #artplayer-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
        }

        /* Iframe ç«é€Ÿå®¹å™¨ */
        .temp-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0; left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 5;
            background: #000;
        }
        
        .iframe-active {
            z-index: 20;
            opacity: 1;
            pointer-events: auto;
        }

        /* --- çŠ¶æ€æç¤º --- */
        #status-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #2a3f4d;
            color: #7dd3fc;
            font-size: 13px;
            display: none;
            white-space: pre-line;
            overflow-wrap: break-word;
        }

        /* å—…æ¢æˆåŠŸåŠ¨ç”» */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .sniff-success {
            animation: pulse-green 1.5s infinite;
            border: 1px solid #4ade80 !important;
        }

        /* --- ç§»åŠ¨ç«¯ä¼˜åŒ– --- */
        @media (max-width: 600px) {
            #app-container { 
                padding: 10px; 
                margin: 0;
                border: none;
                box-shadow: none;
                width: 100%;
                max-width: 100%;
            }
            
            #control-panel { 
                gap: 8px; 
            }
            
            #m3u8-input { 
                width: 100%; 
                font-size: 16px; 
                padding: 12px;
            }
            
            .btn { 
                flex-grow: 1; 
                padding: 12px;
            }
            
            h1 { 
                font-size: 1.2rem; 
                margin: 5px 0 15px 0; 
            }

            #video-wrapper {
                flex-grow: 0;
                width: 100%;
                aspect-ratio: 16 / 9;
                min-height: auto;
                border-radius: 4px;
                border-color: #222;
            }
        }
    </style>
    
    <!-- Google Cast åˆå§‹åŒ– -->
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                try {
                    cast.framework.CastContext.getInstance().setOptions({
                        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                    });
                    window.isGCastInitialized = true;
                    document.dispatchEvent(new Event('google-cast-ready'));
                } catch (e) { console.error('GCast Init Error:', e); }
            }
        };
    </script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>

<div id="app-container">
    <h1>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨</h1>
    
    <div id="control-panel">
        <input type="url" id="m3u8-input" placeholder="è¾“å…¥ M3U8 ç›´é“¾æˆ–è§†é¢‘ç½‘ç«™åœ°å€" value="YOUR_URL_HERE">
        <button id="load-button" class="btn">âš¡ï¸ æ™ºèƒ½æ’­æ”¾</button>
        <button id="cast-button" class="btn">ğŸ“º æŠ•å±</button>
    </div>

    <div id="status-message"></div>

    <div id="video-wrapper">
        <!-- ç«é€Ÿè§£ææ¨¡å¼çš„ Loading æç¤º -->
        <div id="loading-tip" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#888; display:none; z-index:1; text-align:center; width: 100%;">
            <p>æ­£åœ¨ç«é€Ÿè§£æ...</p>
            <p style="font-size:12px; color:#555;">åå°æ­£åœ¨å°è¯•å—…æ¢çœŸå® M3U8 åœ°å€</p>
        </div>
        <!-- æœ¬åœ°æ’­æ”¾å™¨å®¹å™¨ -->
        <div id="artplayer-container"></div>
        <!-- Iframe å®¹å™¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
</div>

<!-- åº“å¼•å…¥ï¼Œæ·»åŠ  crossorigin="anonymous" -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.min.js" crossorigin="anonymous"></script>

<script>
    // --- é…ç½®åŒºåŸŸ ---
    
    const apiArray = [
        { name: "çº¿è·¯1 (Ckplayer)", url: "https://www.ckplayer.vip/jiexi/?url=" },
        { name: "çº¿è·¯2 (M3u8TV)", url: "https://jx.m3u8.tv/jiexi/?url=" },
        { name: "çº¿è·¯3 (XMFLV)", url: "https://jx.xmflv.com/?url=" },
        { name: "çº¿è·¯4 (YParse)", url: "https://yparse.ik9.cc/index.php?url=" },
        { name: "çº¿è·¯5 (8090g)", url: "https://www.8090g.cn/jiexi/?url=" },
        { name: "çº¿è·¯6 (JSON)", url: "https://json.jiexi.com/?url=", type: 'json' } 
    ];

    const hlsConfig = {
        enableWorker: true,
        lowLatencyMode: false,
        startBufferLength: 10,
        maxBufferLength: 60,
        maxMaxBufferLength: 120,
        maxBufferSize: 100 * 1024 * 1024,
        backBufferLength: 90,
        fragLoadingTimeOut: 20000,
        fragLoadingMaxRetry: 6,
        maxBufferHole: 0.5,
    };

    // --- å…¨å±€å˜é‡ ---
    let art = null; 
    let hlsInstance = null;
    let castType = 'googlecast'; 
    let currentMode = 'idle';
    let isSniffed = false;

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('m3u8-input');
        const loadBtn = document.getElementById('load-button');
        const castBtn = document.getElementById('cast-button');
        const statusDiv = document.getElementById('status-message');
        const wrapper = document.getElementById('video-wrapper');
        const loadingTip = document.getElementById('loading-tip');

        const urlParam = getUrlParameter('url');
        input.value = urlParam || (input.value === 'YOUR_URL_HERE' ? '' : input.value);

        function startPlay() {
            const url = input.value.trim();
            if (!url) return showStatus('è¯·è¾“å…¥è§†é¢‘åœ°å€', 'error');

            resetPlayer();
            
            if (url.includes('.m3u8') || url.startsWith('blob:') || url.startsWith('http://127.0.0.1')) {
                loadM3U8Mode(url);
            } else {
                loadIframeMode(url);
                backgroundSniff(url);
            }
        }

        // --- æ¨¡å¼ A: æœ¬åœ° M3U8 å¢å¼ºæ¨¡å¼ ---
        async function loadM3U8Mode(url, isAutoSniffed = false) {
            currentMode = 'm3u8';
            castBtn.disabled = false;
            isSniffed = true;
            wrapper.classList.remove('sniff-success');
            
            if (isAutoSniffed) {
                showStatus('âœ… å—…æ¢æˆåŠŸï¼å·²åˆ‡æ¢è‡³å¢å¼ºæ¨¡å¼ (å·²å»å¹¿å‘Š/æ”¯æŒæŠ•å±)', 'success');
                wrapper.classList.add('sniff-success');
                setTimeout(() => wrapper.classList.remove('sniff-success'), 2000);
            } else {
                showStatus('æ­£åœ¨è¿›è¡Œæ·±åº¦æ¸…æ´—ä¸åŠ è½½...', 'info');
            }

            let finalUrl = url;
            try {
                const cleanResult = await fetchAndCleanM3u8(url);
                
                if (cleanResult.removedCount > 0) {
                    if (!isAutoSniffed) showStatus(`${cleanResult.log}\næ­£åœ¨ç”Ÿæˆçº¯å‡€æµ...`, 'success');
                    const blob = new Blob([cleanResult.content], { type: 'application/vnd.apple.mpegurl' });
                    finalUrl = URL.createObjectURL(blob);
                } else {
                    if (!isAutoSniffed) showStatus('æ— éœ€æ¸…æ´—ï¼Œå‡†å¤‡æ’­æ”¾...', 'info');
                }

            } catch (e) {
                // è¿™é‡Œçš„æ—¥å¿—ä»…åœ¨æ§åˆ¶å°æ˜¾ç¤ºï¼Œæ–¹ä¾¿æ’æŸ¥ï¼Œç•Œé¢ä¸Šç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤º
                console.warn('æ¸…æ´—è·³è¿‡:', e);
                if (!isAutoSniffed) {
                    // åŒºåˆ†æ˜¯è¶…æ—¶è¿˜æ˜¯è·¨åŸŸ
                    const msg = e.name === 'AbortError' 
                        ? 'âš ï¸ å¹¿å‘Šåˆ†æè¶…æ—¶ï¼Œè·³è¿‡æ¸…æ´—ç›´æ¥æ’­æ”¾...' 
                        : 'âš ï¸ ç›®æ ‡èµ„æºç¦æ­¢è·¨åŸŸè®¿é—®ï¼Œæ— æ³•å»å¹¿å‘Šï¼Œå°†å°è¯•ç›´æ¥æ’­æ”¾...';
                    showStatus(msg, 'warning');
                }
            }

            initArtplayer(finalUrl, url);
        }

        function initArtplayer(videoUrl, originalUrl) {
            if (art) art.destroy(false);
            
            art = new Artplayer({
                container: '#artplayer-container',
                url: videoUrl,
                type: 'm3u8',
                theme: '#4ade80',
                autoplay: true,
                
                // æ·»åŠ  ID ä»¥ä¼˜åŒ–æœ¬åœ°å­˜å‚¨é”®å€¼ï¼Œå‡å°‘å†²çª
                id: 'm3u8-smart-player',
                
                setting: true,
                miniProgressBar: true,
                fullscreen: true,
                pip: true,
                playbackRate: false, 
                
                settings: [
                    {
                        html: 'æ’­æ”¾é€Ÿåº¦',
                        tooltip: '1.0x',
                        icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
                        selector: [
                            { html: '0.75x', value: 0.75 },
                            { html: '1.0x', value: 1.0, default: true },
                            { html: '1.5x', value: 1.5 },
                            { html: '2.0x', value: 2.0 },
                            { html: '5.0x', value: 5.0 },
                        ],
                        onSelect: function (item) {
                            art.playbackRate = item.value;
                            return item.html;
                        },
                    },
                    {
                        html: 'å­—å¹•è®¾ç½®',
                        tooltip: 'è°ƒèŠ‚',
                        icon: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
                        selector: [
                            { html: 'å­—å¹•å¼€å…³: å¼€å¯', value: 'on' },
                            { html: 'å­—å¹•å¼€å…³: å…³é—­', value: 'off', default: true },
                            { html: 'è°ƒèŠ‚å­—å¹•åç§»', value: 'offset' }
                        ],
                        onSelect: function(item) {
                            if(item.value === 'on') {
                                art.subtitle.show = true;
                                return 'å¼€å¯';
                            }
                            if(item.value === 'off') {
                                art.subtitle.show = false;
                                return 'å…³é—­';
                            }
                            if(item.value === 'offset') {
                                art.subtitleOffset = true; 
                                return 'è°ƒèŠ‚åç§»';
                            }
                            return item.html;
                        }
                    }
                ],
                
                subtitleOffset: true, 
                subtitle: {
                    url: '',
                    type: 'srt',
                    style: { color: '#fff', fontSize: '20px' },
                },

                customType: {
                    m3u8: function (video, url) {
                        if (Hls.isSupported()) {
                            if (hlsInstance) hlsInstance.destroy();
                            hlsInstance = new Hls(hlsConfig);
                            hlsInstance.loadSource(url);
                            hlsInstance.attachMedia(video);
                            
                            hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                                if (data.fatal) {
                                    switch(data.type) {
                                        case Hls.ErrorTypes.NETWORK_ERROR:
                                            hlsInstance.startLoad();
                                            break;
                                        case Hls.ErrorTypes.MEDIA_ERROR:
                                            hlsInstance.recoverMediaError();
                                            break;
                                        default:
                                            showStatus('âŒ æ’­æ”¾å¤±è´¥: æ— æ³•åŠ è½½è§†é¢‘æµ (å¯èƒ½æ˜¯è·¨åŸŸé™åˆ¶)', 'error');
                                            hlsInstance.destroy();
                                            break;
                                    }
                                }
                            });
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        } else {
                            art.notice.show = 'ä¸æ”¯æŒ HLS æ’­æ”¾';
                        }
                    },
                },
            });

            art.on('ready', () => {
                showStatus('âœ… æ’­æ”¾å°±ç»ª', 'success');
                setTimeout(() => clearStatus(), 2000); 
                setupCastButtonLogic(art.video, originalUrl);
            });
            
            art.on('error', (err) => {
                 console.error('Artplayer Error:', err);
                 showStatus('âŒ æ’­æ”¾å™¨é”™è¯¯: ' + (err.message || 'èµ„æºæ— æ³•åŠ è½½'), 'error');
            });
        }

        // --- æ¨¡å¼ B: Iframe ç«é€Ÿè§£ææ¨¡å¼ ---
        function loadIframeMode(url) {
            currentMode = 'iframe';
            castBtn.disabled = true; 
            isSniffed = false;
            showStatus('è¯†åˆ«ä¸ºç½‘é¡µé“¾æ¥ï¼Œæ­£åœ¨ç«é€Ÿè§£æ... (ç¨åè‹¥å‡ºç°æŠ•å±æŒ‰é’®è¯´æ˜å—…æ¢æˆåŠŸ)', 'info');
            loadingTip.style.display = 'block';

            let fastestTime = Infinity;
            let hasWinner = false;

            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());

            apiArray.forEach(api => {
                const iframe = document.createElement('iframe');
                iframe.className = 'temp-iframe';
                iframe.allowFullscreen = true; 
                iframe.setAttribute('allowFullScreen', '');
                iframe.allow = "autoplay; fullscreen; picture-in-picture; encrypted-media; gyroscope; accelerometer";
                iframe.src = api.url + url;
                
                const startTime = performance.now();
                iframe.onload = function() {
                    if (isSniffed) return;
                    const loadTime = performance.now() - startTime;
                    if (loadTime < fastestTime && !hasWinner) {
                        fastestTime = loadTime;
                        hasWinner = true;
                        displayIframe(this, api.name);
                    }
                };
                wrapper.appendChild(iframe);
            });
        }

        function displayIframe(iframe, apiName) {
            if (isSniffed) return;
            loadingTip.style.display = 'none';
            showStatus(`è§£ææˆåŠŸï¼å½“å‰çº¿è·¯: ${apiName} (æš‚æœªæå–åˆ°ç›´é“¾ï¼Œä¸æ”¯æŒæŠ•å±)`, 'info');
            document.getElementById('artplayer-container').style.display = 'none';
            iframe.classList.add('iframe-active');
            
            const manualBtn = document.createElement('span');
            manualBtn.innerHTML = " [æˆ‘æœ‰M3U8åœ°å€]";
            manualBtn.style.cursor = 'pointer';
            manualBtn.style.color = '#4ade80';
            manualBtn.onclick = () => {
                const manualUrl = prompt("å¦‚æœæ‚¨æŠ“åŒ…åˆ°äº† M3U8 åœ°å€ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œä»¥å¼€å¯æŠ•å±å’ŒåŠ é€Ÿï¼š");
                if(manualUrl && manualUrl.includes('.m3u8')) loadM3U8Mode(manualUrl, true);
            };
            statusDiv.appendChild(manualBtn);
        }

        // --- æ ¸å¿ƒå¢å¼ºï¼šåå°å—…æ¢é€»è¾‘ ---
        async function backgroundSniff(videoPageUrl) {
            console.log('å¯åŠ¨åå°å—…æ¢ä»»åŠ¡...');
            const regex = /["'](https?:\/\/[^"']+\.m3u8[^"']*)["']/;

            const msgHandler = (e) => {
                if (e.data && typeof e.data === 'string') {
                    const match = e.data.match(regex);
                    if (match) {
                        window.removeEventListener('message', msgHandler);
                        loadM3U8Mode(match[1], true);
                    }
                }
                if (e.data && e.data.type === 'video_url' && e.data.url) {
                     window.removeEventListener('message', msgHandler);
                     loadM3U8Mode(e.data.url, true);
                }
            };
            window.addEventListener('message', msgHandler);
            
            for (const api of apiArray) {
                if(isSniffed) break;
                try {
                    const targetUrl = api.url + videoPageUrl;
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(targetUrl, { 
                        method: 'GET',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const text = await response.text();
                        const match = text.match(regex);
                        if (match && !isSniffed) {
                            loadM3U8Mode(match[1], true);
                            break; 
                        }
                    }
                } catch (e) { }
            }
        }

        // --- å¹¿å‘Šæ¸…æ´—é€»è¾‘ (è¿›ä¸€æ­¥ä¼˜åŒ–ç‰ˆ) ---
        async function fetchAndCleanM3u8(url) {
            const toAbsolute = (p, b) => { try { return new URL(p, b).href; } catch (e) { return p; } };
            const getFingerprint = (absUrl) => {
                try {
                    const u = new URL(absUrl);
                    const path = u.pathname.substring(0, u.pathname.lastIndexOf('/'));
                    const ext = u.pathname.split('.').pop();
                    return `${u.hostname}|${path}|${ext}`;
                } catch { return 'err'; }
            };

            // 6ç§’è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´å¡é¡¿
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 6000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId); 
                
                if (!response.ok) throw new Error(response.status);
                const text = await response.text();
                
                const lines = text.split(/\r?\n/);
                const counts = {};
                const segments = [];

                lines.forEach((line, idx) => {
                    const trim = line.trim();
                    if (!trim || trim.startsWith('#')) return;
                    const abs = toAbsolute(trim, url);
                    const fp = getFingerprint(abs);
                    counts[fp] = (counts[fp] || 0) + 1;
                    segments.push({ idx, fp, abs });
                });

                let domFp = '', max = 0;
                for (const [fp, c] of Object.entries(counts)) { if (c > max) { max = c; domFp = fp; } }
                
                if (segments.length > 0 && (max / segments.length) <= 0.5) return { removedCount: 0, content: text, log: 'ç»“æ„å¤æ‚æœªæ¸…æ´—' };
                if (segments.length === 0) return { removedCount: 0, content: text, log: 'æ— åˆ†ç‰‡' };

                const toRemove = new Set();
                let removed = 0;
                segments.forEach(s => {
                    if (s.fp !== domFp) {
                        toRemove.add(s.idx);
                        removed++;
                        let j = s.idx - 1;
                        while (j >= 0) {
                            const prev = lines[j].trim();
                            if (prev.startsWith('#EXTINF') || prev.startsWith('#EXT-X-BYTERANGE')) {
                                toRemove.add(j); j--;
                            } else break;
                        }
                    }
                });

                const newLines = lines.filter((_, i) => !toRemove.has(i)).map(l => {
                    const t = l.trim();
                    if (t.startsWith('#')) {
                        if (t.startsWith('#EXT-X-KEY') && t.includes('URI="')) {
                            return t.replace(/URI="([^"]+)"/, (m, p1) => `URI="${toAbsolute(p1, url)}"`);
                        }
                        return t;
                    }
                    return toAbsolute(t, url);
                });

                return { content: newLines.join('\n'), removedCount: removed, log: `å·²ç§»é™¤ ${removed} ä¸ªå¹¿å‘Šåˆ†ç‰‡` };
            } catch (error) {
                clearTimeout(timeoutId);
                // æŠ›å‡ºé”™è¯¯ï¼Œç”±å¤–å±‚ loadM3U8Mode æ•è·å¹¶è¿›è¡Œå›é€€
                throw error; 
            }
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function resetPlayer() {
            if (art) { art.destroy(false); art = null; }
            if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            document.getElementById('artplayer-container').innerHTML = '';
            document.getElementById('artplayer-container').style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            loadingTip.style.display = 'none';
            isSniffed = false;
        }
        
        function clearStatus() {
            statusDiv.style.display = 'none';
        }

        function showStatus(msg, type) {
            statusDiv.textContent = msg;
            statusDiv.style.display = 'block';
            statusDiv.style.color = type === 'error' ? '#fca5a5' : (type === 'success' ? '#86efac' : (type === 'warning' ? '#fcd34d' : '#7dd3fc'));
            statusDiv.style.backgroundColor = type === 'error' ? 'rgba(220,38,38,0.2)' : (type === 'success' ? 'rgba(22,163,74,0.2)' : (type === 'warning' ? 'rgba(251,191,36,0.1)' : '#2a3f4d'));
        }

        function getUrlParameter(name) {
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // --- æŠ•å±é€»è¾‘ ---
        function setupCastButtonLogic(videoElement, sourceUrl) {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            castType = isIOS ? 'airplay' : 'googlecast';

            if (window.WebKitPlaybackTargetAvailabilityEvent) {
                videoElement.addEventListener('webkitplaybacktargetavailabilitychanged', function(event) {
                    if (event.availability === 'available') castType = 'airplay';
                });
            }

            function tryInitCast() {
                if (!isIOS && window.cast && window.cast.framework) castType = 'googlecast';
            }
            if (window.isGCastInitialized) tryInitCast();
            document.addEventListener('google-cast-ready', tryInitCast);

            castBtn.onclick = () => {
                if (currentMode !== 'm3u8') {
                    showStatus('è¯·ç­‰å¾…å—…æ¢æˆåŠŸæˆ–æ‰‹åŠ¨è¾“å…¥ M3U8 åœ°å€åå†æŠ•å±', 'error');
                    return;
                }
                if (castType === 'airplay') {
                    videoElement.webkitShowPlaybackTargetPicker ? videoElement.webkitShowPlaybackTargetPicker() : showStatus('AirPlay æœªå°±ç»ª', 'error');
                } else {
                    if (!window.cast || !window.cast.framework) return showStatus('æŠ•å±åˆå§‹åŒ–ä¸­...', 'info');
                    const session = cast.framework.CastContext.getInstance().getCurrentSession();
                    if (!session) {
                        cast.framework.CastContext.getInstance().requestSession()
                            .then(() => performCast(sourceUrl))
                            .catch(e => { if(e !== 'cancel') showStatus('æŠ•å±è¿æ¥å¤±è´¥: ' + e, 'error'); });
                    } else {
                        performCast(sourceUrl);
                    }
                }
            };
        }

        function performCast(url) {
            const session = cast.framework.CastContext.getInstance().getCurrentSession();
            if (!session) return;
            const mediaInfo = new chrome.cast.media.MediaInfo(url, 'application/x-mpegurl');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = 'Web Video Cast';
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            session.loadMedia(request).then(
                () => showStatus('æ­£åœ¨æŠ•å±ä¸­...', 'success'),
                (e) => showStatus('æŠ•å±åŠ è½½å¤±è´¥: ' + e, 'error')
            );
        }

        loadBtn.addEventListener('click', startPlay);
        input.addEventListener('keydown', (e) => e.key === 'Enter' && startPlay());
        if (input.value && input.value !== 'YOUR_URL_HERE') startPlay();
    });
</script>
</body>
</html>
