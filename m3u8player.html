<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨ (DPlayerç‰ˆ)</title>
    <!-- è§£å†³ Favicon 404 æŠ¥é”™ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“º</text></svg>">
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #app-container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #00ccff; /* DPlayer ä¸»é¢˜è‰² */
            text-align: center;
            margin: 10px 0 20px 0;
            font-size: 1.5rem;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        #control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        #m3u8-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #444;
            background-color: #2d2d2d;
            color: #fff;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }
        #m3u8-input:focus {
            outline: none;
            border-color: #00ccff;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            color: #fff;
            white-space: nowrap;
        }

        #load-button { background-color: #00ccff; color: #000; }
        #load-button:hover { filter: brightness(1.1); }

        #cast-button { background-color: #3b82f6; display: inline-flex; align-items: center; gap: 6px; }
        #cast-button:hover { filter: brightness(1.1); }
        #cast-button:disabled { background-color: #555; color: #888; cursor: not-allowed; }

        /* --- æ’­æ”¾å™¨å®¹å™¨ (å…³é”®èåˆéƒ¨åˆ†) --- */
        #video-wrapper {
            flex-grow: 1;
            width: 100%;
            position: relative;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            aspect-ratio: 16 / 9;
        }

        /* DPlayer å®¹å™¨ */
        #dplayer-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
        }
        
        /* å¼ºåˆ¶è§†é¢‘å…ƒç´ ç¡¬ä»¶åŠ é€Ÿ */
        #dplayer-container video {
            transform: translate3d(0, 0, 0);
            -webkit-transform: translate3d(0, 0, 0);
            will-change: transform;
            backface-visibility: hidden;
        }

        /* è‡ªå®šä¹‰ç»Ÿè®¡é¢æ¿ (è¦†ç›–åœ¨DPlayerä¹‹ä¸Š) */
        #custom-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.85);
            color: #eee;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            z-index: 100;
            pointer-events: none; /* ç‚¹å‡»ç©¿é€ */
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            font-family: Consolas, monospace;
            min-width: 200px;
            display: none;
        }

        /* Iframe ç«é€Ÿå®¹å™¨ */
        .temp-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0; left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 5;
            background: #000;
        }
        
        .iframe-active {
            z-index: 20;
            opacity: 1;
            pointer-events: auto;
        }

        /* --- çŠ¶æ€æç¤º --- */
        #status-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #2a3f4d;
            color: #7dd3fc;
            font-size: 13px;
            display: none;
            white-space: pre-line;
            overflow-wrap: break-word;
        }

        /* å—…æ¢æˆåŠŸåŠ¨ç”» */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .sniff-success {
            animation: pulse-green 1.5s infinite;
            border: 1px solid #4ade80 !important;
        }

        /* --- ç§»åŠ¨ç«¯ä¼˜åŒ– --- */
        @media (max-width: 600px) {
            #app-container { 
                padding: 10px; 
                margin: 0;
                border: none;
                box-shadow: none;
                width: 100%;
                max-width: 100%;
            }
            #control-panel { gap: 8px; }
            #m3u8-input { width: 100%; font-size: 16px; padding: 12px; }
            .btn { flex-grow: 1; padding: 12px; }
            h1 { font-size: 1.2rem; margin: 5px 0 15px 0; }
            #video-wrapper {
                flex-grow: 0;
                width: 100%;
                aspect-ratio: 16 / 9;
                min-height: auto;
                border-radius: 4px;
                border-color: #222;
            }
        }
    </style>
    
    <!-- Google Cast åˆå§‹åŒ– -->
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                try {
                    cast.framework.CastContext.getInstance().setOptions({
                        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                    });
                    window.isGCastInitialized = true;
                    document.dispatchEvent(new Event('google-cast-ready'));
                } catch (e) { console.error('GCast Init Error:', e); }
            }
        };
    </script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</head>
<body>

<div id="app-container">
    <h1>M3U8 æ™ºèƒ½èåˆæ’­æ”¾å™¨</h1>
    
    <div id="control-panel">
        <input type="url" id="m3u8-input" placeholder="è¾“å…¥ M3U8 ç›´é“¾æˆ–è§†é¢‘ç½‘ç«™åœ°å€" value="YOUR_URL_HERE">
        <button id="load-button" class="btn">âš¡ï¸ æ™ºèƒ½æ’­æ”¾</button>
        <button id="cast-button" class="btn">ğŸ“º æŠ•å±</button>
    </div>

    <div id="status-message"></div>

    <div id="video-wrapper">
        <!-- ç«é€Ÿè§£ææ¨¡å¼çš„ Loading æç¤º -->
        <div id="loading-tip" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#888; display:none; z-index:1; text-align:center; width: 100%;">
            <p>æ­£åœ¨ç«é€Ÿè§£æ...</p>
            <p style="font-size:12px; color:#555;">åå°æ­£åœ¨å°è¯•å—…æ¢çœŸå® M3U8 åœ°å€</p>
        </div>
        
        <!-- DPlayer å®¹å™¨ -->
        <div id="dplayer-container"></div>
        <!-- è‡ªå®šä¹‰ç»Ÿè®¡é¢æ¿ -->
        <div id="custom-stats"></div>
        
        <!-- Iframe å®¹å™¨å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>
</div>

<!-- åº“å¼•å…¥: hls.js + DPlayer -->
<script src="https://s4.zstatic.net/ajax/libs/hls.js/1.5.6/hls.min.js" crossorigin="anonymous"></script>
<script src="https://s4.zstatic.net/ajax/libs/dplayer/1.26.0/DPlayer.min.js" crossorigin="anonymous"></script>

<script>
    // --- é…ç½®åŒºåŸŸ ---
    const apiArray = [
        { name: "çº¿è·¯1 (Ckplayer)", url: "https://www.ckplayer.vip/jiexi/?url=" },
        { name: "çº¿è·¯2 (M3u8TV)", url: "https://jx.m3u8.tv/jiexi/?url=" },
        { name: "çº¿è·¯3 (XMFLV)", url: "https://jx.xmflv.com/?url=" },
        { name: "çº¿è·¯4 (YParse)", url: "https://yparse.ik9.cc/index.php?url=" },
        { name: "çº¿è·¯5 (8090g)", url: "https://www.8090g.cn/jiexi/?url=" },
        { name: "çº¿è·¯6 (JSON)", url: "https://json.jiexi.com/?url=", type: 'json' } 
    ];

    // é«˜æ€§èƒ½ HLS é…ç½® (ä¿ç•™æ‚¨çš„ä¼˜åŒ–é…ç½®)
    const hlsConfig = {
        enableWorker: true,
        lowLatencyMode: false,
        startBufferLength: 20,
        maxBufferLength: 120,
        maxMaxBufferLength: 600,
        maxBufferSize: 200 * 1024 * 1024,
        backBufferLength: 90,
        fragLoadingTimeOut: 20000,
        fragLoadingMaxRetry: 6,
        manifestLoadingTimeOut: 20000,
        levelLoadingTimeOut: 20000,
        maxLoadingDelay: 4, 
        minAutoBitrate: 0, 
        capLevelToPlayerSize: false, 
        autoStartLoad: true,
        maxBufferHole: 0.5,
    };

    // --- å…¨å±€å˜é‡ ---
    let dp = null; 
    let hlsInstance = null;
    let castType = 'googlecast'; 
    let currentMode = 'idle';
    let isSniffed = false;
    let statsTimer = null; 
    
    // FPS è®¡ç®—å˜é‡
    let frameCount = 0;
    let currentFPS = 0;
    let lastFrameTime = 0;

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('m3u8-input');
        const loadBtn = document.getElementById('load-button');
        const castBtn = document.getElementById('cast-button');
        const statusDiv = document.getElementById('status-message');
        const wrapper = document.getElementById('video-wrapper');
        const loadingTip = document.getElementById('loading-tip');

        const urlParam = getUrlParameter('url');
        input.value = urlParam || (input.value === 'YOUR_URL_HERE' ? '' : input.value);

        function startPlay() {
            const url = input.value.trim();
            if (!url) return showStatus('è¯·è¾“å…¥è§†é¢‘åœ°å€', 'error');

            resetPlayer();
            
            if (url.includes('.m3u8') || url.startsWith('blob:') || url.startsWith('http://127.0.0.1')) {
                loadM3U8Mode(url);
            } else {
                loadIframeMode(url);
                backgroundSniff(url);
            }
        }
        
        loadBtn.addEventListener('click', startPlay);
        input.addEventListener('keydown', (e) => e.key === 'Enter' && startPlay());

        // --- æ¨¡å¼ A: æœ¬åœ° M3U8 å¢å¼ºæ¨¡å¼ ---
        async function loadM3U8Mode(url, isAutoSniffed = false) {
            currentMode = 'm3u8';
            castBtn.disabled = false;
            isSniffed = true;
            wrapper.classList.remove('sniff-success');
            
            if (isAutoSniffed) {
                showStatus('âœ… å—…æ¢æˆåŠŸï¼å·²åˆ‡æ¢è‡³å¢å¼ºæ¨¡å¼ (å·²å»å¹¿å‘Š/æ”¯æŒæŠ•å±)', 'success');
                wrapper.classList.add('sniff-success');
                setTimeout(() => wrapper.classList.remove('sniff-success'), 2000);
            } else {
                showStatus('æ­£åœ¨è¿›è¡Œæ·±åº¦æ¸…æ´—ä¸åŠ è½½...', 'info');
            }

            let finalUrl = url;
            try {
                const cleanResult = await fetchAndCleanM3u8(url);
                
                if (cleanResult.removedCount > 0) {
                    if (!isAutoSniffed) showStatus(`${cleanResult.log}\næ­£åœ¨ç”Ÿæˆçº¯å‡€æµ...`, 'success');
                    const blob = new Blob([cleanResult.content], { type: 'application/vnd.apple.mpegurl' });
                    finalUrl = URL.createObjectURL(blob);
                } else {
                    if (!isAutoSniffed) showStatus('æ— éœ€æ¸…æ´—ï¼Œå‡†å¤‡æ’­æ”¾...', 'info');
                }

            } catch (e) {
                console.warn('æ¸…æ´—è·³è¿‡:', e);
                if (!isAutoSniffed) {
                    const msg = e.name === 'AbortError' 
                        ? 'âš ï¸ å¹¿å‘Šåˆ†æè¶…æ—¶ï¼Œè·³è¿‡æ¸…æ´—ç›´æ¥æ’­æ”¾...' 
                        : 'âš ï¸ ç›®æ ‡èµ„æºç¦æ­¢è·¨åŸŸè®¿é—®ï¼Œæ— æ³•å»å¹¿å‘Šï¼Œå°†å°è¯•ç›´æ¥æ’­æ”¾...';
                    showStatus(msg, 'warning');
                }
            }

            initDPlayer(finalUrl, url);
        }

        // --- åˆå§‹åŒ– DPlayer (æ›¿ä»£ Artplayer) ---
        function initDPlayer(videoUrl, originalUrl) {
            if (dp) dp.destroy();
            stopStatsLoop();
            
            dp = new DPlayer({
                container: document.getElementById('dplayer-container'),
                autoplay: true,
                theme: '#00ccff',
                lang: 'zh-cn',
                screenshot: true,
                hotkey: true,
                airplay: true,
                chromecast: true,
                volume: 0.7,
                video: {
                    url: videoUrl,
                    type: 'customHls', 
                    customType: {
                        customHls: function(video, player) {
                            if (Hls.isSupported()) {
                                if (hlsInstance) hlsInstance.destroy();
                                hlsInstance = new Hls(hlsConfig);
                                hlsInstance.loadSource(videoUrl);
                                hlsInstance.attachMedia(video);
                                
                                hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                                    // è‡ªåŠ¨é”å®šæœ€é«˜ç”»è´¨ (æ¨¡æ‹Ÿ60fpsä¼˜å…ˆ)
                                    if(hlsInstance.levels.length > 0) {
                                        hlsInstance.currentLevel = hlsInstance.levels.length - 1;
                                        hlsInstance.capLevelToPlayerSize = false;
                                        console.log('å·²è‡ªåŠ¨é”å®šè‡³æœ€é«˜ç”»è´¨/å¸§ç‡');
                                        showStatus('ğŸš€ ç”»è´¨å¢å¼ºï¼šå·²é”å®šæœ€é«˜ç ç‡/å¸§ç‡', 'success');
                                    }
                                    startStatsLoop(video, hlsInstance);
                                    video.play().catch(e => console.warn('Autoplay blocked', e));
                                });

                                hlsInstance.on(Hls.Events.ERROR, function(event, data) {
                                    if (data.fatal) {
                                        switch(data.type) {
                                            case Hls.ErrorTypes.NETWORK_ERROR:
                                                hlsInstance.startLoad();
                                                break;
                                            case Hls.ErrorTypes.MEDIA_ERROR:
                                                hlsInstance.recoverMediaError();
                                                break;
                                            default:
                                                showStatus('âŒ æ’­æ”¾å¤±è´¥: æ— æ³•åŠ è½½è§†é¢‘æµ', 'error');
                                                hlsInstance.destroy();
                                                break;
                                        }
                                    }
                                });
                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                video.src = videoUrl;
                                startStatsLoop(video, null);
                            }
                        }
                    }
                },
                contextmenu: [
                    {
                        text: 'ç»Ÿè®¡ä¿¡æ¯å¼€å…³',
                        click: (player) => {
                            const stats = document.getElementById('custom-stats');
                            stats.style.display = stats.style.display === 'none' ? 'block' : 'none';
                        }
                    },
                    {
                        text: 'å…³äº M3U8 èåˆæ’­æ”¾å™¨',
                        link: 'javascript:void(0);'
                    }
                ]
            });

            // æŠ•å±æŒ‰é’®é€»è¾‘ç»‘å®š
            // æ³¨æ„ï¼šChromecast ä¸æ”¯æŒ blob: URLã€‚å¦‚æœæ¸…æ´—è¿‡(æ˜¯Blob)ï¼Œåˆ™æŠ•å±æ—¶ä¼˜å…ˆä½¿ç”¨åŸå§‹URL
            // è¿™é‡Œæˆ‘ä»¬ä¼ å…¥ originalUrl ç»™æŠ•å±é€»è¾‘ï¼Œè™½ç„¶ä¼šæœ‰å¹¿å‘Šï¼Œä½†èƒ½ä¿è¯æŠ•å±æˆåŠŸ
            setupCastButtonLogic(dp.video, originalUrl);
            
            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé•¿æŒ‰å‘¼å‡ºèœå• (æ¨¡æ‹Ÿå³é”®)
            setupMobileLongPress(dp);
            
            dp.on('canplay', () => {
                 setTimeout(() => clearStatus(), 3000);
            });
        }
        
        // --- ç§»åŠ¨ç«¯é•¿æŒ‰æ¨¡æ‹Ÿå³é”® ---
        function setupMobileLongPress(player) {
            const container = player.container;
            let timer = null;
            
            container.addEventListener('touchstart', (e) => {
                if(e.touches.length > 1) return;
                timer = setTimeout(() => {
                    // è§¦å‘é•¿æŒ‰ï¼šæ˜¾ç¤ºç»Ÿè®¡é¢æ¿æˆ– DPlayer èœå•
                    // è¿™é‡Œæˆ‘ä»¬ç®€å•åˆ‡æ¢ç»Ÿè®¡é¢æ¿æ˜¾ç¤ºï¼Œç»™ç”¨æˆ·åé¦ˆ
                    const stats = document.getElementById('custom-stats');
                    stats.style.display = stats.style.display === 'none' ? 'block' : 'none';
                    if(navigator.vibrate) navigator.vibrate(50);
                    
                    // ä¹Ÿå¯ä»¥å°è¯•æ¨¡æ‹Ÿå³é”®äº‹ä»¶è§¦å‘ DPlayer èœå•ï¼Œä½†åŸç”Ÿèœå•åœ¨ç§»åŠ¨ç«¯å…¼å®¹æ€§ä¸ä¸€
                    // const evt = new MouseEvent('contextmenu', {
                    //     bubbles: true, cancelable: true,
                    //     view: window, clientX: e.touches[0].clientX, clientY: e.touches[0].clientY
                    // });
                    // container.dispatchEvent(evt);
                    
                    showStatus(stats.style.display === 'block' ? 'ğŸ“Š ç»Ÿè®¡é¢æ¿å·²å¼€å¯' : 'ğŸ“Š ç»Ÿè®¡é¢æ¿å·²å…³é—­', 'info');
                }, 600); // 600ms é•¿æŒ‰
            }, {passive: true});
            
            const clear = () => { if(timer) clearTimeout(timer); };
            container.addEventListener('touchend', clear);
            container.addEventListener('touchmove', clear);
        }

        function stopStatsLoop() {
             if(statsTimer) clearInterval(statsTimer);
             statsTimer = null;
             document.getElementById('custom-stats').style.display = 'none';
        }

        // --- ç»Ÿè®¡ä¿¡æ¯é€»è¾‘ ---
        function startStatsLoop(video, hls) {
            if(statsTimer) clearInterval(statsTimer);
            
            // FPS è®¡ç®—
            frameCount = 0;
            currentFPS = 0;
            lastFrameTime = performance.now();

            const frameCallback = (now, metadata) => {
                frameCount++;
                const elapsed = now - lastFrameTime;
                if (elapsed >= 1000) {
                    currentFPS = frameCount; 
                    frameCount = 0;
                    lastFrameTime = now;
                }
                if(video.requestVideoFrameCallback) video.requestVideoFrameCallback(frameCallback);
            };
            if ('requestVideoFrameCallback' in video) video.requestVideoFrameCallback(frameCallback);

            const statsEl = document.getElementById('custom-stats');

            const updateStatsUI = () => {
                if(statsEl.style.display === 'none') return;
                
                // åˆ†è¾¨ç‡/ç ç‡
                let resolution = `${video.videoWidth} x ${video.videoHeight}`;
                let bitrate = 'N/A';
                
                if (hls && hls.levels) {
                    const levelIndex = hls.currentLevel === -1 ? (hls.autoLevelEnabled ? hls.nextAutoLevel : -1) : hls.currentLevel;
                    const level = hls.levels[levelIndex];
                    if (level) {
                        if (level.width) resolution = `${level.width} x ${level.height}`;
                        if (level.bitrate) bitrate = (level.bitrate / 1000).toFixed(0) + ' kbps';
                    }
                }

                const buffer = video.buffered.length ? (video.buffered.end(video.buffered.length-1) - video.currentTime).toFixed(1) : 0;
                let dropped = 0;
                let displayFPS = currentFPS;
                
                if (video.getVideoPlaybackQuality) dropped = video.getVideoPlaybackQuality().droppedVideoFrames;
                if (video.paused) displayFPS = 0;

                statsEl.innerHTML = `
                    <div style="color:#00ccff;border-bottom:1px solid #555;margin-bottom:5px;">ğŸ“Š å®æ—¶ç›‘æ§ (DPlayer)</div>
                    <div>FPS: <span style="color:${displayFPS >= 50 ? '#00ccff' : '#fff'}">${displayFPS}</span></div>
                    <div>RES: ${resolution}</div>
                    <div>BIT: ${bitrate}</div>
                    <div>BUF: ${buffer} s</div>
                    <div>DRP: ${dropped}</div>
                `;
            };
            
            statsTimer = setInterval(updateStatsUI, 500);
            updateStatsUI();
        }

        // --- æ¨¡å¼ B: Iframe ç«é€Ÿè§£ææ¨¡å¼ (èµ¢å®¶é€šåƒä¼˜åŒ–) ---
        function loadIframeMode(url) {
            currentMode = 'iframe';
            castBtn.disabled = true; 
            isSniffed = false;
            showStatus('è¯†åˆ«ä¸ºç½‘é¡µé“¾æ¥ï¼Œæ­£åœ¨ç«é€Ÿè§£æ... (ç¨åè‹¥å‡ºç°æŠ•å±æŒ‰é’®è¯´æ˜å—…æ¢æˆåŠŸ)', 'info');
            loadingTip.style.display = 'block';

            let hasWinner = false; 

            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());

            apiArray.forEach(api => {
                const iframe = document.createElement('iframe');
                iframe.className = 'temp-iframe';
                iframe.allowFullscreen = true; 
                iframe.setAttribute('allowFullScreen', '');
                iframe.allow = "autoplay; fullscreen; picture-in-picture; encrypted-media; gyroscope; accelerometer";
                iframe.src = api.url + url;
                
                iframe.onload = function() {
                    if (isSniffed) return;
                    if (hasWinner) return; 

                    hasWinner = true;
                    
                    const allIframes = document.querySelectorAll('.temp-iframe');
                    allIframes.forEach(el => {
                        if (el !== iframe) {
                            el.src = 'about:blank'; 
                            el.remove(); 
                        }
                    });

                    displayIframe(this, api.name);
                };
                wrapper.appendChild(iframe);
            });
        }

        function displayIframe(iframe, apiName) {
            if (isSniffed) return;
            loadingTip.style.display = 'none';
            showStatus(`è§£ææˆåŠŸï¼å½“å‰çº¿è·¯: ${apiName} (æš‚æœªæå–åˆ°ç›´é“¾ï¼Œä¸æ”¯æŒæŠ•å±)`, 'info');
            document.getElementById('dplayer-container').style.display = 'none';
            iframe.classList.add('iframe-active');
            
            const manualBtn = document.createElement('span');
            manualBtn.innerHTML = " [æˆ‘æœ‰M3U8åœ°å€]";
            manualBtn.style.cursor = 'pointer';
            manualBtn.style.color = '#00ccff';
            manualBtn.onclick = () => {
                const manualUrl = prompt("å¦‚æœæ‚¨æŠ“åŒ…åˆ°äº† M3U8 åœ°å€ï¼Œè¯·ç²˜è´´åœ¨è¿™é‡Œä»¥å¼€å¯æŠ•å±å’ŒåŠ é€Ÿï¼š");
                if(manualUrl && manualUrl.includes('.m3u8')) loadM3U8Mode(manualUrl, true);
            };
            statusDiv.appendChild(manualBtn);
        }

        // --- æ ¸å¿ƒå¢å¼ºï¼šåå°å—…æ¢é€»è¾‘ ---
        async function backgroundSniff(videoPageUrl) {
            console.log('å¯åŠ¨åå°å—…æ¢ä»»åŠ¡...');
            const regex = /["'](https?:\/\/[^"']+\.m3u8[^"']*)["']/;

            const msgHandler = (e) => {
                if (e.data && typeof e.data === 'string') {
                    const match = e.data.match(regex);
                    if (match) {
                        window.removeEventListener('message', msgHandler);
                        loadM3U8Mode(match[1], true);
                    }
                }
                if (e.data && e.data.type === 'video_url' && e.data.url) {
                     window.removeEventListener('message', msgHandler);
                     loadM3U8Mode(e.data.url, true);
                }
            };
            window.addEventListener('message', msgHandler);
            
            for (const api of apiArray) {
                if(isSniffed) break;
                try {
                    const targetUrl = api.url + videoPageUrl;
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); 
                    
                    const response = await fetch(targetUrl, { 
                        method: 'GET',
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const text = await response.text();
                        const match = text.match(regex);
                        if (match && !isSniffed) {
                            loadM3U8Mode(match[1], true);
                            break; 
                        }
                    }
                } catch (e) { }
            }
        }

        // --- å¹¿å‘Šæ¸…æ´—é€»è¾‘ ---
        async function fetchAndCleanM3u8(url) {
            const toAbsolute = (p, b) => { try { return new URL(p, b).href; } catch(e) { return p; } };

            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const originalContent = await response.text();
            
            const lines = originalContent.split(/\r?\n/);
            const segments = [];
            const fingerprintCounts = {};
            
            // 1. ç‰¹å¾åˆ†æ
            lines.forEach((line, idx) => {
                const trimmed = line.trim();
                if(!trimmed || trimmed.startsWith('#')) return;
                
                const absUrl = toAbsolute(trimmed, url);
                let u;
                try { u = new URL(absUrl); } catch(e) { return; }
                
                const pathParts = u.pathname.split('/');
                pathParts.pop();
                const dir = pathParts.join('/');
                const ext = u.pathname.split('.').pop();
                const fp = `${u.hostname}|${dir}|${ext}`;
                
                if(!fingerprintCounts[fp]) fingerprintCounts[fp] = 0;
                fingerprintCounts[fp]++;
                
                segments.push({ idx, fp });
            });
            
            // 2. æŸ¥æ‰¾ä¸»ç‰¹å¾
            let dominantFp = '', maxC = 0;
            for(const [fp, c] of Object.entries(fingerprintCounts)) {
                if(c > maxC) { maxC = c; dominantFp = fp; }
            }
            
            // é˜ˆå€¼åˆ¤å®šï¼šä¸»ç‰¹å¾å æ¯” < 50% åˆ™ä¸æ¸…æ´—
            if(segments.length === 0 || (maxC / segments.length) < 0.5) {
                return { content: originalContent, removedCount: 0, log: 'ç»“æ„è¿‡äºç¦»æ•£ï¼Œæœªæ¸…æ´—' };
            }

            // 3. æ„å»ºæ–°å†…å®¹
            const linesToRemove = new Set();
            segments.forEach(seg => {
                if(seg.fp !== dominantFp) {
                    linesToRemove.add(seg.idx);
                    // å›æº¯åˆ é™¤ EXTINF
                    let j = seg.idx - 1;
                    while(j >= 0) {
                        const l = lines[j].trim();
                        if(l.startsWith('#EXTINF') || l.startsWith('#EXT-X-BYTERANGE')) {
                            linesToRemove.add(j);
                            j--;
                        } else {
                            break;
                        }
                    }
                }
            });

            const newLines = [];
            lines.forEach((line, idx) => {
                if(linesToRemove.has(idx)) return;
                let content = line.trim();
                if(!content) return;
                
                if(content.startsWith('#')) {
                    if(content.startsWith('#EXT-X-KEY') && content.includes('URI="')) {
                        content = content.replace(/URI="([^"]+)"/, (match, p1) => {
                             if(p1.startsWith('http') || p1.startsWith('//')) return match;
                             return `URI="${toAbsolute(p1, url)}"`;
                        });
                    }
                    newLines.push(content);
                } else {
                    newLines.push(toAbsolute(content, url));
                }
            });
            
            return {
                content: newLines.join('\n'),
                removedCount: segments.length - maxC,
                log: `å·²ç§»é™¤ ${segments.length - maxC} ä¸ªå¼‚å¸¸åˆ†ç‰‡`
            };
        }

        // --- æŠ•å±é€»è¾‘ ---
        function setupCastButtonLogic(videoEl, originalUrl) {
            const castBtn = document.getElementById('cast-button');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            let mode = isIOS ? 'airplay' : 'googlecast';
            if (window.WebKitPlaybackTargetAvailabilityEvent) {
                 videoEl.addEventListener('webkitplaybacktargetavailabilitychanged', e => {
                     if (e.availability === 'available') mode = 'airplay';
                 });
            }

            if(!isIOS && window.isGCastInitialized) {
                castType = 'googlecast';
            }

            castBtn.onclick = () => {
                if(mode === 'airplay') {
                    if(videoEl.webkitShowPlaybackTargetPicker) {
                        videoEl.webkitShowPlaybackTargetPicker();
                    } else {
                        showStatus('AirPlay ä¸å¯ç”¨', 'error');
                    }
                } else {
                    if(!window.cast || !window.cast.framework) {
                        return showStatus('æŠ•å±æœåŠ¡æœªå°±ç»ª (è¯·ç¡®ä¿èƒ½è®¿é—® Google æœåŠ¡)', 'warning');
                    }
                    const ctx = cast.framework.CastContext.getInstance();
                    const session = ctx.getCurrentSession();
                    if(!session) {
                        ctx.requestSession().then(() => {
                            const session = ctx.getCurrentSession();
                            const mediaInfo = new chrome.cast.media.MediaInfo(originalUrl, 'application/x-mpegurl');
                            const request = new chrome.cast.media.LoadRequest(mediaInfo);
                            session.loadMedia(request);
                        }).catch(e => {
                            if(e !== 'cancel') showStatus('æŠ•å±è¿æ¥å¤±è´¥', 'error');
                        });
                    } else {
                        const mediaInfo = new chrome.cast.media.MediaInfo(originalUrl, 'application/x-mpegurl');
                        const request = new chrome.cast.media.LoadRequest(mediaInfo);
                        session.loadMedia(request);
                    }
                }
            };
        }
        
        // --- å·¥å…·å‡½æ•° ---
        function resetPlayer() {
            if (dp) { dp.destroy(); dp = null; }
            if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
            stopStatsLoop();
            document.getElementById('dplayer-container').style.display = 'block';
            document.querySelectorAll('.temp-iframe').forEach(el => el.remove());
            clearStatus();
        }

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('status-message');
            el.textContent = msg;
            el.style.display = 'block';
            el.style.color = type === 'error' ? '#fca5a5' : (type === 'success' ? '#86efac' : '#7dd3fc');
            el.style.backgroundColor = type === 'error' ? 'rgba(220,38,38,0.2)' : (type === 'success' ? 'rgba(22,163,74,0.2)' : '#2a3f4d');
        }

        function clearStatus() {
            document.getElementById('status-message').style.display = 'none';
        }

        function getUrlParameter(name) {
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        if(getUrlParameter('url')) {
            setTimeout(startPlay, 500);
        }
    });
</script>

</body>
</html>
