<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 æ’­æ”¾å™¨ (ç»ˆæå¹¿å‘Šå‡€åŒ–ç‰ˆ)</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        #app-container { max-width: 1000px; margin: 40px auto; padding: 20px; background-color: #fff; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 12px; }
        h1 { color: #2c3e50; text-align: center; }
        #control-panel { display: flex; gap: 15px; margin-bottom: 30px; align-items: center; }
        #m3u8-input { flex-grow: 1; padding: 12px 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #load-button { padding: 12px 25px; background-color: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #load-button:hover { background-color: #34495e; }
        #video-container { width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 8px; overflow: hidden; position: relative; }
        #video { width: 100%; height: 100%; }
        #status-message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
        #debug-info { position: absolute; bottom: 5px; left: 5px; background-color: rgba(0,0,0,0.7); color: #0f0; padding: 5px 10px; font-size: 12px; border-radius: 3px; z-index: 10; font-family: monospace; pointer-events: none; }
        @media (max-width: 600px) { #control-panel { flex-direction: column; } #m3u8-input, #load-button { width: 100%; } }
    </style>
</head>
<body>

<div id="app-container">
    <h1>M3U8 æ’­æ”¾å™¨ (ç»ˆæå¹¿å‘Šå‡€åŒ–ç‰ˆ)</h1>
    <p style="text-align: center; color: #777;">å·²å¯ç”¨åŸºäºâ€œå®Œæ•´ç‰‡æ®µå•å…ƒâ€çš„å¼ºåŠ›è¿‡æ»¤ã€‚æŒ‰ F12 æŸ¥çœ‹è¯¦ç»†è¿‡æ»¤æ—¥å¿—ã€‚</p>

    <div id="control-panel">
        <input type="url" id="m3u8-input" placeholder="åœ¨æ­¤ç²˜è´´ M3U8 åœ°å€" value="">
        <button id="load-button">âš¡ï¸ å‡€åŒ–å¹¶æ’­æ”¾</button>
    </div>
    
    <div id="status-message"></div>
    <div id="video-container">
        <video id="video" controls></video>
        <div id="debug-info">ç­‰å¾…åŠ è½½...</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const input = document.getElementById('m3u8-input');
        const button = document.getElementById('load-button');
        const statusDiv = document.getElementById('status-message');
        const debugDiv = document.getElementById('debug-info');
        
        let adFragmentsRemoved = 0;
        let targetSignature = '';

        // --- è¾…åŠ©å‡½æ•° ---
        function showStatus(msg, type = 'info') {
            statusDiv.textContent = msg;
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = type === 'error' ? '#f2dede' : (type === 'success' ? '#dff0d8' : '#d9edf7');
            statusDiv.style.color = type === 'error' ? '#a94442' : (type === 'success' ? '#3c763d' : '#31708f');
        }
        
        function getUrlParam(name) {
            const results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(location.search);
            return results ? decodeURIComponent(results[1]) : '';
        }

        // **æ ¸å¿ƒ 1: æå–æµID (ç­¾å)**
        // é’ˆå¯¹ç±»ä¼¼ /20241116/GsUnW9HR/1100kb/ çš„è·¯å¾„
        function extractSignature(url) {
            try {
                const path = new URL(url).pathname;
                // åŒ¹é… 8ä½ä»¥ä¸Šå­—æ¯æ•°å­—çš„IDï¼Œé€šå¸¸åœ¨ /kb å‰é¢
                const match = path.match(/\/([a-zA-Z0-9]{8,})\//);
                return match ? match[1] : '';
            } catch(e) { return ''; }
        }

        function updateDebugDisplay(hls) {
            if (!hls || !hls.currentLevel) return;
            const buf = video.buffered.length ? (video.buffered.end(video.buffered.length-1) - video.currentTime).toFixed(1) : 0;
            const lvl = hls.levels[hls.currentLevel];
            debugDiv.innerHTML = `ID: ${targetSignature} | æ‹¦æˆªå¹¿å‘Šæ•°: ${adFragmentsRemoved} <br> ç¼“å­˜: ${buf}s | ç ç‡: ${(lvl.bitrate/1000).toFixed(0)}k`;
        }

        // **æ ¸å¿ƒ 2: å¼ºåŠ› M3U8 æ¸…æ´—é€»è¾‘**
        function purifyManifest(manifest, signature) {
            if (!signature) return manifest;

            const lines = manifest.split('\n');
            let outputLines = [];
            let buffer = []; // æš‚å­˜å½“å‰ç‰‡æ®µçš„å…ƒæ•°æ® (Key, Inf)
            let removedCount = 0;

            lines.forEach((line, index) => {
                const trimLine = line.trim();
                
                if (!trimLine) return; // è·³è¿‡ç©ºè¡Œ

                // 1. æ£€æŸ¥æ˜¯å¦ä¸ºå…¨å±€æ ‡ç­¾æˆ–åˆ†éš”ç¬¦ (ç›´æ¥ä¿ç•™)
                // æ³¨æ„ï¼šDiscontinuity ä¿ç•™æ˜¯ä¸ºäº†é˜²æ­¢æ—¶é—´è½´é”™ä¹±ï¼Œä½†å¦‚æœå®ƒç´§æŒ¨ç€è¢«åˆ çš„å¹¿å‘Šï¼Œä¹Ÿä¸å½±å“
                if (trimLine.startsWith('#EXTM3U') || 
                    trimLine.startsWith('#EXT-X-VERSION') ||
                    trimLine.startsWith('#EXT-X-TARGETDURATION') ||
                    trimLine.startsWith('#EXT-X-MEDIA-SEQUENCE') ||
                    trimLine.startsWith('#EXT-X-PLAYLIST-TYPE') ||
                    trimLine.startsWith('#EXT-X-DISCONTINUITY')) {
                    
                    // å¦‚æœç¼“å†²åŒºé‡Œæœ‰æ®‹ç•™çš„ Key/Inf (å³å¹¿å‘Šåçš„æ®‹ç•™)ï¼Œæ¸…ç©ºå®ƒä»¬ï¼Œå› ä¸ºæ–°çš„æ®µè½å¼€å§‹äº†
                    buffer = []; 
                    outputLines.push(line);
                    return;
                }

                // 2. æ£€æŸ¥æ˜¯å¦ä¸ºç‰‡æ®µå…ƒæ•°æ® (å­˜å…¥ç¼“å†²åŒº)
                if (trimLine.startsWith('#EXT-X-KEY') || 
                    trimLine.startsWith('#EXTINF') || 
                    trimLine.startsWith('#EXT-X-PROGRAM-DATE-TIME')) {
                    buffer.push(line);
                    return;
                }

                // 3. åˆ°äº†è¿™é‡Œï¼Œè¿™è¡Œåº”è¯¥æ˜¯ URL (å› ä¸ºå®ƒä¸æ˜¯#å¼€å¤´ï¼Œæˆ–æ˜¯æ³¨é‡Š)
                if (!trimLine.startsWith('#')) {
                    // è¿™æ˜¯ä¸€ä¸ªå®Œæ•´å•å…ƒï¼šç¼“å†²åŒº + URL
                    const fullSegmentString = buffer.join('') + trimLine;

                    // **åˆ¤å®šæ ¸å¿ƒ**: æ•´ä¸ªå•å…ƒï¼ˆåŒ…æ‹¬KEYåœ°å€å’Œåˆ†ç‰‡åœ°å€ï¼‰æ˜¯å¦åŒ…å«ç­¾åï¼Ÿ
                    if (fullSegmentString.includes(signature)) {
                        // åŒ…å«ç­¾å -> æ˜¯æ­£ç‰‡ -> ä¿ç•™
                        outputLines = outputLines.concat(buffer);
                        outputLines.push(line);
                    } else {
                        // ä¸åŒ…å«ç­¾å -> æ˜¯å¹¿å‘Š -> ä¸¢å¼ƒ
                        removedCount++;
                        // æ§åˆ¶å°è¾“å‡ºç¬¬ä¸€æ¡è¢«åˆ å¹¿å‘Šçš„è¯¦æƒ…ä¾›è°ƒè¯•
                        if (removedCount === 1) console.warn("ğŸš« é¦–æ¬¡æ‹¦æˆªå¹¿å‘Šæ ·æœ¬:", trimLine);
                    }
                    
                    // å¤„ç†å®Œä¸€ä¸ªå•å…ƒï¼Œæ¸…ç©ºç¼“å†²åŒº
                    buffer = [];
                } else {
                    // å…¶ä»–æœªçŸ¥çš„ # æ ‡ç­¾ï¼Œé»˜è®¤ä¿ç•™
                    outputLines.push(line);
                }
            });

            adFragmentsRemoved = removedCount;
            console.log(`[Purify] æ¸…æ´—å®Œæˆã€‚åŸè¡Œæ•°: ${lines.length}, æ–°è¡Œæ•°: ${outputLines.length}, ç§»é™¤ç‰‡æ®µ: ${removedCount}`);
            return outputLines.join('\n');
        }

        // --- åŠ è½½é€»è¾‘ ---
        function loadVideo(url) {
            if (!url) return alert('è¯·è¾“å…¥ URL');
            
            // é‡ç½®çŠ¶æ€
            if (window.hls) window.hls.destroy();
            adFragmentsRemoved = 0;
            targetSignature = extractSignature(url);
            
            showStatus(`æ­£åœ¨åˆ†ææµ... ç›®æ ‡ID: ${targetSignature || 'æœªè¯†åˆ«(å°†ä¸é€šè¿‡è¿‡æ»¤)'}`);
            console.log(`[Init] ç›®æ ‡ç­¾å: ${targetSignature}`);

            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: true,
                    // å¼ºåˆ¶ä½¿ç”¨ XHR åŠ è½½ä»¥ä¾¿æ‹¦æˆªï¼Œä¸ä½¿ç”¨ fetch
                    xhrSetup: function(xhr, u) {
                        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è¯·æ±‚å¤´ï¼Œå¦‚æœéœ€è¦
                    }
                });
                window.hls = hls;

                // **æ‹¦æˆªå¹¶é‡å†™ M3U8**
                // ä½¿ç”¨ pLoader (Playlist Loader) æ‹¦æˆªæ˜¯ä¸ªå¥½åŠæ³•ï¼Œä½†åˆ©ç”¨äº‹ä»¶æœ€ç®€å•å…¼å®¹
                // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šhls.js ä¸‹è½½å®Œæ–‡æœ¬åï¼Œè§¦å‘ MANIFEST_LOADEDï¼Œæˆ‘ä»¬ä¿®æ”¹ data.response.data
                hls.on(Hls.Events.MANIFEST_LOADED, (event, data) => {
                    if (targetSignature) {
                        try {
                            const originalData = data.response.data;
                            const cleanData = purifyManifest(originalData, targetSignature);
                            // ä¿®æ”¹ HLS å†…éƒ¨æ•°æ®
                            data.response.data = cleanData;
                            // åŒæ—¶ä¹Ÿä¿®æ”¹ networkDetails é‡Œçš„æ•°æ®ï¼Œä»¥é˜²ä¸‡ä¸€
                            if(data.networkDetails) data.networkDetails.response = cleanData;
                            
                            showStatus(`å‡€åŒ–æˆåŠŸï¼å·²æ‹¦æˆª ${adFragmentsRemoved} ä¸ªå¹¿å‘Šç‰‡æ®µã€‚`, 'success');
                        } catch (e) {
                            console.error("æ¸…æ´—å‡ºé”™:", e);
                        }
                    }
                });

                hls.on(Hls.Events.ERROR, (e, data) => {
                    if (data.fatal) {
                        console.error("è‡´å‘½é”™è¯¯", data);
                        showStatus(`æ’­æ”¾é”™è¯¯: ${data.details}`, 'error');
                        hls.startLoad();
                    }
                });

                hls.loadSource(url);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play().catch(() => console.log("éœ€æ‰‹åŠ¨æ’­æ”¾"));
                    setInterval(() => updateDebugDisplay(hls), 1000);
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // iOS Safari ä¸æ”¯æŒæ‹¦æˆªä¿®æ”¹ M3U8ï¼Œåªèƒ½ç›´æ¥æ’­æ”¾
                video.src = url;
                showStatus('iOS åŸç”Ÿæ’­æ”¾æ¨¡å¼ (æ— æ³•æ‹¦æˆªå†…ç½®å¹¿å‘Š)', 'error');
            }
        }

        // --- åˆå§‹åŒ– ---
        const urlParam = getUrlParam('url');
        if (urlParam) input.value = urlParam;
        if (input.value) loadVideo(input.value);

        button.onclick = () => loadVideo(input.value.trim());
        input.onkeydown = (e) => e.key === 'Enter' && loadVideo(input.value.trim());
    });
</script>

</body>
</html>
