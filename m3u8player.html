<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>M3U8 播放器（自动去除异常分片）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;font-family:Segoe UI,Helvetica,Arial,sans-serif;background:#f4f7f6;color:#333}
#app{max-width:1000px;margin:40px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.1)}
h1{text-align:center;color:#2c3e50}
#ctrl{display:flex;gap:15px;margin-bottom:20px}
#urlInp{flex:1;padding:12px;border:1px solid #ccc;border-radius:8px;font-size:16px}
#loadBtn{padding:12px 25px;background:#2c3e50;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:16px}
#loadBtn:hover{background:#34495e}
#videoBox{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden}
#video{width:100%;height:100%}
#debug{position:absolute;bottom:5px;left:5px;background:rgba(0,0,0,.6);color:#fff;padding:4px 8px;font-size:12px;border-radius:3px}
#status{margin-top:15px;padding:10px;border-radius:4px;font-weight:bold;display:none}
.success{background:#d9edf7;color:#31708f}
.error{background:#f2dede;color:#a94442}
@media(max-width:600px){
 #ctrl{flex-direction:column}
 #urlInp,#loadBtn{width:100%;box-sizing:border-box}
}
</style>
</head>
<body>

<div id="app">
  <h1>M3U8 播放器（自动去除异常分片）</h1>
  <div id="ctrl">
    <input id="urlInp" type="url" placeholder="粘贴 M3U8 地址，或通过 ?url= 参数加载">
    <button id="loadBtn">⚡ 加载并播放</button>
  </div>
  <div id="status"></div>
  <div id="videoBox">
    <video id="video" controls></video>
    <div id="debug"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
(() => {
  const video   = document.getElementById('video');
  const urlInp  = document.getElementById('urlInp');
  const loadBtn = document.getElementById('loadBtn');
  const status  = document.getElementById('status');
  const debug   = document.getElementById('debug');

  /* ---------- 工具 ---------- */
  const log = (msg, err = false) => {
    status.textContent = msg;
    status.className   = err ? 'error' : 'success';
    status.style.display = 'block';
  };
  const clear = () => status.style.display = 'none';

  /* 获取 URL 参数 */
  const getParam = name => {
    const m = new RegExp('[?&]' + name + '=([^&#]*)').exec(location.search);
    return m ? decodeURIComponent(m[1]) : '';
  };

  /* ---------- M3U8 过滤 ---------- */
  /* 返回 Blob URL（过滤后） */
   /* ---------- 修正版 过滤函数 ---------- */
  async function filterM3U8(rawUrl) {
    const text = await fetch(rawUrl).then(r => {
      if (!r.ok) throw new Error('网络错误 ' + r.status);
      return r.text();
    });
    const lines = text.split(/\r?\n/);

    /* 1. 统计每个 URI 前缀出现次数 */
    const counter = {};
    let maxKey  = '', maxCnt = 0;
    for (let i = 0; i < lines.length; i++) {
      const m = lines[i].match(/^#EXT-X-KEY:.*?URI="([^"]+)"/);
      if (!m) continue;
      const prefix = m[1].split('/').slice(0, -1).join('/');
      const c = (counter[prefix] || 0) + 1;
      counter[prefix] = c;
      if (c > maxCnt) { maxCnt = c; maxKey = prefix; }
    }
    if (!maxKey) return rawUrl;          // 无 KEY 直接返回原地址

    /* 2. 只保留与 maxKey 一致的分片，其余丢弃 */
    const out = [];
    let skip = false;
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      /* 遇到 KEY 行就决定是否跳过 */
      const km = line.match(/^#EXT-X-KEY:.*?URI="([^"]+)"/);
      if (km) {
        const prefix = km[1].split('/').slice(0, -1).join('/');
        skip = prefix !== maxKey;
      }
      if (!skip) out.push(line);
    }
    const blob = new Blob([out.join('\n')], { type: 'application/vnd.apple.mpegurl' });
    return URL.createObjectURL(blob);
  }

  /* ---------- 播放器 ---------- */
  let hlsInst = null, debugTimer = null;

  async function playM3U8(url) {
    if (!url) return log('请先输入 M3U8 地址', true);
    clear();
    log('正在过滤异常分片并加载……');

    if (hlsInst) { hlsInst.destroy(); hlsInst = null; }
    if (debugTimer) { clearInterval(debugTimer); debugTimer = null; }

    let src;
    try { src = await filterM3U8(url); }
    catch (e) { log('过滤失败：' + e.message, true); return; }

    if (Hls.isSupported()) {
      const hls = new Hls({
        startBufferLength: 8,
        maxBufferLength: 60,
        maxBufferSize: 100 * 1024 * 1024,
        fragLoadingTimeOut: 15000,
        fragLoadingMaxRetry: 5,
        fragLoadingMaxConnections: 6
      });
      hlsInst = hls;
      hls.loadSource(src);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        log('加载成功，开始播放');
        video.play().catch(() => log('浏览器拦截自动播放，请手动点击播放', false));
        debugTimer = setInterval(() => {
          const buf = video.buffered.length ? (video.buffered.end(0) - video.currentTime).toFixed(1) : '0.0';
          const lvl = hls.levels[hls.currentLevel];
          const br  = lvl ? (lvl.bitrate / 1000).toFixed(0) : '?';
          debug.textContent = `缓存: ${buf}s | 码率: ${br} kbps`;
        }, 1000);
      });
      hls.on(Hls.Events.ERROR, (e, data) => {
        if (data.fatal) {
          switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              log('网络错误，尝试恢复……', true);
              hls.startLoad();
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              log('媒体错误，尝试恢复……', true);
              hls.recoverMediaError();
              break;
            default:
              log('致命错误，停止播放', true);
              hls.destroy();
              break;
          }
        }
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = src;
      log('浏览器原生支持，直接播放');
      video.addEventListener('loadedmetadata', () => video.play(), { once: true });
    } else {
      log('浏览器不支持 HLS 播放', true);
    }
  }

  /* ---------- 绑定 ---------- */
  const initUrl = getParam('url') || urlInp.value;
  if (initUrl) { urlInp.value = initUrl; playM3U8(initUrl); }

  loadBtn.addEventListener('click', () => playM3U8(urlInp.value.trim()));
  urlInp.addEventListener('keydown', e => { if (e.key === 'Enter') playM3U8(urlInp.value.trim()); });

  window.addEventListener('beforeunload', () => {
    if (debugTimer) clearInterval(debugTimer);
    if (hlsInst) hlsInst.destroy();
  });
})();
</script>
</body>
</html>

